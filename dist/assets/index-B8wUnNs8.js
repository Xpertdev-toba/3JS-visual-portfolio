import{E as ws,V as w,M as ce,T as le,S as Lt,Q as Re,a as F,R as xs,P as bs,b as at,c as Gt,W as As,A as Es,d as ne,B as Ms,D as Qe,e as Ts,H as vs,F as _s,f as H,g as S,h as Ls,i as x,G as W,j as R,C as Ze,k as Z,l as U,m as Q,n as B,o as se,p as Ps,q as et,r as V,s as we,O as _e,t as Pt,L as Se,u as ke,v as oe,I as Ke,w as xe,x as Ie,y as De,z as Ss,J as tt,K as st,N as ks,U as Is,X as ct,Y as Cs,Z as Rs,_ as be,$ as Ut,a0 as Ds,a1 as nt,a2 as Zt,a3 as Kt,a4 as Ae,a5 as Fe,a6 as J,a7 as K,a8 as Fs,a9 as Os,aa as Oe,ab as zs,ac as Yt,ad as Ns,ae as Bs,af as Xt,ag as js,ah as Hs,ai as Gs,aj as Us,ak as it,al as Zs,am as Ks,an as Ye,ao as Ys,ap as Xs,aq as Vs,ar as qs,as as Ws,at as Js,au as $s,av as Qs,aw as en,ax as Vt,ay as tn,az as St,aA as kt,aB as It,aC as Ct,aD as Rt,aE as sn,aF as nn,aG as on,aH as rn}from"./three-BrkffKlN.js";import{W as an,S as cn,M as ln,C as hn,P as dn,B as C,H as un,a as he,V as q,b as Ce,c as Xe}from"./physics-BLW-AYWc.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))e(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&e(o)}).observe(document,{childList:!0,subtree:!0});function s(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function e(n){if(n.ep)return;n.ep=!0;const i=s(n);fetch(n.href,i)}})();class lt{constructor(){this.callbacks={},this.callbacks.base={}}on(t,s){const e=t.split("."),n=e[0],i=e.length>1?e[1]:"base";return this.callbacks[i]||(this.callbacks[i]={}),this.callbacks[i][n]||(this.callbacks[i][n]=[]),this.callbacks[i][n].push(s),this}off(t){var i;const s=t.split("."),e=s[0],n=s.length>1?s[1]:"";if(e&&n)(i=this.callbacks[n])!=null&&i[e]&&delete this.callbacks[n][e];else if(e)for(const o in this.callbacks)this.callbacks[o][e]&&delete this.callbacks[o][e];else n&&delete this.callbacks[n];return this}trigger(t,s=[]){const e=t.split("."),n=e[0],i=e.length>1?e[1]:"",o=r=>{this.callbacks[r]&&this.callbacks[r][n]&&this.callbacks[r][n].forEach(a=>{a.apply(this,s)})};if(i==="")for(const r in this.callbacks)o(r);else o(i);return this}}class pn extends lt{constructor(){super(),this.width=window.innerWidth,this.height=window.innerHeight,this.pixelRatio=Math.min(window.devicePixelRatio,2),this._onResize=()=>{this.width=window.innerWidth,this.height=window.innerHeight,this.pixelRatio=Math.min(window.devicePixelRatio,2),this.trigger("resize")},window.addEventListener("resize",this._onResize)}destroy(){window.removeEventListener("resize",this._onResize)}}class mn extends lt{constructor(){super(),this.start=Date.now(),this.current=this.start,this.elapsed=0,this.delta=16,this.rafId=null,this.rafId=window.requestAnimationFrame(()=>{this.tick()})}tick(){const t=Date.now();this.delta=t-this.current,this.current=t,this.elapsed=this.current-this.start,this.trigger("tick"),this.rafId=window.requestAnimationFrame(()=>{this.tick()})}destroy(){this.rafId&&(window.cancelAnimationFrame(this.rafId),this.rafId=null)}}class fn{constructor(){this.experience=new j,this.time=this.experience.time,this.zoneBodies=[],this.setWorld(),this.setGround()}setWorld(){this.world=new an,this.world.gravity.set(0,-15,0),this.world.broadphase=new cn(this.world),this.world.allowSleep=!0,this.world.solver.iterations=5,this.defaultMaterial=new ln("default"),this.defaultContactMaterial=new hn(this.defaultMaterial,this.defaultMaterial,{friction:.5,restitution:.1}),this.world.addContactMaterial(this.defaultContactMaterial),this.world.defaultContactMaterial=this.defaultContactMaterial}setGround(){const t=new dn;this.groundBody=new C({mass:0,shape:t,material:this.defaultMaterial}),this.groundBody.quaternion.setFromEuler(-Math.PI/2,0,0),this.groundBody.position.set(0,0,0),this.world.addBody(this.groundBody)}setHeightfield(t,s,e){this.groundBody&&(this.world.removeBody(this.groundBody),this.groundBody=null);const n=e+1,i=e+1,o=s/e,r=[];for(let c=0;c<n;c++){const l=[];for(let h=0;h<i;h++){const m=(i-1-h)*n+c;l.push(t[m]||0)}r.push(l)}const a=new un(r,{elementSize:o});this.heightfieldBody=new C({mass:0,shape:a,material:this.defaultMaterial}),this.heightfieldBody.quaternion.setFromEuler(-Math.PI/2,0,0),this.heightfieldBody.position.set(-s/2,0,s/2),this.world.addBody(this.heightfieldBody),console.log(`‚õ∞Ô∏è Heightfield collider: ${n}x${i}, elementSize=${o.toFixed(2)}`)}addZoneColliders(t){if(this.removeZoneColliders(),!this.heightfieldBody)for(const[s,e]of Object.entries(t)){if(Math.abs(e.elevation)<.01)continue;const n=e.radius,i=.5,o=new he(new q(n,i,n)),r=new C({mass:0,shape:o,material:this.defaultMaterial});r.position.set(e.center.x,e.elevation-i,e.center.z),this.world.addBody(r),this.zoneBodies.push(r)}}removeZoneColliders(){for(const t of this.zoneBodies)this.world.removeBody(t);this.zoneBodies=[]}update(){this.world.step(1/60,Math.min(this.time.delta/1e3,.1),3)}}const Dt={type:"change"},Ve={type:"start"},Ft={type:"end"},Le=new xs,Ot=new bs,gn=Math.cos(70*at.DEG2RAD);class yn extends ws{constructor(t,s){super(),this.object=t,this.domElement=s,this.domElement.style.touchAction="none",this.enabled=!0,this.target=new w,this.cursor=new w,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minTargetRadius=0,this.maxTargetRadius=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.05,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!0,this.keyPanSpeed=7,this.zoomToCursor=!1,this.autoRotate=!1,this.autoRotateSpeed=2,this.keys={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"},this.mouseButtons={LEFT:ce.ROTATE,MIDDLE:ce.DOLLY,RIGHT:ce.PAN},this.touches={ONE:le.ROTATE,TWO:le.DOLLY_PAN},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this._domElementKeyEvents=null,this.getPolarAngle=function(){return r.phi},this.getAzimuthalAngle=function(){return r.theta},this.getDistance=function(){return this.object.position.distanceTo(this.target)},this.listenToKeyEvents=function(d){d.addEventListener("keydown",Ge),this._domElementKeyEvents=d},this.stopListenToKeyEvents=function(){this._domElementKeyEvents.removeEventListener("keydown",Ge),this._domElementKeyEvents=null},this.saveState=function(){e.target0.copy(e.target),e.position0.copy(e.object.position),e.zoom0=e.object.zoom},this.reset=function(){e.target.copy(e.target0),e.object.position.copy(e.position0),e.object.zoom=e.zoom0,e.object.updateProjectionMatrix(),e.dispatchEvent(Dt),e.update(),i=n.NONE},this.update=function(){const d=new w,A=new Re().setFromUnitVectors(t.up,new w(0,1,0)),v=A.clone().invert(),P=new w,I=new Re,$=new w,z=2*Math.PI;return function(ys=null){const _t=e.object.position;d.copy(_t).sub(e.target),d.applyQuaternion(A),r.setFromVector3(d),e.autoRotate&&i===n.NONE&&pe(ue(ys)),e.enableDamping?(r.theta+=a.theta*e.dampingFactor,r.phi+=a.phi*e.dampingFactor):(r.theta+=a.theta,r.phi+=a.phi);let Y=e.minAzimuthAngle,X=e.maxAzimuthAngle;isFinite(Y)&&isFinite(X)&&(Y<-Math.PI?Y+=z:Y>Math.PI&&(Y-=z),X<-Math.PI?X+=z:X>Math.PI&&(X-=z),Y<=X?r.theta=Math.max(Y,Math.min(X,r.theta)):r.theta=r.theta>(Y+X)/2?Math.max(Y,r.theta):Math.min(X,r.theta)),r.phi=Math.max(e.minPolarAngle,Math.min(e.maxPolarAngle,r.phi)),r.makeSafe(),e.enableDamping===!0?e.target.addScaledVector(l,e.dampingFactor):e.target.add(l),e.target.sub(e.cursor),e.target.clampLength(e.minTargetRadius,e.maxTargetRadius),e.target.add(e.cursor),e.zoomToCursor&&D||e.object.isOrthographicCamera?r.radius=je(r.radius):r.radius=je(r.radius*c),d.setFromSpherical(r),d.applyQuaternion(v),_t.copy(e.target).add(d),e.object.lookAt(e.target),e.enableDamping===!0?(a.theta*=1-e.dampingFactor,a.phi*=1-e.dampingFactor,l.multiplyScalar(1-e.dampingFactor)):(a.set(0,0,0),l.set(0,0,0));let Ue=!1;if(e.zoomToCursor&&D){let fe=null;if(e.object.isPerspectiveCamera){const ge=d.length();fe=je(ge*c);const ve=ge-fe;e.object.position.addScaledVector(T,ve),e.object.updateMatrixWorld()}else if(e.object.isOrthographicCamera){const ge=new w(k.x,k.y,0);ge.unproject(e.object),e.object.zoom=Math.max(e.minZoom,Math.min(e.maxZoom,e.object.zoom/c)),e.object.updateProjectionMatrix(),Ue=!0;const ve=new w(k.x,k.y,0);ve.unproject(e.object),e.object.position.sub(ve).add(ge),e.object.updateMatrixWorld(),fe=d.length()}else console.warn("WARNING: OrbitControls.js encountered an unknown camera type - zoom to cursor disabled."),e.zoomToCursor=!1;fe!==null&&(this.screenSpacePanning?e.target.set(0,0,-1).transformDirection(e.object.matrix).multiplyScalar(fe).add(e.object.position):(Le.origin.copy(e.object.position),Le.direction.set(0,0,-1).transformDirection(e.object.matrix),Math.abs(e.object.up.dot(Le.direction))<gn?t.lookAt(e.target):(Ot.setFromNormalAndCoplanarPoint(e.object.up,e.target),Le.intersectPlane(Ot,e.target))))}else e.object.isOrthographicCamera&&(e.object.zoom=Math.max(e.minZoom,Math.min(e.maxZoom,e.object.zoom/c)),e.object.updateProjectionMatrix(),Ue=!0);return c=1,D=!1,Ue||P.distanceToSquared(e.object.position)>o||8*(1-I.dot(e.object.quaternion))>o||$.distanceToSquared(e.target)>0?(e.dispatchEvent(Dt),P.copy(e.object.position),I.copy(e.object.quaternion),$.copy(e.target),!0):!1}}(),this.dispose=function(){e.domElement.removeEventListener("contextmenu",Tt),e.domElement.removeEventListener("pointerdown",At),e.domElement.removeEventListener("pointercancel",me),e.domElement.removeEventListener("wheel",Et),e.domElement.removeEventListener("pointermove",He),e.domElement.removeEventListener("pointerup",me),e._domElementKeyEvents!==null&&(e._domElementKeyEvents.removeEventListener("keydown",Ge),e._domElementKeyEvents=null)};const e=this,n={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6};let i=n.NONE;const o=1e-6,r=new Lt,a=new Lt;let c=1;const l=new w,h=new F,u=new F,m=new F,f=new F,g=new F,y=new F,b=new F,E=new F,_=new F,T=new w,k=new F;let D=!1;const L=[],G={};let O=!1;function ue(d){return d!==null?2*Math.PI/60*e.autoRotateSpeed*d:2*Math.PI/60/60*e.autoRotateSpeed}function Me(d){const A=Math.abs(d*.01);return Math.pow(.95,e.zoomSpeed*A)}function pe(d){a.theta-=d}function Te(d){a.phi-=d}const ht=function(){const d=new w;return function(v,P){d.setFromMatrixColumn(P,0),d.multiplyScalar(-v),l.add(d)}}(),dt=function(){const d=new w;return function(v,P){e.screenSpacePanning===!0?d.setFromMatrixColumn(P,1):(d.setFromMatrixColumn(P,0),d.crossVectors(e.object.up,d)),d.multiplyScalar(v),l.add(d)}}(),re=function(){const d=new w;return function(v,P){const I=e.domElement;if(e.object.isPerspectiveCamera){const $=e.object.position;d.copy($).sub(e.target);let z=d.length();z*=Math.tan(e.object.fov/2*Math.PI/180),ht(2*v*z/I.clientHeight,e.object.matrix),dt(2*P*z/I.clientHeight,e.object.matrix)}else e.object.isOrthographicCamera?(ht(v*(e.object.right-e.object.left)/e.object.zoom/I.clientWidth,e.object.matrix),dt(P*(e.object.top-e.object.bottom)/e.object.zoom/I.clientHeight,e.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),e.enablePan=!1)}}();function Ne(d){e.object.isPerspectiveCamera||e.object.isOrthographicCamera?c/=d:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),e.enableZoom=!1)}function ut(d){e.object.isPerspectiveCamera||e.object.isOrthographicCamera?c*=d:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),e.enableZoom=!1)}function Be(d,A){if(!e.zoomToCursor)return;D=!0;const v=e.domElement.getBoundingClientRect(),P=d-v.left,I=A-v.top,$=v.width,z=v.height;k.x=P/$*2-1,k.y=-(I/z)*2+1,T.set(k.x,k.y,1).unproject(e.object).sub(e.object.position).normalize()}function je(d){return Math.max(e.minDistance,Math.min(e.maxDistance,d))}function pt(d){h.set(d.clientX,d.clientY)}function Qt(d){Be(d.clientX,d.clientX),b.set(d.clientX,d.clientY)}function mt(d){f.set(d.clientX,d.clientY)}function es(d){u.set(d.clientX,d.clientY),m.subVectors(u,h).multiplyScalar(e.rotateSpeed);const A=e.domElement;pe(2*Math.PI*m.x/A.clientHeight),Te(2*Math.PI*m.y/A.clientHeight),h.copy(u),e.update()}function ts(d){E.set(d.clientX,d.clientY),_.subVectors(E,b),_.y>0?Ne(Me(_.y)):_.y<0&&ut(Me(_.y)),b.copy(E),e.update()}function ss(d){g.set(d.clientX,d.clientY),y.subVectors(g,f).multiplyScalar(e.panSpeed),re(y.x,y.y),f.copy(g),e.update()}function ns(d){Be(d.clientX,d.clientY),d.deltaY<0?ut(Me(d.deltaY)):d.deltaY>0&&Ne(Me(d.deltaY)),e.update()}function is(d){let A=!1;switch(d.code){case e.keys.UP:d.ctrlKey||d.metaKey||d.shiftKey?Te(2*Math.PI*e.rotateSpeed/e.domElement.clientHeight):re(0,e.keyPanSpeed),A=!0;break;case e.keys.BOTTOM:d.ctrlKey||d.metaKey||d.shiftKey?Te(-2*Math.PI*e.rotateSpeed/e.domElement.clientHeight):re(0,-e.keyPanSpeed),A=!0;break;case e.keys.LEFT:d.ctrlKey||d.metaKey||d.shiftKey?pe(2*Math.PI*e.rotateSpeed/e.domElement.clientHeight):re(e.keyPanSpeed,0),A=!0;break;case e.keys.RIGHT:d.ctrlKey||d.metaKey||d.shiftKey?pe(-2*Math.PI*e.rotateSpeed/e.domElement.clientHeight):re(-e.keyPanSpeed,0),A=!0;break}A&&(d.preventDefault(),e.update())}function ft(d){if(L.length===1)h.set(d.pageX,d.pageY);else{const A=ae(d),v=.5*(d.pageX+A.x),P=.5*(d.pageY+A.y);h.set(v,P)}}function gt(d){if(L.length===1)f.set(d.pageX,d.pageY);else{const A=ae(d),v=.5*(d.pageX+A.x),P=.5*(d.pageY+A.y);f.set(v,P)}}function yt(d){const A=ae(d),v=d.pageX-A.x,P=d.pageY-A.y,I=Math.sqrt(v*v+P*P);b.set(0,I)}function os(d){e.enableZoom&&yt(d),e.enablePan&&gt(d)}function rs(d){e.enableZoom&&yt(d),e.enableRotate&&ft(d)}function wt(d){if(L.length==1)u.set(d.pageX,d.pageY);else{const v=ae(d),P=.5*(d.pageX+v.x),I=.5*(d.pageY+v.y);u.set(P,I)}m.subVectors(u,h).multiplyScalar(e.rotateSpeed);const A=e.domElement;pe(2*Math.PI*m.x/A.clientHeight),Te(2*Math.PI*m.y/A.clientHeight),h.copy(u)}function xt(d){if(L.length===1)g.set(d.pageX,d.pageY);else{const A=ae(d),v=.5*(d.pageX+A.x),P=.5*(d.pageY+A.y);g.set(v,P)}y.subVectors(g,f).multiplyScalar(e.panSpeed),re(y.x,y.y),f.copy(g)}function bt(d){const A=ae(d),v=d.pageX-A.x,P=d.pageY-A.y,I=Math.sqrt(v*v+P*P);E.set(0,I),_.set(0,Math.pow(E.y/b.y,e.zoomSpeed)),Ne(_.y),b.copy(E);const $=(d.pageX+A.x)*.5,z=(d.pageY+A.y)*.5;Be($,z)}function as(d){e.enableZoom&&bt(d),e.enablePan&&xt(d)}function cs(d){e.enableZoom&&bt(d),e.enableRotate&&wt(d)}function At(d){e.enabled!==!1&&(L.length===0&&(e.domElement.setPointerCapture(d.pointerId),e.domElement.addEventListener("pointermove",He),e.domElement.addEventListener("pointerup",me)),fs(d),d.pointerType==="touch"?ps(d):ls(d))}function He(d){e.enabled!==!1&&(d.pointerType==="touch"?ms(d):hs(d))}function me(d){gs(d),L.length===0&&(e.domElement.releasePointerCapture(d.pointerId),e.domElement.removeEventListener("pointermove",He),e.domElement.removeEventListener("pointerup",me)),e.dispatchEvent(Ft),i=n.NONE}function ls(d){let A;switch(d.button){case 0:A=e.mouseButtons.LEFT;break;case 1:A=e.mouseButtons.MIDDLE;break;case 2:A=e.mouseButtons.RIGHT;break;default:A=-1}switch(A){case ce.DOLLY:if(e.enableZoom===!1)return;Qt(d),i=n.DOLLY;break;case ce.ROTATE:if(d.ctrlKey||d.metaKey||d.shiftKey){if(e.enablePan===!1)return;mt(d),i=n.PAN}else{if(e.enableRotate===!1)return;pt(d),i=n.ROTATE}break;case ce.PAN:if(d.ctrlKey||d.metaKey||d.shiftKey){if(e.enableRotate===!1)return;pt(d),i=n.ROTATE}else{if(e.enablePan===!1)return;mt(d),i=n.PAN}break;default:i=n.NONE}i!==n.NONE&&e.dispatchEvent(Ve)}function hs(d){switch(i){case n.ROTATE:if(e.enableRotate===!1)return;es(d);break;case n.DOLLY:if(e.enableZoom===!1)return;ts(d);break;case n.PAN:if(e.enablePan===!1)return;ss(d);break}}function Et(d){e.enabled===!1||e.enableZoom===!1||i!==n.NONE||(d.preventDefault(),e.dispatchEvent(Ve),ns(ds(d)),e.dispatchEvent(Ft))}function ds(d){const A=d.deltaMode,v={clientX:d.clientX,clientY:d.clientY,deltaY:d.deltaY};switch(A){case 1:v.deltaY*=16;break;case 2:v.deltaY*=100;break}return d.ctrlKey&&!O&&(v.deltaY*=10),v}function us(d){d.key==="Control"&&(O=!0,document.addEventListener("keyup",Mt,{passive:!0,capture:!0}))}function Mt(d){d.key==="Control"&&(O=!1,document.removeEventListener("keyup",Mt,{passive:!0,capture:!0}))}function Ge(d){e.enabled===!1||e.enablePan===!1||is(d)}function ps(d){switch(vt(d),L.length){case 1:switch(e.touches.ONE){case le.ROTATE:if(e.enableRotate===!1)return;ft(d),i=n.TOUCH_ROTATE;break;case le.PAN:if(e.enablePan===!1)return;gt(d),i=n.TOUCH_PAN;break;default:i=n.NONE}break;case 2:switch(e.touches.TWO){case le.DOLLY_PAN:if(e.enableZoom===!1&&e.enablePan===!1)return;os(d),i=n.TOUCH_DOLLY_PAN;break;case le.DOLLY_ROTATE:if(e.enableZoom===!1&&e.enableRotate===!1)return;rs(d),i=n.TOUCH_DOLLY_ROTATE;break;default:i=n.NONE}break;default:i=n.NONE}i!==n.NONE&&e.dispatchEvent(Ve)}function ms(d){switch(vt(d),i){case n.TOUCH_ROTATE:if(e.enableRotate===!1)return;wt(d),e.update();break;case n.TOUCH_PAN:if(e.enablePan===!1)return;xt(d),e.update();break;case n.TOUCH_DOLLY_PAN:if(e.enableZoom===!1&&e.enablePan===!1)return;as(d),e.update();break;case n.TOUCH_DOLLY_ROTATE:if(e.enableZoom===!1&&e.enableRotate===!1)return;cs(d),e.update();break;default:i=n.NONE}}function Tt(d){e.enabled!==!1&&d.preventDefault()}function fs(d){L.push(d.pointerId)}function gs(d){delete G[d.pointerId];for(let A=0;A<L.length;A++)if(L[A]==d.pointerId){L.splice(A,1);return}}function vt(d){let A=G[d.pointerId];A===void 0&&(A=new F,G[d.pointerId]=A),A.set(d.pageX,d.pageY)}function ae(d){const A=d.pointerId===L[0]?L[1]:L[0];return G[A]}e.domElement.addEventListener("contextmenu",Tt),e.domElement.addEventListener("pointerdown",At),e.domElement.addEventListener("pointercancel",me),e.domElement.addEventListener("wheel",Et,{passive:!1}),document.addEventListener("keydown",us,{passive:!0,capture:!0}),this.update()}}class wn{constructor(t,s,e={}){this.experience=new j,this.scene=this.experience.scene,this.sizes=this.experience.sizes,this.canvas=s,this.camera=t,this.settings={distance:e.distance??8,height:e.height??4,smoothness:e.smoothing??.08,rotationSmoothness:e.rotationSmoothness??.1,minDistance:e.minDistance??3,maxDistance:e.maxDistance??200,minPitch:e.minPolarAngle??-.3,maxPitch:e.maxPolarAngle??1.4},this.currentPosition=new w,this.targetPosition=new w,this.lookAtPosition=new w,this.currentLookAt=new w,this.theta=0,this.phi=.5,this.targetDistance=this.settings.distance,this.overviewMode=!1,this.savedDistance=this.settings.distance,this.savedPhi=.5,this.overviewDistance=600,this.overviewPhi=1.3,this.isPointerDown=!1,this.previousPointer={x:0,y:0},this.initialized=!1,this.camera.position.set(0,10,15),this.setControls()}setControls(){this._onPointerDown=t=>this.onPointerDown(t),this._onPointerMove=t=>this.onPointerMove(t),this._onPointerUp=()=>this.onPointerUp(),this._onWheel=t=>this.onWheel(t),this._onTouchStart=t=>this.onTouchStart(t),this._onTouchMove=t=>this.onTouchMove(t),this._onTouchEnd=()=>this.onTouchEnd(),this._onKeyDown=t=>{t.code==="KeyF"&&this.toggleOverview()},this.canvas.addEventListener("pointerdown",this._onPointerDown),window.addEventListener("pointermove",this._onPointerMove),window.addEventListener("pointerup",this._onPointerUp),this.canvas.addEventListener("wheel",this._onWheel,{passive:!0}),this.touches=[],this.canvas.addEventListener("touchstart",this._onTouchStart,{passive:!0}),this.canvas.addEventListener("touchmove",this._onTouchMove,{passive:!0}),this.canvas.addEventListener("touchend",this._onTouchEnd),document.addEventListener("keydown",this._onKeyDown)}toggleOverview(){this.overviewMode=!this.overviewMode,this.overviewMode?(this.savedDistance=this.targetDistance,this.savedPhi=this.phi,this.targetDistance=this.overviewDistance,this.phi=this.overviewPhi,console.log("üî≠ Overview mode ON")):(this.targetDistance=this.savedDistance,this.phi=this.savedPhi,console.log("üî≠ Overview mode OFF"))}onPointerDown(t){this.isPointerDown=!0,this.previousPointer.x=t.clientX,this.previousPointer.y=t.clientY}onPointerMove(t){if(!this.isPointerDown)return;const s=t.clientX-this.previousPointer.x,e=t.clientY-this.previousPointer.y;this.theta-=s*.005,this.phi+=e*.005,this.phi=Math.max(this.settings.minPitch,Math.min(this.settings.maxPitch,this.phi)),this.previousPointer.x=t.clientX,this.previousPointer.y=t.clientY}onPointerUp(){this.isPointerDown=!1}onWheel(t){const s=Math.max(.01,this.targetDistance*.05);this.targetDistance+=t.deltaY>0?s:-s,this.targetDistance=Math.max(this.settings.minDistance,Math.min(this.settings.maxDistance,this.targetDistance)),this.overviewMode&&this.targetDistance<this.overviewDistance*.5&&(this.overviewMode=!1)}onTouchStart(t){this.touches=[...t.touches]}onTouchMove(t){if(t.touches.length===2&&this.touches.length===2){const s=Math.hypot(this.touches[0].clientX-this.touches[1].clientX,this.touches[0].clientY-this.touches[1].clientY),e=Math.hypot(t.touches[0].clientX-t.touches[1].clientX,t.touches[0].clientY-t.touches[1].clientY);this.targetDistance-=(e-s)*.05,this.targetDistance=Math.max(this.settings.minDistance,Math.min(this.settings.maxDistance,this.targetDistance))}this.touches=[...t.touches]}onTouchEnd(){this.touches=[]}follow(t,s){if(!t)return;const e=t.position.clone(),n=this.experience.touchControls;if(n!=null&&n.isEnabled&&n.cameraJoystick.active){const l=n.getInput();this.theta-=l.cameraX,this.phi+=l.cameraY,this.phi=Math.max(this.settings.minPitch,Math.min(this.settings.maxPitch,this.phi))}const i=at.lerp(this.settings.distance,this.targetDistance,this.settings.smoothness*2);this.settings.distance=i;const o=Math.sin(this.theta)*Math.cos(this.phi)*i,r=Math.sin(this.phi)*i+this.settings.height,a=Math.cos(this.theta)*Math.cos(this.phi)*i;this.targetPosition.set(e.x+o,e.y+r,e.z+a),this.initialized||(this.currentPosition.copy(this.targetPosition),this.currentLookAt.copy(e),this.currentLookAt.y+=1,this.initialized=!0);const c=this.overviewMode?this.settings.smoothness*3:this.settings.smoothness;this.currentPosition.lerp(this.targetPosition,c),this.camera.position.copy(this.currentPosition),this.lookAtPosition.copy(e),this.lookAtPosition.y+=1,this.currentLookAt.lerp(this.lookAtPosition,this.settings.rotationSmoothness),this.camera.lookAt(this.currentLookAt)}resize(){this.camera.aspect=this.sizes.width/this.sizes.height,this.camera.updateProjectionMatrix()}update(){}getForwardDirection(){const t=new w(0,0,-1);return t.applyQuaternion(this.camera.quaternion),t.y=0,t.normalize(),t}getRightDirection(){const t=new w(1,0,0);return t.applyQuaternion(this.camera.quaternion),t.y=0,t.normalize(),t}destroy(){this.canvas.removeEventListener("pointerdown",this._onPointerDown),window.removeEventListener("pointermove",this._onPointerMove),window.removeEventListener("pointerup",this._onPointerUp),this.canvas.removeEventListener("wheel",this._onWheel),this.canvas.removeEventListener("touchstart",this._onTouchStart),this.canvas.removeEventListener("touchmove",this._onTouchMove),this.canvas.removeEventListener("touchend",this._onTouchEnd),document.removeEventListener("keydown",this._onKeyDown)}}class xn{constructor(){this.experience=new j,this.sizes=this.experience.sizes,this.scene=this.experience.scene,this.canvas=this.experience.canvas,this.setInstance(),this.setThirdPerson()}setInstance(){this.instance=new Gt(45,this.sizes.width/this.sizes.height,.1,5e3),this.instance.position.set(0,30,60),this.instance.lookAt(0,0,0),this.scene.add(this.instance)}setThirdPerson(){this.thirdPerson=new wn(this.instance,this.canvas,{distance:30,height:15,smoothing:.08,minPolarAngle:-.3,maxPolarAngle:1.4,minDistance:8,maxDistance:800})}setControls(){this.controls=new yn(this.instance,this.canvas),this.controls.enableDamping=!0,this.controls.dampingFactor=.05,this.controls.minDistance=5,this.controls.maxDistance=60,this.controls.maxPolarAngle=Math.PI/2-.05,this.controls.target.set(0,0,0)}resize(){var t;this.instance.aspect=this.sizes.width/this.sizes.height,this.instance.updateProjectionMatrix(),(t=this.thirdPerson)==null||t.resize()}update(){}destroy(){var t,s;(t=this.thirdPerson)==null||t.destroy(),(s=this.controls)==null||s.dispose()}}class bn{constructor(){this.experience=new j,this.canvas=this.experience.canvas,this.sizes=this.experience.sizes,this.scene=this.experience.scene,this.camera=this.experience.camera,this.setInstance()}setInstance(){this.instance=new As({canvas:this.canvas,antialias:!1,alpha:!1,powerPreference:"high-performance"}),this.instance.setSize(this.sizes.width,this.sizes.height),this.instance.setPixelRatio(1),this.instance.toneMapping=Es,this.instance.toneMappingExposure=1.1,this.instance.outputColorSpace=ne,this.instance.shadowMap.enabled=!0,this.instance.shadowMap.type=Ms,this.instance.setClearColor("#87ceeb")}resize(){this.instance.setSize(this.sizes.width,this.sizes.height),this.instance.setPixelRatio(1)}update(){this.instance.render(this.scene,this.camera.instance)}}class An{constructor(){this.experience=new j,this.scene=this.experience.scene,this.presets={dawn:{sunColor:16753510,sunIntensity:1,sunPos:[50,30,80],fillColor:6719692,fillIntensity:.2,ambientColor:3351108,ambientIntensity:.4,hemiSky:16746581,hemiGround:2241348,hemiIntensity:.5,skyColor:16742212,fogColor:6702131,fogNear:200,fogFar:800},morning:{sunColor:16773324,sunIntensity:1.4,sunPos:[100,100,80],fillColor:8961006,fillIntensity:.25,ambientColor:5596757,ambientIntensity:.5,hemiSky:8965358,hemiGround:4482628,hemiIntensity:.6,skyColor:8965358,fogColor:6715238,fogNear:300,fogFar:1e3},noon:{sunColor:16774625,sunIntensity:1.8,sunPos:[120,180,80],fillColor:8965375,fillIntensity:.3,ambientColor:4876890,ambientIntensity:.5,hemiSky:8900331,hemiGround:2968125,hemiIntensity:.6,skyColor:8900331,fogColor:5929578,fogNear:300,fogFar:1200},afternoon:{sunColor:16771248,sunIntensity:1.5,sunPos:[150,120,-50],fillColor:7838139,fillIntensity:.25,ambientColor:5596740,ambientIntensity:.45,hemiSky:10075101,hemiGround:4478259,hemiIntensity:.55,skyColor:10075101,fogColor:6715221,fogNear:250,fogFar:1e3},dusk:{sunColor:16737843,sunIntensity:.9,sunPos:[-80,30,-100],fillColor:4469606,fillIntensity:.15,ambientColor:3351091,ambientIntensity:.35,hemiSky:13391155,hemiGround:2232610,hemiIntensity:.4,skyColor:13386786,fogColor:4465203,fogNear:150,fogFar:700},night:{sunColor:4482730,sunIntensity:.3,sunPos:[-50,80,-50],fillColor:2241365,fillIntensity:.1,ambientColor:1118498,ambientIntensity:.25,hemiSky:1122884,hemiGround:657941,hemiIntensity:.3,skyColor:657952,fogColor:657941,fogNear:100,fogFar:500}},this.currentPreset="noon",this.setupLights(),this.setupSkybox(),this.applyPreset("noon",!1)}setupLights(){this.sunLight=new Qe(16777215,1.8),this.sunLight.castShadow=!0,this.sunLight.shadow.camera.far=200,this.sunLight.shadow.camera.left=-100,this.sunLight.shadow.camera.top=100,this.sunLight.shadow.camera.right=100,this.sunLight.shadow.camera.bottom=-100,this.sunLight.shadow.mapSize.set(1024,1024),this.sunLight.shadow.normalBias=.02,this.scene.add(this.sunLight),this.fillLight=new Qe(8965375,.3),this.scene.add(this.fillLight),this.ambientLight=new Ts(4876890,.5),this.scene.add(this.ambientLight),this.hemisphereLight=new vs(8900331,2968125,.6),this.scene.add(this.hemisphereLight),this.scene.fog=new _s(5929578,300,1200)}setupSkybox(){const t=new H(2e3,12,12);this.skyMaterial=new S({color:8900331,side:Ls}),this.sky=new x(t,this.skyMaterial),this.scene.add(this.sky)}setPreset(t){this.presets[t]&&this.applyPreset(t,!1)}applyPreset(t,s){const e=this.presets[t];e&&(this.currentPreset=t,this.sunLight.color.setHex(e.sunColor),this.sunLight.intensity=e.sunIntensity,this.sunLight.position.set(e.sunPos[0],e.sunPos[1],e.sunPos[2]),this.fillLight.color.setHex(e.fillColor),this.fillLight.intensity=e.fillIntensity,this.fillLight.position.set(-e.sunPos[0],e.sunPos[1]*.5,-e.sunPos[2]),this.ambientLight.color.setHex(e.ambientColor),this.ambientLight.intensity=e.ambientIntensity,this.hemisphereLight.color.setHex(e.hemiSky),this.hemisphereLight.groundColor.setHex(e.hemiGround),this.hemisphereLight.intensity=e.hemiIntensity,this.skyMaterial.color.setHex(e.skyColor),this.scene.fog.color.setHex(e.fogColor),this.scene.fog.near=e.fogNear,this.scene.fog.far=e.fogFar,console.log(`üå§Ô∏è Time of day: ${t}`))}}class En{constructor(){this.experience=new j,this.scene=this.experience.scene,this.physics=this.experience.physics,this.jumpForce=8,this.canJump=!1,this.isMoving=!1,this.keys={forward:!1,backward:!1,left:!1,right:!1,jump:!1},this.setMesh(),this.setPhysics(),this.setControls(),this._forward=new w,this._right=new w,this._moveDir=new w,this._up=new w(0,1,0)}setMesh(){this.mesh=new W,this.mesh.name="Player";const t=new R({color:5227511,metalness:.5,roughness:.3,flatShading:!0}),s=new R({color:3622735,metalness:.4,roughness:.5,flatShading:!0}),e=new S({color:58879}),n=new x(new Ze(.3,.5,3,6),t);n.position.y=.55,n.castShadow=!0,this.mesh.add(n);const i=new x(new H(.25,6,6),t);i.position.y=1.1,i.castShadow=!0,this.mesh.add(i);const o=new H(.05,4,4),r=new x(o,e);r.position.set(-.08,1.15,.2),this.mesh.add(r);const a=new x(o,e);a.position.set(.08,1.15,.2),this.mesh.add(a);const c=new x(new Z(.02,.02,.2,3),s);c.position.set(0,1.45,0),this.mesh.add(c);const l=new x(new H(.04,4,4),e);l.position.set(0,1.58,0),this.mesh.add(l);const h=new Ze(.06,.25,2,4);this.leftArm=new x(h,t),this.leftArm.position.set(-.4,.55,0),this.leftArm.rotation.z=.2,this.mesh.add(this.leftArm),this.rightArm=new x(h,t),this.rightArm.position.set(.4,.55,0),this.rightArm.rotation.z=-.2,this.mesh.add(this.rightArm);const u=new Ze(.08,.15,2,4);this.leftLeg=new x(u,s),this.leftLeg.position.set(-.12,.12,0),this.mesh.add(this.leftLeg),this.rightLeg=new x(u,s),this.rightLeg.position.set(.12,.12,0),this.mesh.add(this.rightLeg),this.mesh.position.set(0,6,50),this.scene.add(this.mesh)}setPhysics(){const t=new Ce(.4);this.body=new C({mass:5,shape:t,position:new q(0,6,50),linearDamping:.3,angularDamping:.99,fixedRotation:!0,material:this.physics.defaultMaterial}),this.body.allowSleep=!1,this.body.sleepState=0,this.body.addEventListener("collide",s=>{const e=s.contact,n=new q;e.bi.id===this.body.id?e.ni.negate(n):n.copy(e.ni),n.y>.3&&(this.canJump=!0)}),this.physics.world.addBody(this.body),console.log("ü§ñ Player physics body added, id:",this.body.id,"sleepState:",this.body.sleepState)}setControls(){this._onKeyDown=t=>{(t.code==="KeyW"||t.code==="ArrowUp")&&(this.keys.forward=!0),(t.code==="KeyS"||t.code==="ArrowDown")&&(this.keys.backward=!0),(t.code==="KeyA"||t.code==="ArrowLeft")&&(this.keys.left=!0),(t.code==="KeyD"||t.code==="ArrowRight")&&(this.keys.right=!0),t.code==="Space"&&(this.keys.jump=!0,t.preventDefault())},this._onKeyUp=t=>{(t.code==="KeyW"||t.code==="ArrowUp")&&(this.keys.forward=!1),(t.code==="KeyS"||t.code==="ArrowDown")&&(this.keys.backward=!1),(t.code==="KeyA"||t.code==="ArrowLeft")&&(this.keys.left=!1),(t.code==="KeyD"||t.code==="ArrowRight")&&(this.keys.right=!1),t.code==="Space"&&(this.keys.jump=!1)},window.addEventListener("keydown",this._onKeyDown,!0),window.addEventListener("keyup",this._onKeyUp,!0),console.log("üéÆ Player controls registered")}teleport(t){this.body.position.set(t.x,t.y,t.z),this.body.velocity.set(0,0,0),this.mesh.position.set(t.x,t.y,t.z)}update(){var a;const t=(a=this.experience.camera)==null?void 0:a.instance;t&&t.updateMatrixWorld();const s=this._forward,e=this._right;t?(t.getWorldDirection(s),s.y=0,s.normalize(),e.crossVectors(s,this._up).normalize()):(s.set(0,0,-1),e.set(1,0,0));let n=0,i=0;this.keys.forward&&(i+=1),this.keys.backward&&(i-=1),this.keys.left&&(n-=1),this.keys.right&&(n+=1);const o=this.experience.touchControls;o!=null&&o.isEnabled&&o.moveJoystick.active&&(n+=o.getInput().moveX,i+=o.getInput().moveY),o!=null&&o.isEnabled&&o.jumpRequested&&(this.keys.jump=!0),this.isMoving=Math.abs(n)>0||Math.abs(i)>0,this.body.wakeUp();const r=15;if(this.isMoving){const c=this._moveDir;c.set(0,0,0),c.addScaledVector(s,i),c.addScaledVector(e,n),c.normalize();const l=this.body.velocity.y;this.body.velocity.set(c.x*r,l,c.z*r);const u=(Math.atan2(c.x,c.z)-this.mesh.rotation.y+Math.PI)%(Math.PI*2)-Math.PI;this.mesh.rotation.y+=u*.15}else this.body.velocity.set(this.body.velocity.x*.85,this.body.velocity.y,this.body.velocity.z*.85);if(this.keys.jump&&this.canJump&&(this.body.velocity.y=this.isMoving?this.jumpForce*.5:this.jumpForce,this.canJump=!1),this.mesh.position.copy(this.body.position),this.mesh.position.y-=.4,this.isMoving&&this.canJump){const c=performance.now()*.008,l=Math.sin(c*10)*.25;this.leftLeg.rotation.x=l,this.rightLeg.rotation.x=-l,this.leftArm.rotation.x=-l*.5,this.rightArm.rotation.x=l*.5}else this.leftLeg.rotation.x*=.85,this.rightLeg.rotation.x*=.85,this.leftArm.rotation.x*=.85,this.rightArm.rotation.x*=.85;this.body.position.y<-50&&this.teleport(new w(0,10,50))}dispose(){window.removeEventListener("keydown",this._onKeyDown,!0),window.removeEventListener("keyup",this._onKeyUp,!0),this.scene.remove(this.mesh),this.mesh.traverse(t=>{var s,e;t.isMesh&&((s=t.geometry)==null||s.dispose(),(e=t.material)==null||e.dispose())}),this.body&&this.physics.world.removeBody(this.body)}}class Mn{constructor(){this.experience=new j,this.scene=this.experience.scene,this.physics=this.experience.physics,this.group=new W,this.group.name="TestEnvironment",this.bodies=[],this.dynamicMeshes=[],this.animatedObjects=[],this.particles=[],this.portals=[],this.landmarks=[],this.zoneLabels=[],this.zones={HUB:{name:"The Nexus Clearing",center:new w(0,0,0),radius:24,color:16766720,elevation:0},Z1:{name:"CodeForge Ruins",center:new w(0,0,-180),radius:21,color:4886745,elevation:-1.5},Z2:{name:"Pixel Grove",center:new w(-180,0,0),radius:21,color:10181046,elevation:4.5},Z3:{name:"Neural Cavern",center:new w(180,0,0),radius:21,color:15277667,elevation:-3},Z4:{name:"Lumina Falls",center:new w(-150,0,180),radius:21,color:16750592,elevation:9},Z5:{name:"Beacon Spire",center:new w(150,0,180),radius:21,color:5025616,elevation:6},Z6:{name:"Origin Tree",center:new w(-100,0,300),radius:18,color:16758605,elevation:15},Z7:{name:"Echo Chamber",center:new w(100,0,300),radius:15,color:2541274,elevation:12}},this._matPool={},this._buildTerrain(),this._buildPaths(),this._buildZoneGrounds(),this._buildHubLandmark(),this._buildZ1Landmark(),this._buildZ2Landmark(),this._buildZ3Landmark(),this._buildZ4Landmark(),this._buildZ5Landmark(),this._buildZ6Landmark(),this._buildZ7Landmark(),this._buildPortals(),this._buildTrees(),this._buildRocks(),this._buildBoundaryWalls(),this._buildParticles(),this._buildSpawnMarker(),this._buildZoneLabels(),this.scene.add(this.group),this.physics.addZoneColliders(this.zones),this._terrainHeights&&this.physics.setHeightfield(this._terrainHeights,this._terrainSize,this._terrainSegs),console.log("üèóÔ∏è Production World loaded ‚Äî zones:",Object.keys(this.zones).length,"bodies:",this.bodies.length)}_mat(t,s,e={}){const n=`${t}_${s}`;return this._matPool[n]||(this._matPool[n]=new R({color:s,roughness:e.roughness??.7,metalness:e.metalness??0,flatShading:!0,...e})),this._matPool[n]}_bmat(t,s,e={}){const n=`b_${t}_${s}`;return this._matPool[n]||(this._matPool[n]=new S({color:s,...e})),this._matPool[n]}_addLight(t,s,e,n,i,o,r,a){const c=new x(new H(.3,6,6),new S({color:s,transparent:!0,opacity:Math.min(e*.3,.8)}));return c.position.set(o,r,a),t.add(c),c}_staticBox(t,s,e,n={}){const i=new U(s[0],s[1],s[2]),o=new x(i,this._mat("box",e,n));o.position.set(t[0],t[1],t[2]),n.rotY&&(o.rotation.y=n.rotY),n.rotX&&(o.rotation.x=n.rotX),o.castShadow=!1,o.receiveShadow=!0,this.group.add(o);const r=new he(new q(s[0]/2,s[1]/2,s[2]/2)),a=new C({mass:0,shape:r,material:this.physics.defaultMaterial});return a.position.set(t[0],t[1],t[2]),n.rotY&&a.quaternion.setFromEuler(0,n.rotY,0),n.rotX&&a.quaternion.setFromEuler(n.rotX,0,0),this.physics.world.addBody(a),this.bodies.push(a),o}_staticCyl(t,s,e,n,i,o={}){const r=o.segments??8,a=new Z(s,e,n,r),c=new x(a,this._mat("cyl",i,o));c.position.set(t[0],t[1],t[2]),c.castShadow=!1,c.receiveShadow=!0,this.group.add(c);const l=Math.max(s,e),h=new Xe(l,l,n,6),u=new C({mass:0,shape:h,material:this.physics.defaultMaterial});return u.position.set(t[0],t[1],t[2]),this.physics.world.addBody(u),this.bodies.push(u),c}_buildTerrain(){const e=new Q(1e3,1e3,64,64);e.rotateX(-Math.PI/2);const n=e.attributes.position,i=new Float32Array(n.count*3),o=new B(2968125),r=new B;for(let l=0;l<n.count;l++){const h=n.getX(l),u=n.getZ(l);let m=Math.sin(h*.008)*Math.cos(u*.006)*6+Math.sin(h*.015+u*.012)*3;r.copy(o);for(const f of Object.values(this.zones)){const g=h-f.center.x,y=u-f.center.z,b=Math.sqrt(g*g+y*y);if(b<f.radius*2){const E=1-Math.min(b/(f.radius*2),1);m+=f.elevation*E*E*(3-2*E)}b<f.radius*1.5&&r.lerp(new B(f.color),(1-b/(f.radius*1.5))*.15)}n.setY(l,m),i[l*3]=r.r,i[l*3+1]=r.g,i[l*3+2]=r.b}e.setAttribute("color",new se(i,3)),e.computeVertexNormals();const a=new x(e,new R({vertexColors:!0,roughness:.85,flatShading:!0}));a.receiveShadow=!1,a.name="Terrain",this.group.add(a),this._terrainSize=1e3,this._terrainSegs=64,this._terrainHeights=new Float32Array(65*65);for(let l=0;l<n.count;l++)this._terrainHeights[l]=n.getY(l);const c=new Ps(1e3,1e3/2,3824202,2767402);c.material.opacity=.08,c.material.transparent=!0,c.position.y=.02,this.group.add(c)}_buildPaths(){const t=this._mat("path",9139029,{roughness:.9});[{from:[0,0,50],to:[0,0,-110],w:8},{from:[0,0,-110],to:[0,0,-160],w:8},{from:[-40,0,0],to:[-110,0,0],w:6},{from:[-110,0,0],to:[-160,0,0],w:6},{from:[40,0,0],to:[110,0,0],w:6},{from:[110,0,0],to:[160,0,0],w:6},{from:[-30,0,30],to:[-120,0,150],w:5},{from:[-120,0,150],to:[-140,0,170],w:5},{from:[30,0,30],to:[120,0,150],w:5},{from:[120,0,150],to:[140,0,170],w:5},{from:[-130,0,220],to:[-100,0,280],w:4},{from:[130,0,220],to:[100,0,280],w:4},{from:[-80,0,300],to:[80,0,300],w:4}].forEach(e=>{const n=new w(e.from[0],.05,e.from[2]),i=new w(e.to[0],.05,e.to[2]),o=i.clone().sub(n),r=o.length();o.normalize();const a=new Q(e.w,r);a.rotateX(-Math.PI/2);const c=new x(a,t);c.position.copy(n.clone().add(i).multiplyScalar(.5)),c.rotation.y=-Math.atan2(o.z,o.x)+Math.PI/2,c.receiveShadow=!0,this.group.add(c);const l=Math.floor(r/3);for(let h=0;h<=l;h++){const u=h/Math.max(l,1),m=n.clone().lerp(i,u),f=new w(-o.z,0,o.x);for(const g of[-1,1]){const y=m.clone().add(f.clone().multiplyScalar(g*e.w*.55)),b=new x(new H(.12+Math.random()*.08,4,3),this._mat("stone",7035706));b.position.set(y.x,.08,y.z),b.scale.y=.5,this.group.add(b)}}})}_buildZoneGrounds(){for(const[t,s]of Object.entries(this.zones)){const e=s.elevation,n=new et(s.radius-.4,s.radius,32);n.rotateX(-Math.PI/2);const i=new x(n,new S({color:s.color,transparent:!0,opacity:.2,side:V}));i.position.set(s.center.x,e+.1,s.center.z),this.group.add(i);const o=new we(s.radius*.85,24);o.rotateX(-Math.PI/2);const r=new x(o,new S({color:s.color,transparent:!0,opacity:.06,side:V}));r.position.set(s.center.x,e+.08,s.center.z),this.group.add(r);const a=2.5,c=new x(new Z(.06,.08,a,5),this._mat("pole",s.color,{emissive:s.color,emissiveIntensity:.25}));c.position.set(s.center.x,e+a/2,s.center.z),c.castShadow=!1,c.userData={isInteractable:!0,zoneId:t,zoneName:s.name},this.group.add(c);const l=new x(new H(.18,8,8),this._bmat("orb",s.color));l.position.set(s.center.x,e+a+.2,s.center.z),this.group.add(l),this.landmarks.push(c)}}_buildHubLandmark(){const{center:{x:t,z:s},elevation:e}=this.zones.HUB,n=new x(new _e(1.2,0),new R({color:16766720,emissive:16766720,emissiveIntensity:.3,metalness:.8,roughness:.2,transparent:!0,opacity:.85,flatShading:!0}));n.position.set(t,e+3.5,s),n.castShadow=!1,this.group.add(n),this.animatedObjects.push({mesh:n,type:"rotate_float",speed:.3,amplitude:.3});const i=new x(new H(.4,6,6),new S({color:16766720,transparent:!0,opacity:.4}));i.position.set(t,e+3.5,s),this.group.add(i);for(let r=0;r<6;r++){const a=r/6*Math.PI*2,c=t+Math.cos(a)*5,l=s+Math.sin(a)*5;this._staticCyl([c,e+.8,l],.25,.35,1.6,6052956,{roughness:.9,segments:5});const h=new x(new U(.15,.02,.15),this._bmat("rune",16766720,{transparent:!0,opacity:.6}));h.position.set(c,e+1.65,l),this.group.add(h),this.animatedObjects.push({mesh:h,type:"pulse",speed:.5+r*.15})}["Z1","Z2","Z3","Z4","Z5","Z6","Z7"].forEach(r=>{const a=this.zones[r],c=a.center.clone().sub(this.zones.HUB.center).normalize(),l=t+c.x*3.5,h=s+c.z*3.5,u=new x(new U(.08,1.5,.08),this._mat("post",6636321));u.position.set(l,e+.75,h),u.castShadow=!1,this.group.add(u);const m=new Pt(.15,.4,4);m.rotateZ(-Math.PI/2);const f=new x(m,this._bmat("arrow",a.color));f.position.set(l,e+1.4,h),f.lookAt(new w(a.center.x,e+1.4,a.center.z)),this.group.add(f)}),this._staticBox([t+2,e+.3,s+4],[1.2,.6,.8],8026746,{roughness:.95})}_buildZ1Landmark(){const{center:{x:t,z:s},elevation:e}=this.zones.Z1,n=new x(new U(1,6,.6),new R({color:2899536,emissive:4886745,emissiveIntensity:.15,metalness:.6,roughness:.3,flatShading:!0}));n.position.set(t,e+3,s),n.castShadow=!1,this.group.add(n);const i=new C({mass:0,shape:new he(new q(.5,3,.3)),material:this.physics.defaultMaterial});i.position.set(t,e+3,s),this.physics.world.addBody(i),this.bodies.push(i),this._addLight(this.group,4886745,1.5,10,2,t,e+5,s);for(let c=0;c<8;c++){const l=new x(new U(.3+Math.random()*.4,.03,.03),this._bmat("code",6992127,{transparent:!0,opacity:.5}));l.position.set(t+(Math.random()-.5)*.6,e+1+c*.6,s+.35),this.group.add(l),this.animatedObjects.push({mesh:l,type:"code_scroll",speed:.5+Math.random()*.5,originY:l.position.y,maxY:e+5.5,minY:e+.5})}const o=[[t-4,s-2],[t+4,s-2],[t-3,s+3],[t+3,s+3],[t-5,s+1],[t+5,s-1]];o.forEach(([c,l])=>{const h=1.5+Math.random()*2.5;if(this._staticCyl([c,e+h/2,l],.2,.3,h,4874368,{segments:5}),Math.random()>.5){const u=new x(new U(.5,.15,.5),this._mat("cap",5596791));u.position.set(c,e+h+.08,l),u.rotation.y=Math.random()*Math.PI,this.group.add(u)}}),[[t-3,s-1],[t+3,s-1],[t,s+4]].forEach(([c,l])=>{const h=new x(new Q(1.2,.8),new S({color:4886745,transparent:!0,opacity:.3,side:V}));h.position.set(c,e+1.2,l),h.lookAt(new w(t,e+1.2,s)),this.group.add(h),this.animatedObjects.push({mesh:h,type:"flicker",speed:2}),this._staticBox([c,e+.4,l],[.15,.8,.15],3622735)});const a=new Se({color:6992127,transparent:!0,opacity:.3});for(let c=0;c<Math.min(3,Math.floor(o.length/2));c++){const l=o[c*2],h=o[c*2+1];if(!l||!h)break;const u=[];for(let m=0;m<=6;m++){const f=m/6;u.push(new w(l[0]+(h[0]-l[0])*f,e+2+Math.sin(f*Math.PI)*.8+(Math.random()-.5)*.3,l[1]+(h[1]-l[1])*f))}this.group.add(new ke(new oe().setFromPoints(u),a))}}_buildZ2Landmark(){const{center:{x:t,z:s},elevation:e}=this.zones.Z2,n=[8069026,10233776,11225020,13538264];this._staticCyl([t,e+2,s],.3,.5,4,6044186,{segments:5});for(let r=0;r<4;r++){const a=2.5-r*.5,c=new x(new _e(a,0),new R({color:n[r],emissive:n[r],emissiveIntensity:.1,flatShading:!0,transparent:!0,opacity:.85}));c.position.set(t,e+5+r*1.5,s),c.rotation.y=r*.5,c.castShadow=!1,this.group.add(c),this.animatedObjects.push({mesh:c,type:"slow_rotate",speed:.15+r*.05})}const i=new C({mass:0,shape:new he(new q(2.5,4,2.5)),material:this.physics.defaultMaterial});i.position.set(t,e+7,s),this.physics.world.addBody(i),this.bodies.push(i);for(let r=0;r<12;r++){const a=Math.random()*Math.PI*2,c=1.5+Math.random()*2,l=.2+Math.random()*.3,h=new x(new U(l,l,l),this._bmat("leaf",n[r%4],{transparent:!0,opacity:.6}));h.position.set(t+Math.cos(a)*c,e+5+Math.random()*5,s+Math.sin(a)*c),this.group.add(h),this.animatedObjects.push({mesh:h,type:"spin_cube",speed:.5+Math.random()*1.5})}[[t-4,s+2],[t+4,s-2]].forEach(([r,a])=>{this._staticBox([r,e+.8,a],[.8,1.6,.6],4854924);const c=new x(new Q(.6,.4),this._bmat("ascreen",13538264,{transparent:!0,opacity:.5}));c.position.set(r,e+1.2,a+.31),this.group.add(c),this.animatedObjects.push({mesh:c,type:"flicker",speed:3})});for(let r=0;r<5;r++){const a=new x(new Z(.12,.12,.04,8),this._bmat("coin",16766720));a.position.set(t+(Math.random()-.5)*10,e+1+Math.random()*2,s+(Math.random()-.5)*10),a.rotation.x=Math.PI/2,this.group.add(a),this.animatedObjects.push({mesh:a,type:"rotate_float",speed:2,amplitude:.15})}this._addLight(this.group,10181046,1,12,2,t,e+6,s)}_buildZ3Landmark(){const{center:{x:t,z:s},elevation:e}=this.zones.Z3,n=new x(new Ke(1.5,1),new R({color:15277667,emissive:16728193,emissiveIntensity:.35,metalness:.7,roughness:.15,transparent:!0,opacity:.75,flatShading:!0}));n.position.set(t,e+4,s),n.castShadow=!1,this.group.add(n),this.animatedObjects.push({mesh:n,type:"rotate_float",speed:.2,amplitude:.4}),this._addLight(this.group,15277667,2,15,2,t,e+4,s);const i=new C({mass:0,shape:new Ce(1.5),material:this.physics.defaultMaterial});i.position.set(t,e+4,s),this.physics.world.addBody(i),this.bodies.push(i);for(let o=0;o<8;o++){const r=o/8*Math.PI*2,a=3+Math.random()*2.5,c=t+Math.cos(r)*a,l=s+Math.sin(r)*a,h=e+1.5+Math.random()*2,u=new x(new H(.2,6,6),this._bmat("synapse",16728193,{transparent:!0,opacity:.5}));u.position.set(c,h,l),this.group.add(u),this.animatedObjects.push({mesh:u,type:"pulse",speed:.8+o*.1}),this.group.add(new ke(new oe().setFromPoints([new w(t,e+4,s),new w(c,h,l)]),new Se({color:16728193,transparent:!0,opacity:.2})))}for(let o=0;o<6;o++){const r=o/6*Math.PI*2,a=this.zones.Z3.radius*.7,c=t+Math.cos(r)*a,l=s+Math.sin(r)*a,h=.8+Math.random()*1.5,u=new x(new Pt(.15+Math.random()*.15,h,4),this._mat("crystal",15277667,{emissive:15277667,emissiveIntensity:.2,metalness:.5}));u.position.set(c,e+h/2,l),u.castShadow=!1,this.group.add(u)}for(let o=0;o<4;o++){const r=o/4*Math.PI*2+Math.PI/4,a=this.zones.Z3.radius-.5;this._staticBox([t+Math.cos(r)*a,e+1.5,s+Math.sin(r)*a],[2.5,3,.4],3947610,{rotY:r+Math.PI/2,roughness:.95})}}_buildZ4Landmark(){const{center:{x:t,z:s},elevation:e}=this.zones.Z4;this._staticBox([t,e+1.5,s-2],[5,3,1.5],7033408,{roughness:.95});const n=new S({color:5227511,transparent:!0,opacity:.35,side:V});for(let c=0;c<3;c++){const l=new x(new Q(.8+c*.3,3),n);l.position.set(t+(c-1)*.7,e+1.5,s-1.24),this.group.add(l),this.animatedObjects.push({mesh:l,type:"waterfall",speed:1.5+c*.3})}const i=new we(2.5,16);i.rotateX(-Math.PI/2);const o=new x(i,new S({color:166097,transparent:!0,opacity:.4}));o.position.set(t,e+.05,s-3),this.group.add(o),[[t-3,s+2],[t+3,s+3]].forEach(([c,l])=>{const h=new x(new xe(.8,.12,6,12),this._mat("reel",16750592,{metalness:.4}));h.position.set(c,e+.3,l),h.rotation.x=Math.PI/2,this.group.add(h),this.animatedObjects.push({mesh:h,type:"slow_rotate",speed:.3});const u=new x(new Z(.3,.3,.1,8),this._mat("reelc",15094016));u.position.set(c,e+.3,l),this.group.add(u)});const a=new W;a.position.set(t+2,e+4,s+1),a.add(new x(new U(.5,.2,.5),this._mat("drone",3622735,{metalness:.5})));for(let c=0;c<4;c++){const l=c/4*Math.PI*2+Math.PI/4,h=new x(new U(.06,.04,.4),this._mat("arm",4545124));h.position.set(Math.cos(l)*.35,.1,Math.sin(l)*.35),h.lookAt(new w(0,0,0)),a.add(h)}this.group.add(a),this.animatedObjects.push({mesh:a,type:"drone_hover",speed:1,originPos:a.position.clone()}),this._addLight(this.group,16750592,1.5,12,2,t,e+3,s)}_buildZ5Landmark(){const{center:{x:t,z:s},elevation:e}=this.zones.Z5;this._staticBox([t,e+1,s],[2,2,2],3046706,{roughness:.8}),this._staticCyl([t,e+5,s],.3,.5,6,3706428,{segments:6});const n=new x(new _e(.6,0),new R({color:5025616,emissive:8505220,emissiveIntensity:.5,metalness:.5,roughness:.2,flatShading:!0}));n.position.set(t,e+8.5,s),n.castShadow=!1,this.group.add(n),this.animatedObjects.push({mesh:n,type:"rotate_float",speed:1,amplitude:.1}),this._addLight(this.group,5025616,3,25,2,t,e+9,s);for(let o=0;o<3;o++){const r=new x(new xe(1.5+o*1.2,.03,4,16),this._bmat("signal",8505220,{transparent:!0,opacity:.2-o*.05}));r.position.set(t,e+7+o*.5,s),r.rotation.x=Math.PI/2,this.group.add(r),this.animatedObjects.push({mesh:r,type:"expand_ring",speed:.3+o*.1,maxScale:2.5})}[{pos:[t-4,e+2,s+2],r:.3},{pos:[t+4,e+2.5,s-1],r:-.4}].forEach(o=>{const r=new x(new Q(1.5,1),this._mat("billboard",3046706,{emissive:5025616,emissiveIntensity:.15}));r.position.set(o.pos[0],o.pos[1],o.pos[2]),r.rotation.y=o.r,this.group.add(r),this._staticBox([o.pos[0],e+1,o.pos[2]],[.1,2,.1],6111287)})}_buildZ6Landmark(){const{center:{x:t,z:s},elevation:e}=this.zones.Z6;this._staticCyl([t,e+3,s],.8,1.2,6,6111287,{segments:7}),[{r:3.5,y:e+8,c:16748288},{r:3,y:e+9.5,c:16754470},{r:2,y:e+11,c:16758605}].forEach(r=>{const a=new x(new Ke(r.r,1),new R({color:r.c,emissive:r.c,emissiveIntensity:.08,flatShading:!0,transparent:!0,opacity:.7}));a.position.set(t,r.y,s),a.castShadow=!1,this.group.add(a)});const i=new C({mass:0,shape:new Ce(3.5),material:this.physics.defaultMaterial});i.position.set(t,e+8,s),this.physics.world.addBody(i),this.bodies.push(i);const o=new x(new H(.4,8,8),this._bmat("heart",16758605,{transparent:!0,opacity:.6}));o.position.set(t,e+2,s),this.group.add(o),this.animatedObjects.push({mesh:o,type:"pulse",speed:.4}),this._addLight(this.group,16758605,1.5,8,2,t,e+2,s);for(let r=0;r<5;r++){const a=r/5*Math.PI*2,c=2+Math.random()*1.5,l=new x(new Z(.05,.15,c,4),this._mat("root",6111287));l.position.set(t+Math.cos(a)*1.2,e+.3,s+Math.sin(a)*1.2),l.rotation.z=Math.cos(a)*.5,l.rotation.x=Math.sin(a)*.5,this.group.add(l)}for(let r=0;r<3;r++){const a=r/3*Math.PI*2,c=t+Math.cos(a)*3,l=s+Math.sin(a)*3,h=new x(new U(.8,.6,.05),this._mat("frame",9268835));h.position.set(c,e+1.5,l),h.lookAt(new w(t,e+1.5,s)),this.group.add(h);const u=new x(new Q(.6,.4),this._bmat("photo",16758605,{transparent:!0,opacity:.3}));u.position.set(c,e+1.5,l),u.lookAt(new w(t,e+1.5,s)),this.group.add(u)}}_buildZ7Landmark(){const{center:{x:t,z:s},elevation:e}=this.zones.Z7,n=new x(new _e(1,0),new R({color:2541274,emissive:2541274,emissiveIntensity:.4,metalness:.6,roughness:.15,transparent:!0,opacity:.8,flatShading:!0}));n.position.set(t,e+3,s),n.castShadow=!1,this.group.add(n),this.animatedObjects.push({mesh:n,type:"rotate_float",speed:.5,amplitude:.25});const i=new C({mass:0,shape:new Ce(1),material:this.physics.defaultMaterial});i.position.set(t,e+3,s),this.physics.world.addBody(i),this.bodies.push(i),this._addLight(this.group,2541274,2,15,2,t,e+3,s);for(let r=0;r<4;r++){const a=new x(new xe(1.5+r*1,.03,4,24),this._bmat("echo",2541274,{transparent:!0,opacity:.15-r*.03}));a.position.set(t,e+3,s),a.rotation.x=Math.PI/2,this.group.add(a),this.animatedObjects.push({mesh:a,type:"expand_ring",speed:.2+r*.08,maxScale:3})}for(let r=0;r<5;r++){const a=r/5*Math.PI+Math.PI*.75,c=this.zones.Z7.radius-.5,l=2+Math.random()*1.5;this._staticBox([t+Math.cos(a)*c,e+l/2,s+Math.sin(a)*c],[1.8,l,.3],1731450,{rotY:a+Math.PI/2,emissive:2541274,emissiveIntensity:.05,metalness:.3})}const o=[1942002,4351922,14757996,30645];for(let r=0;r<4;r++){const a=r/4*Math.PI*2,c=t+Math.cos(a)*2.5,l=s+Math.sin(a)*2.5;this._staticCyl([c,e+1,l],.12,.15,2,o[r],{segments:4}),this.group.add(new ke(new oe().setFromPoints([new w(c,e+2,l),new w(t,e+3,s)]),new Se({color:2541274,transparent:!0,opacity:.15})))}}_buildPortals(){const t=[{id:"P1",to:"Z1",pos:[0,0,-5],rotY:0},{id:"P2",to:"Z2",pos:[-5,0,0],rotY:Math.PI/2},{id:"P3",to:"Z3",pos:[5,0,0],rotY:-Math.PI/2},{id:"P4",to:"Z4",pos:[-4,0,4],rotY:Math.PI/4},{id:"P5",to:"Z5",pos:[4,0,4],rotY:-Math.PI/4}],s=this._mat("arch",6636321,{roughness:.9});t.forEach(e=>{var u,m;const n=new W;n.position.set(e.pos[0],0,e.pos[2]),n.rotation.y=e.rotY;const i=new x(new xe(1.4,.12,4,12,Math.PI),s);i.rotation.x=Math.PI,i.position.y=1.4,n.add(i);const o=new Z(.12,.15,2.8,5),r=new x(o,s);r.position.set(-1.4,1.4,0),r.castShadow=!1,n.add(r);const a=new x(o,s);a.position.set(1.4,1.4,0),a.castShadow=!1,n.add(a);const c=((u=this.zones[e.to])==null?void 0:u.color)||4886745,l=new x(new we(1.1,16),new S({color:c,transparent:!0,opacity:.35,side:V}));l.position.y=1.4,n.add(l),this.animatedObjects.push({mesh:l,type:"portal_pulse",speed:1.5}),this._addLight(n,c,.8,6,2,0,1.4,0);const h=new Xe(.15,.15,2.8,5);for(const f of[-1.4,1.4]){const g=new w(f,1.4,0).applyAxisAngle(new w(0,1,0),e.rotY),y=new C({mass:0,shape:h,material:this.physics.defaultMaterial});y.position.set(e.pos[0]+g.x,1.4,e.pos[2]+g.z),this.physics.world.addBody(y),this.bodies.push(y)}n.userData={isPortal:!0,portalId:e.id,toZone:e.to,destination:((m=this.zones[e.to])==null?void 0:m.center.clone().setY(2))||new w(0,2,0)},this.group.add(n),this.portals.push(n)})}_buildTrees(){const t=[];for(let h=0;h<600;h++){const u=(Math.random()-.5)*450*2,m=(Math.random()-.5)*450*2;let f=!1;for(const y of Object.values(this.zones)){const b=u-y.center.x,E=m-y.center.z;if(Math.sqrt(b*b+E*E)<35){f=!0;break}}if(f)continue;let g=!1;for(const y of t)if(Math.sqrt((u-y[0])**2+(m-y[1])**2)<8){g=!0;break}g||t.push([u,m])}const o=new Z(.3,.6,8,4),r=new Ie(o,this._mat("trunk",6044186,{roughness:.95}),t.length);r.castShadow=!0,r.receiveShadow=!0;const a=new Ke(3.6,0),c=new Ie(a,this._mat("treecanopy",1793568,{roughness:.85}),t.length);c.castShadow=!0;const l=new De;t.forEach(([h,u],m)=>{const f=.6+Math.random()*.8,g=8*f;if(l.position.set(h,g/2,u),l.scale.set(f,f,f),l.rotation.y=Math.random()*Math.PI,l.updateMatrix(),r.setMatrixAt(m,l.matrix),l.position.set(h,g+2.4*f,u),l.scale.set(f*1.2,f*(.8+Math.random()*.5),f*1.2),l.updateMatrix(),c.setMatrixAt(m,l.matrix),f>.8){const y=new Xe(.45*f,.75*f,g,4),b=new C({mass:0,shape:y,material:this.physics.defaultMaterial});b.position.set(h,g/2,u),this.physics.world.addBody(b),this.bodies.push(b)}}),this.group.add(r),this.group.add(c),console.log(`üå≤ Placed ${t.length} trees (instanced)`)}_buildRocks(){const s=new Ss(3,0),e=new Ie(s,this._mat("rock",5921370,{roughness:.95}),150);e.castShadow=!1,e.receiveShadow=!0;const n=new De;for(let i=0;i<150;i++){const o=(Math.random()-.5)*840,r=(Math.random()-.5)*840,a=.3+Math.random()*.8;n.position.set(o,a*.3,r),n.scale.set(a*(.8+Math.random()*.4),a*.5,a*(.8+Math.random()*.4)),n.rotation.set(Math.random(),Math.random(),Math.random()),n.updateMatrix(),e.setMatrixAt(i,n.matrix)}this.group.add(e)}_buildBoundaryWalls(){const e=[{pos:[0,10,-500],size:[1e3,20,2]},{pos:[0,10,500],size:[1e3,20,2]},{pos:[-500,10,0],size:[2,20,1e3]},{pos:[500,10,0],size:[2,20,1e3]}],n=new S({color:2968125,transparent:!0,opacity:.2,side:V});e.forEach(i=>{const o=new he(new q(i.size[0]/2,i.size[1]/2,i.size[2]/2)),r=new C({mass:0,shape:o,material:this.physics.defaultMaterial});r.position.set(i.pos[0],i.pos[1],i.pos[2]),this.physics.world.addBody(r),this.bodies.push(r);const a=new Q(Math.max(i.size[0],i.size[2]),i.size[1]),c=new x(a,n);c.position.set(i.pos[0],i.pos[1],i.pos[2]),i.size[2]>=1&&(c.rotation.y=Math.PI/2),this.group.add(c)})}_buildParticles(){const s=new oe,e=new Float32Array(100*3),n=[];for(let h=0;h<100;h++)e[h*3]=(Math.random()-.5)*600,e[h*3+1]=1.5+Math.random()*12,e[h*3+2]=(Math.random()-.5)*60,n.push({sx:(Math.random()-.5)*.02,sy:(Math.random()-.5)*.01,sz:(Math.random()-.5)*.02,phase:Math.random()*Math.PI*2});s.setAttribute("position",new se(e,3));const i=new tt(s,new st({color:16769154,size:.15,transparent:!0,opacity:.8,sizeAttenuation:!0,blending:ks,depthWrite:!1}));i.name="Fireflies",this.group.add(i),this.particles.push({points:i,speeds:n,type:"firefly"});const o=60,r=new oe,a=new Float32Array(o*3),c=[];for(let h=0;h<o;h++)a[h*3]=(Math.random()-.5)*500,a[h*3+1]=3+Math.random()*18,a[h*3+2]=(Math.random()-.5)*500,c.push({sx:(Math.random()-.5)*.02,sy:Math.random()*.01,sz:(Math.random()-.5)*.02,phase:Math.random()*Math.PI*2});r.setAttribute("position",new se(a,3));const l=new tt(r,new st({color:16777215,size:.3,transparent:!0,opacity:.5,sizeAttenuation:!0,depthWrite:!1}));l.name="Pollen",this.group.add(l),this.particles.push({points:l,speeds:c,type:"pollen"})}_buildSpawnMarker(){const t=new et(2,2.5,16);t.rotateX(-Math.PI/2);const s=new x(t,this._bmat("spawn",58998,{transparent:!0,opacity:.4}));s.position.set(0,.15,50),this.group.add(s),this.animatedObjects.push({mesh:s,type:"pulse",speed:.6});const e=new we(1,8);e.rotateX(-Math.PI/2);const n=new x(e,this._bmat("spawndot",58998,{transparent:!0,opacity:.25}));n.position.set(0,.16,50),this.group.add(n),this._addLight(this.group,58998,1.5,15,2,0,3,50)}_buildZoneLabels(){for(const[t,s]of Object.entries(this.zones)){const e=this._createTextSprite(s.name,s.color);e.position.set(s.center.x,s.elevation+25,s.center.z),e.userData={baseY:s.elevation+25,phase:Math.random()*Math.PI*2},this.group.add(e),this.zoneLabels.push(e)}}_createTextSprite(t,s){const e=document.createElement("canvas"),n=e.getContext("2d");e.width=512,e.height=128;const i=n.createLinearGradient(0,0,0,e.height);i.addColorStop(0,"rgba(0,0,0,0)"),i.addColorStop(.5,"rgba(0,0,0,0.3)"),i.addColorStop(1,"rgba(0,0,0,0)"),n.fillStyle=i,n.fillRect(0,0,e.width,e.height),n.font="bold 48px Georgia, serif",n.textAlign="center",n.textBaseline="middle",n.shadowColor=`#${s.toString(16).padStart(6,"0")}`,n.shadowBlur=20,n.shadowOffsetX=0,n.shadowOffsetY=0,n.strokeStyle="#1a1a2e",n.lineWidth=6,n.strokeText(t,e.width/2,e.height/2);const o=`#${s.toString(16).padStart(6,"0")}`;n.fillStyle=o,n.fillText(t,e.width/2,e.height/2);const r=new Is(e);r.minFilter=ct;const a=new Cs({map:r,transparent:!0,opacity:.9,depthTest:!0,depthWrite:!1}),c=new Rs(a);return c.scale.set(24,6,1),c.name=`Label_${t}`,c}getZoneAtPosition(t){for(const[s,e]of Object.entries(this.zones)){const n=t.x-e.center.x,i=t.z-e.center.z;if(Math.sqrt(n*n+i*i)<=e.radius)return{id:s,...e}}return null}getPortalsNearPosition(t,s=2.5){return this.portals.filter(e=>e.position.distanceTo(t)<=s)}getZoneSpawnPoint(t){const s=this.zones[t];return s?s.center.clone().setY(s.elevation+2):new w(0,2,5)}update(){var s;const t=performance.now()*.001;for(const e of this.animatedObjects){const n=e.mesh;switch(e.type){case"rotate_float":n.rotation.y+=e.speed*.01,n.position.y+=Math.sin(t*e.speed)*e.amplitude*.005;break;case"slow_rotate":n.rotation.y+=e.speed*.005;break;case"pulse":{const i=1+Math.sin(t*e.speed*2)*.15;n.scale.set(i,i,i),((s=n.material)==null?void 0:s.opacity)!==void 0&&(n.material.opacity=.4+Math.sin(t*e.speed*2)*.2);break}case"flicker":n.material&&(n.material.opacity=.25+Math.sin(t*e.speed*5)*.15+Math.sin(t*e.speed*13)*.05);break;case"code_scroll":n.position.y+=.01*e.speed,n.position.y>e.maxY&&(n.position.y=e.minY);break;case"spin_cube":n.rotation.x+=e.speed*.01,n.rotation.z+=e.speed*.008;break;case"portal_pulse":n.material&&(n.material.opacity=.25+Math.sin(t*e.speed)*.12);break;case"expand_ring":{const i=t*e.speed%(Math.PI*2),o=1+i/(Math.PI*2)*(e.maxScale-1);n.scale.set(o,o,1),n.material&&(n.material.opacity=.15*(1-i/(Math.PI*2)));break}case"waterfall":n.material&&(n.material.opacity=.25+Math.sin(t*e.speed*3)*.1);break;case"drone_hover":n.position.x=e.originPos.x+Math.sin(t*.5)*1.5,n.position.y=e.originPos.y+Math.sin(t*.8)*.3,n.position.z=e.originPos.z+Math.cos(t*.4)*1,n.rotation.y+=.005;break}}for(const e of this.particles){const n=e.points.geometry.attributes.position;for(let i=0;i<n.count;i++){const o=e.speeds[i];e.type==="firefly"?(n.array[i*3]+=Math.sin(t*2+o.phase)*o.sx,n.array[i*3+1]+=Math.sin(t*1.5+o.phase)*o.sy,n.array[i*3+2]+=Math.cos(t*2+o.phase)*o.sz):(n.array[i*3]+=o.sx,n.array[i*3+1]+=Math.sin(t*.5+o.phase)*o.sy,n.array[i*3+2]+=o.sz,n.array[i*3]>250&&(n.array[i*3]=-250),n.array[i*3]<-250&&(n.array[i*3]=250),n.array[i*3+2]>250&&(n.array[i*3+2]=-250),n.array[i*3+2]<-250&&(n.array[i*3+2]=250))}n.needsUpdate=!0}for(const e of this.zoneLabels){const{baseY:n,phase:i}=e.userData;e.position.y=n+Math.sin(t*.5+i)*1.5}for(const{mesh:e,body:n}of this.dynamicMeshes)e.position.copy(n.position),e.quaternion.copy(n.quaternion)}dispose(){this.bodies.forEach(t=>this.physics.world.removeBody(t)),this.bodies=[],this.physics.removeZoneColliders(),this.group.traverse(t=>{var s,e,n,i;(t.isMesh||t.isInstancedMesh||t.isLine||t.isPoints||t.isSprite)&&((s=t.geometry)==null||s.dispose(),Array.isArray(t.material)?t.material.forEach(o=>{var r;(r=o.map)==null||r.dispose(),o.dispose()}):((n=(e=t.material)==null?void 0:e.map)==null||n.dispose(),(i=t.material)==null||i.dispose()))}),this.scene.remove(this.group);for(const t of Object.values(this._matPool))t.dispose();this._matPool={},this.animatedObjects=[],this.particles=[],this.portals=[],this.landmarks=[],this.dynamicMeshes=[],this.zoneLabels=[],console.log("üßπ Production World disposed")}}class Tn{constructor(){this.experience=new j,this.scene=this.experience.scene,this.resources=this.experience.resources,this.physics=this.experience.physics,this.group=new W,this.group.name="ForestEnvironment",this.portals=[],this.landmarks=[],this.bodies=[],this.targetWorldSize=80,this.zones={HUB:{name:"Central Hub",center:new w(0,0,0),radius:8,color:16766720},Z1:{name:"IT Services",center:new w(0,0,-18),radius:6,color:4886745},Z2:{name:"Game Dev",center:new w(-18,0,0),radius:6,color:10181046},Z3:{name:"AI Automation",center:new w(18,0,0),radius:6,color:15277667},Z4:{name:"Media",center:new w(-15,0,18),radius:6,color:16750592},Z5:{name:"Marketing",center:new w(15,0,18),radius:6,color:5025616},Z6:{name:"About",center:new w(-10,0,30),radius:5,color:16758605},Z7:{name:"Contact",center:new w(10,0,30),radius:5,color:2541274}},this.loadForest(),this.createZoneMarkers(),this.createPortals(),this.scene.add(this.group),console.log("üå≥ Forest Environment loaded")}loadForest(){const t=this.resources.items.forestEnvironment;if(!t){console.warn("‚ö†Ô∏è Forest GLB not available");return}const s=t.scene.clone(),e=new be().setFromObject(s),n=new w;e.getSize(n);const i=new w;e.getCenter(i),console.log(`üìê Raw model: ${n.x.toFixed(1)} x ${n.y.toFixed(1)} x ${n.z.toFixed(1)}`),console.log(`üìê Raw center: (${i.x.toFixed(1)}, ${i.y.toFixed(1)}, ${i.z.toFixed(1)})`);const o=Math.max(n.x,n.z),r=this.targetWorldSize/o;s.scale.setScalar(r),console.log(`üìê Applied scale: ${r.toFixed(4)}`);const a=new be().setFromObject(s),c=new w;a.getCenter(c),s.position.x=-c.x,s.position.z=-c.z,s.position.y=-a.min.y;const l=new be().setFromObject(s),h=new w;l.getSize(h),console.log(`‚úÖ Final model: ${h.x.toFixed(1)} x ${h.y.toFixed(1)} x ${h.z.toFixed(1)}, ground at y=${l.min.y.toFixed(2)}`);let u=0;s.traverse(m=>{m.isMesh&&(u++,m.castShadow=!1,m.receiveShadow=!0,m.frustumCulled=!0,m.material&&(Array.isArray(m.material)?m.material:[m.material]).forEach(g=>{g.flatShading=!0,g.side=Ut,g.fog=!0,g.map&&(g.map.anisotropy=1),g.normalMap&&(g.normalMap.dispose(),g.normalMap=null),g.roughnessMap&&(g.roughnessMap.dispose(),g.roughnessMap=null),g.metalnessMap&&(g.metalnessMap.dispose(),g.metalnessMap=null),g.aoMap&&(g.aoMap.dispose(),g.aoMap=null),g.envMapIntensity=0,g.needsUpdate=!0}),m.geometry&&(m.geometry.computeBoundingSphere(),m.geometry.attributes.uv2&&m.geometry.deleteAttribute("uv2")))}),console.log(`‚úÖ Optimized ${u} forest meshes`),this.group.add(s),this.forestModel=s,this.createColliders(s)}createColliders(t){let s=0;t.traverse(e=>{if(!e.isMesh)return;const n=new be().setFromObject(e),i=new w;n.getSize(i);const o=new w;if(n.getCenter(o),i.x<.5&&i.y<.5&&i.z<.5)return;const r=new q(i.x/2,i.y/2,i.z/2),a=new he(r),c=new C({mass:0,shape:a,position:new q(o.x,o.y,o.z),material:this.physics.defaultMaterial});c.collisionResponse=!0,this.physics.world.addBody(c),this.bodies.push(c),s++}),console.log(`üß± Created ${s} forest colliders`)}createZoneMarkers(){const t=new S({transparent:!0,opacity:.25,side:V});for(const[s,e]of Object.entries(this.zones)){const n=t.clone();n.color=new B(e.color);const i=new et(e.radius-.3,e.radius,16);i.rotateX(-Math.PI/2);const o=new x(i,n);o.position.copy(e.center),o.position.y=.15,this.group.add(o);const r=new x(new Z(.08,.1,2,5),new R({color:e.color,emissive:e.color,emissiveIntensity:.3}));r.position.copy(e.center),r.position.y=1,r.userData={isInteractable:!0,zoneId:s,zoneName:e.name},this.group.add(r),this.landmarks.push(r);const a=new x(new H(.15,6,6),new S({color:e.color}));a.position.copy(e.center),a.position.y=2.2,this.group.add(a)}}createPortals(){const t=[{id:"P1",to:"Z1",pos:[0,0,-5]},{id:"P2",to:"Z2",pos:[-5,0,0]},{id:"P3",to:"Z3",pos:[5,0,0]},{id:"P4",to:"Z4",pos:[-4,0,4]},{id:"P5",to:"Z5",pos:[4,0,4]}],s=new R({color:6636321,flatShading:!0});t.forEach(e=>{var h,u;const n=new W;n.position.set(e.pos[0],0,e.pos[2]);const i=new x(new xe(1.2,.07,4,10,Math.PI),s);i.rotation.x=Math.PI,i.position.y=1.2,n.add(i);const o=new Z(.07,.09,2.4,4),r=new x(o,s);r.position.set(-1.2,1.2,0),n.add(r);const a=new x(o,s);a.position.set(1.2,1.2,0),n.add(a);const c=((h=this.zones[e.to])==null?void 0:h.color)||4886745,l=new x(new we(.9,10),new S({color:c,transparent:!0,opacity:.45,side:V}));l.position.y=1.2,n.add(l),n.userData={isPortal:!0,portalId:e.id,toZone:e.to,destination:((u=this.zones[e.to])==null?void 0:u.center.clone().setY(1))||new w(0,1,0)},this.group.add(n),this.portals.push(n)})}getZoneAtPosition(t){for(const[s,e]of Object.entries(this.zones))if(Math.hypot(t.x-e.center.x,t.z-e.center.z)<=e.radius)return{id:s,...e};return null}getPortalsNearPosition(t,s=2.5){return this.portals.filter(e=>e.position.distanceTo(t)<=s)}getZoneSpawnPoint(t){const s=this.zones[t];return s?s.center.clone().setY(2):new w(0,2,5)}update(){}dispose(){this.bodies.forEach(t=>this.physics.world.removeBody(t)),this.bodies=[],this.group.traverse(t=>{var s,e;t.isMesh&&((s=t.geometry)==null||s.dispose(),Array.isArray(t.material)?t.material.forEach(n=>n.dispose()):(e=t.material)==null||e.dispose())}),this.scene.remove(this.group),this.portals=[],this.landmarks=[]}}function zt(p,t){if(t===Ds)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),p;if(t===nt||t===Zt){let s=p.getIndex();if(s===null){const o=[],r=p.getAttribute("position");if(r!==void 0){for(let a=0;a<r.count;a++)o.push(a);p.setIndex(o),s=p.getIndex()}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),p}const e=s.count-2,n=[];if(t===nt)for(let o=1;o<=e;o++)n.push(s.getX(0)),n.push(s.getX(o)),n.push(s.getX(o+1));else for(let o=0;o<e;o++)o%2===0?(n.push(s.getX(o)),n.push(s.getX(o+1)),n.push(s.getX(o+2))):(n.push(s.getX(o+2)),n.push(s.getX(o+1)),n.push(s.getX(o)));n.length/3!==e&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const i=p.clone();return i.setIndex(n),i.clearGroups(),i}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",t),p}class qt extends Kt{constructor(t){super(t),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(s){return new Sn(s)}),this.register(function(s){return new Nn(s)}),this.register(function(s){return new Bn(s)}),this.register(function(s){return new jn(s)}),this.register(function(s){return new In(s)}),this.register(function(s){return new Cn(s)}),this.register(function(s){return new Rn(s)}),this.register(function(s){return new Dn(s)}),this.register(function(s){return new Pn(s)}),this.register(function(s){return new Fn(s)}),this.register(function(s){return new kn(s)}),this.register(function(s){return new zn(s)}),this.register(function(s){return new On(s)}),this.register(function(s){return new _n(s)}),this.register(function(s){return new Hn(s)}),this.register(function(s){return new Gn(s)})}load(t,s,e,n){const i=this;let o;if(this.resourcePath!=="")o=this.resourcePath;else if(this.path!==""){const c=Ae.extractUrlBase(t);o=Ae.resolveURL(c,this.path)}else o=Ae.extractUrlBase(t);this.manager.itemStart(t);const r=function(c){n?n(c):console.error(c),i.manager.itemError(t),i.manager.itemEnd(t)},a=new Fe(this.manager);a.setPath(this.path),a.setResponseType("arraybuffer"),a.setRequestHeader(this.requestHeader),a.setWithCredentials(this.withCredentials),a.load(t,function(c){try{i.parse(c,o,function(l){s(l),i.manager.itemEnd(t)},r)}catch(l){r(l)}},e,r)}setDRACOLoader(t){return this.dracoLoader=t,this}setDDSLoader(){throw new Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')}setKTX2Loader(t){return this.ktx2Loader=t,this}setMeshoptDecoder(t){return this.meshoptDecoder=t,this}register(t){return this.pluginCallbacks.indexOf(t)===-1&&this.pluginCallbacks.push(t),this}unregister(t){return this.pluginCallbacks.indexOf(t)!==-1&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(t),1),this}parse(t,s,e,n){let i;const o={},r={},a=new TextDecoder;if(typeof t=="string")i=JSON.parse(t);else if(t instanceof ArrayBuffer)if(a.decode(new Uint8Array(t,0,4))===Wt){try{o[M.KHR_BINARY_GLTF]=new Un(t)}catch(h){n&&n(h);return}i=JSON.parse(o[M.KHR_BINARY_GLTF].content)}else i=JSON.parse(a.decode(t));else i=t;if(i.asset===void 0||i.asset.version[0]<2){n&&n(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));return}const c=new si(i,{path:s||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});c.fileLoader.setRequestHeader(this.requestHeader);for(let l=0;l<this.pluginCallbacks.length;l++){const h=this.pluginCallbacks[l](c);h.name||console.error("THREE.GLTFLoader: Invalid plugin found: missing name"),r[h.name]=h,o[h.name]=!0}if(i.extensionsUsed)for(let l=0;l<i.extensionsUsed.length;++l){const h=i.extensionsUsed[l],u=i.extensionsRequired||[];switch(h){case M.KHR_MATERIALS_UNLIT:o[h]=new Ln;break;case M.KHR_DRACO_MESH_COMPRESSION:o[h]=new Zn(i,this.dracoLoader);break;case M.KHR_TEXTURE_TRANSFORM:o[h]=new Kn;break;case M.KHR_MESH_QUANTIZATION:o[h]=new Yn;break;default:u.indexOf(h)>=0&&r[h]===void 0&&console.warn('THREE.GLTFLoader: Unknown extension "'+h+'".')}}c.setExtensions(o),c.setPlugins(r),c.parse(e,n)}parseAsync(t,s){const e=this;return new Promise(function(n,i){e.parse(t,s,n,i)})}}function vn(){let p={};return{get:function(t){return p[t]},add:function(t,s){p[t]=s},remove:function(t){delete p[t]},removeAll:function(){p={}}}}const M={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class _n{constructor(t){this.parser=t,this.name=M.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const t=this.parser,s=this.parser.json.nodes||[];for(let e=0,n=s.length;e<n;e++){const i=s[e];i.extensions&&i.extensions[this.name]&&i.extensions[this.name].light!==void 0&&t._addNodeRef(this.cache,i.extensions[this.name].light)}}_loadLight(t){const s=this.parser,e="light:"+t;let n=s.cache.get(e);if(n)return n;const i=s.json,a=((i.extensions&&i.extensions[this.name]||{}).lights||[])[t];let c;const l=new B(16777215);a.color!==void 0&&l.setRGB(a.color[0],a.color[1],a.color[2],K);const h=a.range!==void 0?a.range:0;switch(a.type){case"directional":c=new Qe(l),c.target.position.set(0,0,-1),c.add(c.target);break;case"point":c=new Os(l),c.distance=h;break;case"spot":c=new Fs(l),c.distance=h,a.spot=a.spot||{},a.spot.innerConeAngle=a.spot.innerConeAngle!==void 0?a.spot.innerConeAngle:0,a.spot.outerConeAngle=a.spot.outerConeAngle!==void 0?a.spot.outerConeAngle:Math.PI/4,c.angle=a.spot.outerConeAngle,c.penumbra=1-a.spot.innerConeAngle/a.spot.outerConeAngle,c.target.position.set(0,0,-1),c.add(c.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+a.type)}return c.position.set(0,0,0),c.decay=2,te(c,a),a.intensity!==void 0&&(c.intensity=a.intensity),c.name=s.createUniqueName(a.name||"light_"+t),n=Promise.resolve(c),s.cache.add(e,n),n}getDependency(t,s){if(t==="light")return this._loadLight(s)}createNodeAttachment(t){const s=this,e=this.parser,i=e.json.nodes[t],r=(i.extensions&&i.extensions[this.name]||{}).light;return r===void 0?null:this._loadLight(r).then(function(a){return e._getNodeRef(s.cache,r,a)})}}class Ln{constructor(){this.name=M.KHR_MATERIALS_UNLIT}getMaterialType(){return S}extendParams(t,s,e){const n=[];t.color=new B(1,1,1),t.opacity=1;const i=s.pbrMetallicRoughness;if(i){if(Array.isArray(i.baseColorFactor)){const o=i.baseColorFactor;t.color.setRGB(o[0],o[1],o[2],K),t.opacity=o[3]}i.baseColorTexture!==void 0&&n.push(e.assignTexture(t,"map",i.baseColorTexture,ne))}return Promise.all(n)}}class Pn{constructor(t){this.parser=t,this.name=M.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(t,s){const n=this.parser.json.materials[t];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=n.extensions[this.name].emissiveStrength;return i!==void 0&&(s.emissiveIntensity=i),Promise.resolve()}}class Sn{constructor(t){this.parser=t,this.name=M.KHR_MATERIALS_CLEARCOAT}getMaterialType(t){const e=this.parser.json.materials[t];return!e.extensions||!e.extensions[this.name]?null:J}extendMaterialParams(t,s){const e=this.parser,n=e.json.materials[t];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],o=n.extensions[this.name];if(o.clearcoatFactor!==void 0&&(s.clearcoat=o.clearcoatFactor),o.clearcoatTexture!==void 0&&i.push(e.assignTexture(s,"clearcoatMap",o.clearcoatTexture)),o.clearcoatRoughnessFactor!==void 0&&(s.clearcoatRoughness=o.clearcoatRoughnessFactor),o.clearcoatRoughnessTexture!==void 0&&i.push(e.assignTexture(s,"clearcoatRoughnessMap",o.clearcoatRoughnessTexture)),o.clearcoatNormalTexture!==void 0&&(i.push(e.assignTexture(s,"clearcoatNormalMap",o.clearcoatNormalTexture)),o.clearcoatNormalTexture.scale!==void 0)){const r=o.clearcoatNormalTexture.scale;s.clearcoatNormalScale=new F(r,r)}return Promise.all(i)}}class kn{constructor(t){this.parser=t,this.name=M.KHR_MATERIALS_IRIDESCENCE}getMaterialType(t){const e=this.parser.json.materials[t];return!e.extensions||!e.extensions[this.name]?null:J}extendMaterialParams(t,s){const e=this.parser,n=e.json.materials[t];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],o=n.extensions[this.name];return o.iridescenceFactor!==void 0&&(s.iridescence=o.iridescenceFactor),o.iridescenceTexture!==void 0&&i.push(e.assignTexture(s,"iridescenceMap",o.iridescenceTexture)),o.iridescenceIor!==void 0&&(s.iridescenceIOR=o.iridescenceIor),s.iridescenceThicknessRange===void 0&&(s.iridescenceThicknessRange=[100,400]),o.iridescenceThicknessMinimum!==void 0&&(s.iridescenceThicknessRange[0]=o.iridescenceThicknessMinimum),o.iridescenceThicknessMaximum!==void 0&&(s.iridescenceThicknessRange[1]=o.iridescenceThicknessMaximum),o.iridescenceThicknessTexture!==void 0&&i.push(e.assignTexture(s,"iridescenceThicknessMap",o.iridescenceThicknessTexture)),Promise.all(i)}}class In{constructor(t){this.parser=t,this.name=M.KHR_MATERIALS_SHEEN}getMaterialType(t){const e=this.parser.json.materials[t];return!e.extensions||!e.extensions[this.name]?null:J}extendMaterialParams(t,s){const e=this.parser,n=e.json.materials[t];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[];s.sheenColor=new B(0,0,0),s.sheenRoughness=0,s.sheen=1;const o=n.extensions[this.name];if(o.sheenColorFactor!==void 0){const r=o.sheenColorFactor;s.sheenColor.setRGB(r[0],r[1],r[2],K)}return o.sheenRoughnessFactor!==void 0&&(s.sheenRoughness=o.sheenRoughnessFactor),o.sheenColorTexture!==void 0&&i.push(e.assignTexture(s,"sheenColorMap",o.sheenColorTexture,ne)),o.sheenRoughnessTexture!==void 0&&i.push(e.assignTexture(s,"sheenRoughnessMap",o.sheenRoughnessTexture)),Promise.all(i)}}class Cn{constructor(t){this.parser=t,this.name=M.KHR_MATERIALS_TRANSMISSION}getMaterialType(t){const e=this.parser.json.materials[t];return!e.extensions||!e.extensions[this.name]?null:J}extendMaterialParams(t,s){const e=this.parser,n=e.json.materials[t];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],o=n.extensions[this.name];return o.transmissionFactor!==void 0&&(s.transmission=o.transmissionFactor),o.transmissionTexture!==void 0&&i.push(e.assignTexture(s,"transmissionMap",o.transmissionTexture)),Promise.all(i)}}class Rn{constructor(t){this.parser=t,this.name=M.KHR_MATERIALS_VOLUME}getMaterialType(t){const e=this.parser.json.materials[t];return!e.extensions||!e.extensions[this.name]?null:J}extendMaterialParams(t,s){const e=this.parser,n=e.json.materials[t];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],o=n.extensions[this.name];s.thickness=o.thicknessFactor!==void 0?o.thicknessFactor:0,o.thicknessTexture!==void 0&&i.push(e.assignTexture(s,"thicknessMap",o.thicknessTexture)),s.attenuationDistance=o.attenuationDistance||1/0;const r=o.attenuationColor||[1,1,1];return s.attenuationColor=new B().setRGB(r[0],r[1],r[2],K),Promise.all(i)}}class Dn{constructor(t){this.parser=t,this.name=M.KHR_MATERIALS_IOR}getMaterialType(t){const e=this.parser.json.materials[t];return!e.extensions||!e.extensions[this.name]?null:J}extendMaterialParams(t,s){const n=this.parser.json.materials[t];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=n.extensions[this.name];return s.ior=i.ior!==void 0?i.ior:1.5,Promise.resolve()}}class Fn{constructor(t){this.parser=t,this.name=M.KHR_MATERIALS_SPECULAR}getMaterialType(t){const e=this.parser.json.materials[t];return!e.extensions||!e.extensions[this.name]?null:J}extendMaterialParams(t,s){const e=this.parser,n=e.json.materials[t];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],o=n.extensions[this.name];s.specularIntensity=o.specularFactor!==void 0?o.specularFactor:1,o.specularTexture!==void 0&&i.push(e.assignTexture(s,"specularIntensityMap",o.specularTexture));const r=o.specularColorFactor||[1,1,1];return s.specularColor=new B().setRGB(r[0],r[1],r[2],K),o.specularColorTexture!==void 0&&i.push(e.assignTexture(s,"specularColorMap",o.specularColorTexture,ne)),Promise.all(i)}}class On{constructor(t){this.parser=t,this.name=M.EXT_MATERIALS_BUMP}getMaterialType(t){const e=this.parser.json.materials[t];return!e.extensions||!e.extensions[this.name]?null:J}extendMaterialParams(t,s){const e=this.parser,n=e.json.materials[t];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],o=n.extensions[this.name];return s.bumpScale=o.bumpFactor!==void 0?o.bumpFactor:1,o.bumpTexture!==void 0&&i.push(e.assignTexture(s,"bumpMap",o.bumpTexture)),Promise.all(i)}}class zn{constructor(t){this.parser=t,this.name=M.KHR_MATERIALS_ANISOTROPY}getMaterialType(t){const e=this.parser.json.materials[t];return!e.extensions||!e.extensions[this.name]?null:J}extendMaterialParams(t,s){const e=this.parser,n=e.json.materials[t];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],o=n.extensions[this.name];return o.anisotropyStrength!==void 0&&(s.anisotropy=o.anisotropyStrength),o.anisotropyRotation!==void 0&&(s.anisotropyRotation=o.anisotropyRotation),o.anisotropyTexture!==void 0&&i.push(e.assignTexture(s,"anisotropyMap",o.anisotropyTexture)),Promise.all(i)}}class Nn{constructor(t){this.parser=t,this.name=M.KHR_TEXTURE_BASISU}loadTexture(t){const s=this.parser,e=s.json,n=e.textures[t];if(!n.extensions||!n.extensions[this.name])return null;const i=n.extensions[this.name],o=s.options.ktx2Loader;if(!o){if(e.extensionsRequired&&e.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return s.loadTextureImage(t,i.source,o)}}class Bn{constructor(t){this.parser=t,this.name=M.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(t){const s=this.name,e=this.parser,n=e.json,i=n.textures[t];if(!i.extensions||!i.extensions[s])return null;const o=i.extensions[s],r=n.images[o.source];let a=e.textureLoader;if(r.uri){const c=e.options.manager.getHandler(r.uri);c!==null&&(a=c)}return this.detectSupport().then(function(c){if(c)return e.loadTextureImage(t,o.source,a);if(n.extensionsRequired&&n.extensionsRequired.indexOf(s)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return e.loadTexture(t)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(t){const s=new Image;s.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",s.onload=s.onerror=function(){t(s.height===1)}})),this.isSupported}}class jn{constructor(t){this.parser=t,this.name=M.EXT_TEXTURE_AVIF,this.isSupported=null}loadTexture(t){const s=this.name,e=this.parser,n=e.json,i=n.textures[t];if(!i.extensions||!i.extensions[s])return null;const o=i.extensions[s],r=n.images[o.source];let a=e.textureLoader;if(r.uri){const c=e.options.manager.getHandler(r.uri);c!==null&&(a=c)}return this.detectSupport().then(function(c){if(c)return e.loadTextureImage(t,o.source,a);if(n.extensionsRequired&&n.extensionsRequired.indexOf(s)>=0)throw new Error("THREE.GLTFLoader: AVIF required by asset but unsupported.");return e.loadTexture(t)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(t){const s=new Image;s.src="data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAABcAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQAMAAAAABNjb2xybmNseAACAAIABoAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAAB9tZGF0EgAKCBgABogQEDQgMgkQAAAAB8dSLfI=",s.onload=s.onerror=function(){t(s.height===1)}})),this.isSupported}}class Hn{constructor(t){this.name=M.EXT_MESHOPT_COMPRESSION,this.parser=t}loadBufferView(t){const s=this.parser.json,e=s.bufferViews[t];if(e.extensions&&e.extensions[this.name]){const n=e.extensions[this.name],i=this.parser.getDependency("buffer",n.buffer),o=this.parser.options.meshoptDecoder;if(!o||!o.supported){if(s.extensionsRequired&&s.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return i.then(function(r){const a=n.byteOffset||0,c=n.byteLength||0,l=n.count,h=n.byteStride,u=new Uint8Array(r,a,c);return o.decodeGltfBufferAsync?o.decodeGltfBufferAsync(l,h,u,n.mode,n.filter).then(function(m){return m.buffer}):o.ready.then(function(){const m=new ArrayBuffer(l*h);return o.decodeGltfBuffer(new Uint8Array(m),l,h,u,n.mode,n.filter),m})})}else return null}}class Gn{constructor(t){this.name=M.EXT_MESH_GPU_INSTANCING,this.parser=t}createNodeMesh(t){const s=this.parser.json,e=s.nodes[t];if(!e.extensions||!e.extensions[this.name]||e.mesh===void 0)return null;const n=s.meshes[e.mesh];for(const c of n.primitives)if(c.mode!==N.TRIANGLES&&c.mode!==N.TRIANGLE_STRIP&&c.mode!==N.TRIANGLE_FAN&&c.mode!==void 0)return null;const o=e.extensions[this.name].attributes,r=[],a={};for(const c in o)r.push(this.parser.getDependency("accessor",o[c]).then(l=>(a[c]=l,a[c])));return r.length<1?null:(r.push(this.parser.createNodeMesh(t)),Promise.all(r).then(c=>{const l=c.pop(),h=l.isGroup?l.children:[l],u=c[0].count,m=[];for(const f of h){const g=new Oe,y=new w,b=new Re,E=new w(1,1,1),_=new Ie(f.geometry,f.material,u);for(let T=0;T<u;T++)a.TRANSLATION&&y.fromBufferAttribute(a.TRANSLATION,T),a.ROTATION&&b.fromBufferAttribute(a.ROTATION,T),a.SCALE&&E.fromBufferAttribute(a.SCALE,T),_.setMatrixAt(T,g.compose(y,b,E));for(const T in a)if(T==="_COLOR_0"){const k=a[T];_.instanceColor=new zs(k.array,k.itemSize,k.normalized)}else T!=="TRANSLATION"&&T!=="ROTATION"&&T!=="SCALE"&&f.geometry.setAttribute(T,a[T]);De.prototype.copy.call(_,f),this.parser.assignFinalMaterial(_),m.push(_)}return l.isGroup?(l.clear(),l.add(...m),l):m[0]}))}}const Wt="glTF",ye=12,Nt={JSON:1313821514,BIN:5130562};class Un{constructor(t){this.name=M.KHR_BINARY_GLTF,this.content=null,this.body=null;const s=new DataView(t,0,ye),e=new TextDecoder;if(this.header={magic:e.decode(new Uint8Array(t.slice(0,4))),version:s.getUint32(4,!0),length:s.getUint32(8,!0)},this.header.magic!==Wt)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const n=this.header.length-ye,i=new DataView(t,ye);let o=0;for(;o<n;){const r=i.getUint32(o,!0);o+=4;const a=i.getUint32(o,!0);if(o+=4,a===Nt.JSON){const c=new Uint8Array(t,ye+o,r);this.content=e.decode(c)}else if(a===Nt.BIN){const c=ye+o;this.body=t.slice(c,c+r)}o+=r}if(this.content===null)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class Zn{constructor(t,s){if(!s)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=M.KHR_DRACO_MESH_COMPRESSION,this.json=t,this.dracoLoader=s,this.dracoLoader.preload()}decodePrimitive(t,s){const e=this.json,n=this.dracoLoader,i=t.extensions[this.name].bufferView,o=t.extensions[this.name].attributes,r={},a={},c={};for(const l in o){const h=ot[l]||l.toLowerCase();r[h]=o[l]}for(const l in t.attributes){const h=ot[l]||l.toLowerCase();if(o[l]!==void 0){const u=e.accessors[t.attributes[l]],m=de[u.componentType];c[h]=m.name,a[h]=u.normalized===!0}}return s.getDependency("bufferView",i).then(function(l){return new Promise(function(h,u){n.decodeDracoFile(l,function(m){for(const f in m.attributes){const g=m.attributes[f],y=a[f];y!==void 0&&(g.normalized=y)}h(m)},r,c,K,u)})})}}class Kn{constructor(){this.name=M.KHR_TEXTURE_TRANSFORM}extendTexture(t,s){return(s.texCoord===void 0||s.texCoord===t.channel)&&s.offset===void 0&&s.rotation===void 0&&s.scale===void 0||(t=t.clone(),s.texCoord!==void 0&&(t.channel=s.texCoord),s.offset!==void 0&&t.offset.fromArray(s.offset),s.rotation!==void 0&&(t.rotation=s.rotation),s.scale!==void 0&&t.repeat.fromArray(s.scale),t.needsUpdate=!0),t}}class Yn{constructor(){this.name=M.KHR_MESH_QUANTIZATION}}class Jt extends sn{constructor(t,s,e,n){super(t,s,e,n)}copySampleValue_(t){const s=this.resultBuffer,e=this.sampleValues,n=this.valueSize,i=t*n*3+n;for(let o=0;o!==n;o++)s[o]=e[i+o];return s}interpolate_(t,s,e,n){const i=this.resultBuffer,o=this.sampleValues,r=this.valueSize,a=r*2,c=r*3,l=n-s,h=(e-s)/l,u=h*h,m=u*h,f=t*c,g=f-c,y=-2*m+3*u,b=m-u,E=1-y,_=b-u+h;for(let T=0;T!==r;T++){const k=o[g+T+r],D=o[g+T+a]*l,L=o[f+T+r],G=o[f+T]*l;i[T]=E*k+_*D+y*L+b*G}return i}}const Xn=new Re;class Vn extends Jt{interpolate_(t,s,e,n){const i=super.interpolate_(t,s,e,n);return Xn.fromArray(i).normalize().toArray(i),i}}const N={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},de={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},Bt={9728:Us,9729:ct,9984:Gs,9985:Hs,9986:js,9987:Xt},jt={33071:Ks,33648:Zs,10497:it},qe={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},ot={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},ee={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},qn={CUBICSPLINE:void 0,LINEAR:Vt,STEP:en},We={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};function Wn(p){return p.DefaultMaterial===void 0&&(p.DefaultMaterial=new R({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:Ut})),p.DefaultMaterial}function ie(p,t,s){for(const e in s.extensions)p[e]===void 0&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[e]=s.extensions[e])}function te(p,t){t.extras!==void 0&&(typeof t.extras=="object"?Object.assign(p.userData,t.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+t.extras))}function Jn(p,t,s){let e=!1,n=!1,i=!1;for(let c=0,l=t.length;c<l;c++){const h=t[c];if(h.POSITION!==void 0&&(e=!0),h.NORMAL!==void 0&&(n=!0),h.COLOR_0!==void 0&&(i=!0),e&&n&&i)break}if(!e&&!n&&!i)return Promise.resolve(p);const o=[],r=[],a=[];for(let c=0,l=t.length;c<l;c++){const h=t[c];if(e){const u=h.POSITION!==void 0?s.getDependency("accessor",h.POSITION):p.attributes.position;o.push(u)}if(n){const u=h.NORMAL!==void 0?s.getDependency("accessor",h.NORMAL):p.attributes.normal;r.push(u)}if(i){const u=h.COLOR_0!==void 0?s.getDependency("accessor",h.COLOR_0):p.attributes.color;a.push(u)}}return Promise.all([Promise.all(o),Promise.all(r),Promise.all(a)]).then(function(c){const l=c[0],h=c[1],u=c[2];return e&&(p.morphAttributes.position=l),n&&(p.morphAttributes.normal=h),i&&(p.morphAttributes.color=u),p.morphTargetsRelative=!0,p})}function $n(p,t){if(p.updateMorphTargets(),t.weights!==void 0)for(let s=0,e=t.weights.length;s<e;s++)p.morphTargetInfluences[s]=t.weights[s];if(t.extras&&Array.isArray(t.extras.targetNames)){const s=t.extras.targetNames;if(p.morphTargetInfluences.length===s.length){p.morphTargetDictionary={};for(let e=0,n=s.length;e<n;e++)p.morphTargetDictionary[s[e]]=e}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function Qn(p){let t;const s=p.extensions&&p.extensions[M.KHR_DRACO_MESH_COMPRESSION];if(s?t="draco:"+s.bufferView+":"+s.indices+":"+Je(s.attributes):t=p.indices+":"+Je(p.attributes)+":"+p.mode,p.targets!==void 0)for(let e=0,n=p.targets.length;e<n;e++)t+=":"+Je(p.targets[e]);return t}function Je(p){let t="";const s=Object.keys(p).sort();for(let e=0,n=s.length;e<n;e++)t+=s[e]+":"+p[s[e]]+";";return t}function rt(p){switch(p){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}function ei(p){return p.search(/\.jpe?g($|\?)/i)>0||p.search(/^data\:image\/jpeg/)===0?"image/jpeg":p.search(/\.webp($|\?)/i)>0||p.search(/^data\:image\/webp/)===0?"image/webp":"image/png"}const ti=new Oe;class si{constructor(t={},s={}){this.json=t,this.extensions={},this.plugins={},this.options=s,this.cache=new vn,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let e=!1,n=!1,i=-1;typeof navigator<"u"&&(e=/^((?!chrome|android).)*safari/i.test(navigator.userAgent)===!0,n=navigator.userAgent.indexOf("Firefox")>-1,i=n?navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1]:-1),typeof createImageBitmap>"u"||e||n&&i<98?this.textureLoader=new Yt(this.options.manager):this.textureLoader=new Ns(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new Fe(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),this.options.crossOrigin==="use-credentials"&&this.fileLoader.setWithCredentials(!0)}setExtensions(t){this.extensions=t}setPlugins(t){this.plugins=t}parse(t,s){const e=this,n=this.json,i=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll(function(o){return o._markDefs&&o._markDefs()}),Promise.all(this._invokeAll(function(o){return o.beforeRoot&&o.beforeRoot()})).then(function(){return Promise.all([e.getDependencies("scene"),e.getDependencies("animation"),e.getDependencies("camera")])}).then(function(o){const r={scene:o[0][n.scene||0],scenes:o[0],animations:o[1],cameras:o[2],asset:n.asset,parser:e,userData:{}};return ie(i,r,n),te(r,n),Promise.all(e._invokeAll(function(a){return a.afterRoot&&a.afterRoot(r)})).then(function(){t(r)})}).catch(s)}_markDefs(){const t=this.json.nodes||[],s=this.json.skins||[],e=this.json.meshes||[];for(let n=0,i=s.length;n<i;n++){const o=s[n].joints;for(let r=0,a=o.length;r<a;r++)t[o[r]].isBone=!0}for(let n=0,i=t.length;n<i;n++){const o=t[n];o.mesh!==void 0&&(this._addNodeRef(this.meshCache,o.mesh),o.skin!==void 0&&(e[o.mesh].isSkinnedMesh=!0)),o.camera!==void 0&&this._addNodeRef(this.cameraCache,o.camera)}}_addNodeRef(t,s){s!==void 0&&(t.refs[s]===void 0&&(t.refs[s]=t.uses[s]=0),t.refs[s]++)}_getNodeRef(t,s,e){if(t.refs[s]<=1)return e;const n=e.clone(),i=(o,r)=>{const a=this.associations.get(o);a!=null&&this.associations.set(r,a);for(const[c,l]of o.children.entries())i(l,r.children[c])};return i(e,n),n.name+="_instance_"+t.uses[s]++,n}_invokeOne(t){const s=Object.values(this.plugins);s.push(this);for(let e=0;e<s.length;e++){const n=t(s[e]);if(n)return n}return null}_invokeAll(t){const s=Object.values(this.plugins);s.unshift(this);const e=[];for(let n=0;n<s.length;n++){const i=t(s[n]);i&&e.push(i)}return e}getDependency(t,s){const e=t+":"+s;let n=this.cache.get(e);if(!n){switch(t){case"scene":n=this.loadScene(s);break;case"node":n=this._invokeOne(function(i){return i.loadNode&&i.loadNode(s)});break;case"mesh":n=this._invokeOne(function(i){return i.loadMesh&&i.loadMesh(s)});break;case"accessor":n=this.loadAccessor(s);break;case"bufferView":n=this._invokeOne(function(i){return i.loadBufferView&&i.loadBufferView(s)});break;case"buffer":n=this.loadBuffer(s);break;case"material":n=this._invokeOne(function(i){return i.loadMaterial&&i.loadMaterial(s)});break;case"texture":n=this._invokeOne(function(i){return i.loadTexture&&i.loadTexture(s)});break;case"skin":n=this.loadSkin(s);break;case"animation":n=this._invokeOne(function(i){return i.loadAnimation&&i.loadAnimation(s)});break;case"camera":n=this.loadCamera(s);break;default:if(n=this._invokeOne(function(i){return i!=this&&i.getDependency&&i.getDependency(t,s)}),!n)throw new Error("Unknown type: "+t);break}this.cache.add(e,n)}return n}getDependencies(t){let s=this.cache.get(t);if(!s){const e=this,n=this.json[t+(t==="mesh"?"es":"s")]||[];s=Promise.all(n.map(function(i,o){return e.getDependency(t,o)})),this.cache.add(t,s)}return s}loadBuffer(t){const s=this.json.buffers[t],e=this.fileLoader;if(s.type&&s.type!=="arraybuffer")throw new Error("THREE.GLTFLoader: "+s.type+" buffer type is not supported.");if(s.uri===void 0&&t===0)return Promise.resolve(this.extensions[M.KHR_BINARY_GLTF].body);const n=this.options;return new Promise(function(i,o){e.load(Ae.resolveURL(s.uri,n.path),i,void 0,function(){o(new Error('THREE.GLTFLoader: Failed to load buffer "'+s.uri+'".'))})})}loadBufferView(t){const s=this.json.bufferViews[t];return this.getDependency("buffer",s.buffer).then(function(e){const n=s.byteLength||0,i=s.byteOffset||0;return e.slice(i,i+n)})}loadAccessor(t){const s=this,e=this.json,n=this.json.accessors[t];if(n.bufferView===void 0&&n.sparse===void 0){const o=qe[n.type],r=de[n.componentType],a=n.normalized===!0,c=new r(n.count*o);return Promise.resolve(new se(c,o,a))}const i=[];return n.bufferView!==void 0?i.push(this.getDependency("bufferView",n.bufferView)):i.push(null),n.sparse!==void 0&&(i.push(this.getDependency("bufferView",n.sparse.indices.bufferView)),i.push(this.getDependency("bufferView",n.sparse.values.bufferView))),Promise.all(i).then(function(o){const r=o[0],a=qe[n.type],c=de[n.componentType],l=c.BYTES_PER_ELEMENT,h=l*a,u=n.byteOffset||0,m=n.bufferView!==void 0?e.bufferViews[n.bufferView].byteStride:void 0,f=n.normalized===!0;let g,y;if(m&&m!==h){const b=Math.floor(u/m),E="InterleavedBuffer:"+n.bufferView+":"+n.componentType+":"+b+":"+n.count;let _=s.cache.get(E);_||(g=new c(r,b*m,n.count*m/l),_=new Bs(g,m/l),s.cache.add(E,_)),y=new tn(_,a,u%m/l,f)}else r===null?g=new c(n.count*a):g=new c(r,u,n.count*a),y=new se(g,a,f);if(n.sparse!==void 0){const b=qe.SCALAR,E=de[n.sparse.indices.componentType],_=n.sparse.indices.byteOffset||0,T=n.sparse.values.byteOffset||0,k=new E(o[1],_,n.sparse.count*b),D=new c(o[2],T,n.sparse.count*a);r!==null&&(y=new se(y.array.slice(),y.itemSize,y.normalized));for(let L=0,G=k.length;L<G;L++){const O=k[L];if(y.setX(O,D[L*a]),a>=2&&y.setY(O,D[L*a+1]),a>=3&&y.setZ(O,D[L*a+2]),a>=4&&y.setW(O,D[L*a+3]),a>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return y})}loadTexture(t){const s=this.json,e=this.options,i=s.textures[t].source,o=s.images[i];let r=this.textureLoader;if(o.uri){const a=e.manager.getHandler(o.uri);a!==null&&(r=a)}return this.loadTextureImage(t,i,r)}loadTextureImage(t,s,e){const n=this,i=this.json,o=i.textures[t],r=i.images[s],a=(r.uri||r.bufferView)+":"+o.sampler;if(this.textureCache[a])return this.textureCache[a];const c=this.loadImageSource(s,e).then(function(l){l.flipY=!1,l.name=o.name||r.name||"",l.name===""&&typeof r.uri=="string"&&r.uri.startsWith("data:image/")===!1&&(l.name=r.uri);const u=(i.samplers||{})[o.sampler]||{};return l.magFilter=Bt[u.magFilter]||ct,l.minFilter=Bt[u.minFilter]||Xt,l.wrapS=jt[u.wrapS]||it,l.wrapT=jt[u.wrapT]||it,n.associations.set(l,{textures:t}),l}).catch(function(){return null});return this.textureCache[a]=c,c}loadImageSource(t,s){const e=this,n=this.json,i=this.options;if(this.sourceCache[t]!==void 0)return this.sourceCache[t].then(h=>h.clone());const o=n.images[t],r=self.URL||self.webkitURL;let a=o.uri||"",c=!1;if(o.bufferView!==void 0)a=e.getDependency("bufferView",o.bufferView).then(function(h){c=!0;const u=new Blob([h],{type:o.mimeType});return a=r.createObjectURL(u),a});else if(o.uri===void 0)throw new Error("THREE.GLTFLoader: Image "+t+" is missing URI and bufferView");const l=Promise.resolve(a).then(function(h){return new Promise(function(u,m){let f=u;s.isImageBitmapLoader===!0&&(f=function(g){const y=new St(g);y.needsUpdate=!0,u(y)}),s.load(Ae.resolveURL(h,i.path),f,void 0,m)})}).then(function(h){return c===!0&&r.revokeObjectURL(a),h.userData.mimeType=o.mimeType||ei(o.uri),h}).catch(function(h){throw console.error("THREE.GLTFLoader: Couldn't load texture",a),h});return this.sourceCache[t]=l,l}assignTexture(t,s,e,n){const i=this;return this.getDependency("texture",e.index).then(function(o){if(!o)return null;if(e.texCoord!==void 0&&e.texCoord>0&&(o=o.clone(),o.channel=e.texCoord),i.extensions[M.KHR_TEXTURE_TRANSFORM]){const r=e.extensions!==void 0?e.extensions[M.KHR_TEXTURE_TRANSFORM]:void 0;if(r){const a=i.associations.get(o);o=i.extensions[M.KHR_TEXTURE_TRANSFORM].extendTexture(o,r),i.associations.set(o,a)}}return n!==void 0&&(o.colorSpace=n),t[s]=o,o})}assignFinalMaterial(t){const s=t.geometry;let e=t.material;const n=s.attributes.tangent===void 0,i=s.attributes.color!==void 0,o=s.attributes.normal===void 0;if(t.isPoints){const r="PointsMaterial:"+e.uuid;let a=this.cache.get(r);a||(a=new st,Ye.prototype.copy.call(a,e),a.color.copy(e.color),a.map=e.map,a.sizeAttenuation=!1,this.cache.add(r,a)),e=a}else if(t.isLine){const r="LineBasicMaterial:"+e.uuid;let a=this.cache.get(r);a||(a=new Se,Ye.prototype.copy.call(a,e),a.color.copy(e.color),a.map=e.map,this.cache.add(r,a)),e=a}if(n||i||o){let r="ClonedMaterial:"+e.uuid+":";n&&(r+="derivative-tangents:"),i&&(r+="vertex-colors:"),o&&(r+="flat-shading:");let a=this.cache.get(r);a||(a=e.clone(),i&&(a.vertexColors=!0),o&&(a.flatShading=!0),n&&(a.normalScale&&(a.normalScale.y*=-1),a.clearcoatNormalScale&&(a.clearcoatNormalScale.y*=-1)),this.cache.add(r,a),this.associations.set(a,this.associations.get(e))),e=a}t.material=e}getMaterialType(){return R}loadMaterial(t){const s=this,e=this.json,n=this.extensions,i=e.materials[t];let o;const r={},a=i.extensions||{},c=[];if(a[M.KHR_MATERIALS_UNLIT]){const h=n[M.KHR_MATERIALS_UNLIT];o=h.getMaterialType(),c.push(h.extendParams(r,i,s))}else{const h=i.pbrMetallicRoughness||{};if(r.color=new B(1,1,1),r.opacity=1,Array.isArray(h.baseColorFactor)){const u=h.baseColorFactor;r.color.setRGB(u[0],u[1],u[2],K),r.opacity=u[3]}h.baseColorTexture!==void 0&&c.push(s.assignTexture(r,"map",h.baseColorTexture,ne)),r.metalness=h.metallicFactor!==void 0?h.metallicFactor:1,r.roughness=h.roughnessFactor!==void 0?h.roughnessFactor:1,h.metallicRoughnessTexture!==void 0&&(c.push(s.assignTexture(r,"metalnessMap",h.metallicRoughnessTexture)),c.push(s.assignTexture(r,"roughnessMap",h.metallicRoughnessTexture))),o=this._invokeOne(function(u){return u.getMaterialType&&u.getMaterialType(t)}),c.push(Promise.all(this._invokeAll(function(u){return u.extendMaterialParams&&u.extendMaterialParams(t,r)})))}i.doubleSided===!0&&(r.side=V);const l=i.alphaMode||We.OPAQUE;if(l===We.BLEND?(r.transparent=!0,r.depthWrite=!1):(r.transparent=!1,l===We.MASK&&(r.alphaTest=i.alphaCutoff!==void 0?i.alphaCutoff:.5)),i.normalTexture!==void 0&&o!==S&&(c.push(s.assignTexture(r,"normalMap",i.normalTexture)),r.normalScale=new F(1,1),i.normalTexture.scale!==void 0)){const h=i.normalTexture.scale;r.normalScale.set(h,h)}if(i.occlusionTexture!==void 0&&o!==S&&(c.push(s.assignTexture(r,"aoMap",i.occlusionTexture)),i.occlusionTexture.strength!==void 0&&(r.aoMapIntensity=i.occlusionTexture.strength)),i.emissiveFactor!==void 0&&o!==S){const h=i.emissiveFactor;r.emissive=new B().setRGB(h[0],h[1],h[2],K)}return i.emissiveTexture!==void 0&&o!==S&&c.push(s.assignTexture(r,"emissiveMap",i.emissiveTexture,ne)),Promise.all(c).then(function(){const h=new o(r);return i.name&&(h.name=i.name),te(h,i),s.associations.set(h,{materials:t}),i.extensions&&ie(n,h,i),h})}createUniqueName(t){const s=Ys.sanitizeNodeName(t||"");return s in this.nodeNamesUsed?s+"_"+ ++this.nodeNamesUsed[s]:(this.nodeNamesUsed[s]=0,s)}loadGeometries(t){const s=this,e=this.extensions,n=this.primitiveCache;function i(r){return e[M.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(r,s).then(function(a){return Ht(a,r,s)})}const o=[];for(let r=0,a=t.length;r<a;r++){const c=t[r],l=Qn(c),h=n[l];if(h)o.push(h.promise);else{let u;c.extensions&&c.extensions[M.KHR_DRACO_MESH_COMPRESSION]?u=i(c):u=Ht(new oe,c,s),n[l]={primitive:c,promise:u},o.push(u)}}return Promise.all(o)}loadMesh(t){const s=this,e=this.json,n=this.extensions,i=e.meshes[t],o=i.primitives,r=[];for(let a=0,c=o.length;a<c;a++){const l=o[a].material===void 0?Wn(this.cache):this.getDependency("material",o[a].material);r.push(l)}return r.push(s.loadGeometries(o)),Promise.all(r).then(function(a){const c=a.slice(0,a.length-1),l=a[a.length-1],h=[];for(let m=0,f=l.length;m<f;m++){const g=l[m],y=o[m];let b;const E=c[m];if(y.mode===N.TRIANGLES||y.mode===N.TRIANGLE_STRIP||y.mode===N.TRIANGLE_FAN||y.mode===void 0)b=i.isSkinnedMesh===!0?new Xs(g,E):new x(g,E),b.isSkinnedMesh===!0&&b.normalizeSkinWeights(),y.mode===N.TRIANGLE_STRIP?b.geometry=zt(b.geometry,Zt):y.mode===N.TRIANGLE_FAN&&(b.geometry=zt(b.geometry,nt));else if(y.mode===N.LINES)b=new Vs(g,E);else if(y.mode===N.LINE_STRIP)b=new ke(g,E);else if(y.mode===N.LINE_LOOP)b=new qs(g,E);else if(y.mode===N.POINTS)b=new tt(g,E);else throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+y.mode);Object.keys(b.geometry.morphAttributes).length>0&&$n(b,i),b.name=s.createUniqueName(i.name||"mesh_"+t),te(b,i),y.extensions&&ie(n,b,y),s.assignFinalMaterial(b),h.push(b)}for(let m=0,f=h.length;m<f;m++)s.associations.set(h[m],{meshes:t,primitives:m});if(h.length===1)return i.extensions&&ie(n,h[0],i),h[0];const u=new W;i.extensions&&ie(n,u,i),s.associations.set(u,{meshes:t});for(let m=0,f=h.length;m<f;m++)u.add(h[m]);return u})}loadCamera(t){let s;const e=this.json.cameras[t],n=e[e.type];if(!n){console.warn("THREE.GLTFLoader: Missing camera parameters.");return}return e.type==="perspective"?s=new Gt(at.radToDeg(n.yfov),n.aspectRatio||1,n.znear||1,n.zfar||2e6):e.type==="orthographic"&&(s=new Ws(-n.xmag,n.xmag,n.ymag,-n.ymag,n.znear,n.zfar)),e.name&&(s.name=this.createUniqueName(e.name)),te(s,e),Promise.resolve(s)}loadSkin(t){const s=this.json.skins[t],e=[];for(let n=0,i=s.joints.length;n<i;n++)e.push(this._loadNodeShallow(s.joints[n]));return s.inverseBindMatrices!==void 0?e.push(this.getDependency("accessor",s.inverseBindMatrices)):e.push(null),Promise.all(e).then(function(n){const i=n.pop(),o=n,r=[],a=[];for(let c=0,l=o.length;c<l;c++){const h=o[c];if(h){r.push(h);const u=new Oe;i!==null&&u.fromArray(i.array,c*16),a.push(u)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',s.joints[c])}return new Js(r,a)})}loadAnimation(t){const s=this.json,e=this,n=s.animations[t],i=n.name?n.name:"animation_"+t,o=[],r=[],a=[],c=[],l=[];for(let h=0,u=n.channels.length;h<u;h++){const m=n.channels[h],f=n.samplers[m.sampler],g=m.target,y=g.node,b=n.parameters!==void 0?n.parameters[f.input]:f.input,E=n.parameters!==void 0?n.parameters[f.output]:f.output;g.node!==void 0&&(o.push(this.getDependency("node",y)),r.push(this.getDependency("accessor",b)),a.push(this.getDependency("accessor",E)),c.push(f),l.push(g))}return Promise.all([Promise.all(o),Promise.all(r),Promise.all(a),Promise.all(c),Promise.all(l)]).then(function(h){const u=h[0],m=h[1],f=h[2],g=h[3],y=h[4],b=[];for(let E=0,_=u.length;E<_;E++){const T=u[E],k=m[E],D=f[E],L=g[E],G=y[E];if(T===void 0)continue;T.updateMatrix&&T.updateMatrix();const O=e._createAnimationTracks(T,k,D,L,G);if(O)for(let ue=0;ue<O.length;ue++)b.push(O[ue])}return new $s(i,void 0,b)})}createNodeMesh(t){const s=this.json,e=this,n=s.nodes[t];return n.mesh===void 0?null:e.getDependency("mesh",n.mesh).then(function(i){const o=e._getNodeRef(e.meshCache,n.mesh,i);return n.weights!==void 0&&o.traverse(function(r){if(r.isMesh)for(let a=0,c=n.weights.length;a<c;a++)r.morphTargetInfluences[a]=n.weights[a]}),o})}loadNode(t){const s=this.json,e=this,n=s.nodes[t],i=e._loadNodeShallow(t),o=[],r=n.children||[];for(let c=0,l=r.length;c<l;c++)o.push(e.getDependency("node",r[c]));const a=n.skin===void 0?Promise.resolve(null):e.getDependency("skin",n.skin);return Promise.all([i,Promise.all(o),a]).then(function(c){const l=c[0],h=c[1],u=c[2];u!==null&&l.traverse(function(m){m.isSkinnedMesh&&m.bind(u,ti)});for(let m=0,f=h.length;m<f;m++)l.add(h[m]);return l})}_loadNodeShallow(t){const s=this.json,e=this.extensions,n=this;if(this.nodeCache[t]!==void 0)return this.nodeCache[t];const i=s.nodes[t],o=i.name?n.createUniqueName(i.name):"",r=[],a=n._invokeOne(function(c){return c.createNodeMesh&&c.createNodeMesh(t)});return a&&r.push(a),i.camera!==void 0&&r.push(n.getDependency("camera",i.camera).then(function(c){return n._getNodeRef(n.cameraCache,i.camera,c)})),n._invokeAll(function(c){return c.createNodeAttachment&&c.createNodeAttachment(t)}).forEach(function(c){r.push(c)}),this.nodeCache[t]=Promise.all(r).then(function(c){let l;if(i.isBone===!0?l=new Qs:c.length>1?l=new W:c.length===1?l=c[0]:l=new De,l!==c[0])for(let h=0,u=c.length;h<u;h++)l.add(c[h]);if(i.name&&(l.userData.name=i.name,l.name=o),te(l,i),i.extensions&&ie(e,l,i),i.matrix!==void 0){const h=new Oe;h.fromArray(i.matrix),l.applyMatrix4(h)}else i.translation!==void 0&&l.position.fromArray(i.translation),i.rotation!==void 0&&l.quaternion.fromArray(i.rotation),i.scale!==void 0&&l.scale.fromArray(i.scale);return n.associations.has(l)||n.associations.set(l,{}),n.associations.get(l).nodes=t,l}),this.nodeCache[t]}loadScene(t){const s=this.extensions,e=this.json.scenes[t],n=this,i=new W;e.name&&(i.name=n.createUniqueName(e.name)),te(i,e),e.extensions&&ie(s,i,e);const o=e.nodes||[],r=[];for(let a=0,c=o.length;a<c;a++)r.push(n.getDependency("node",o[a]));return Promise.all(r).then(function(a){for(let l=0,h=a.length;l<h;l++)i.add(a[l]);const c=l=>{const h=new Map;for(const[u,m]of n.associations)(u instanceof Ye||u instanceof St)&&h.set(u,m);return l.traverse(u=>{const m=n.associations.get(u);m!=null&&h.set(u,m)}),h};return n.associations=c(i),i})}_createAnimationTracks(t,s,e,n,i){const o=[],r=t.name?t.name:t.uuid,a=[];ee[i.path]===ee.weights?t.traverse(function(u){u.morphTargetInfluences&&a.push(u.name?u.name:u.uuid)}):a.push(r);let c;switch(ee[i.path]){case ee.weights:c=It;break;case ee.rotation:c=Ct;break;case ee.position:case ee.scale:c=kt;break;default:switch(e.itemSize){case 1:c=It;break;case 2:case 3:default:c=kt;break}break}const l=n.interpolation!==void 0?qn[n.interpolation]:Vt,h=this._getArrayFromAccessor(e);for(let u=0,m=a.length;u<m;u++){const f=new c(a[u]+"."+ee[i.path],s.array,h,l);n.interpolation==="CUBICSPLINE"&&this._createCubicSplineTrackInterpolant(f),o.push(f)}return o}_getArrayFromAccessor(t){let s=t.array;if(t.normalized){const e=rt(s.constructor),n=new Float32Array(s.length);for(let i=0,o=s.length;i<o;i++)n[i]=s[i]*e;s=n}return s}_createCubicSplineTrackInterpolant(t){t.createInterpolant=function(e){const n=this instanceof Ct?Vn:Jt;return new n(this.times,this.values,this.getValueSize()/3,e)},t.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function ni(p,t,s){const e=t.attributes,n=new be;if(e.POSITION!==void 0){const r=s.json.accessors[e.POSITION],a=r.min,c=r.max;if(a!==void 0&&c!==void 0){if(n.set(new w(a[0],a[1],a[2]),new w(c[0],c[1],c[2])),r.normalized){const l=rt(de[r.componentType]);n.min.multiplyScalar(l),n.max.multiplyScalar(l)}}else{console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");return}}else return;const i=t.targets;if(i!==void 0){const r=new w,a=new w;for(let c=0,l=i.length;c<l;c++){const h=i[c];if(h.POSITION!==void 0){const u=s.json.accessors[h.POSITION],m=u.min,f=u.max;if(m!==void 0&&f!==void 0){if(a.setX(Math.max(Math.abs(m[0]),Math.abs(f[0]))),a.setY(Math.max(Math.abs(m[1]),Math.abs(f[1]))),a.setZ(Math.max(Math.abs(m[2]),Math.abs(f[2]))),u.normalized){const g=rt(de[u.componentType]);a.multiplyScalar(g)}r.max(a)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}n.expandByVector(r)}p.boundingBox=n;const o=new nn;n.getCenter(o.center),o.radius=n.min.distanceTo(n.max)/2,p.boundingSphere=o}function Ht(p,t,s){const e=t.attributes,n=[];function i(o,r){return s.getDependency("accessor",o).then(function(a){p.setAttribute(r,a)})}for(const o in e){const r=ot[o]||o.toLowerCase();r in p.attributes||n.push(i(e[o],r))}if(t.indices!==void 0&&!p.index){const o=s.getDependency("accessor",t.indices).then(function(r){p.setIndex(r)});n.push(o)}return Rt.workingColorSpace!==K&&"COLOR_0"in e&&console.warn(`THREE.GLTFLoader: Converting vertex colors from "srgb-linear" to "${Rt.workingColorSpace}" not supported.`),te(p,t),ni(p,t,s),Promise.all(n).then(function(){return t.targets!==void 0?Jn(p,t.targets,s):p})}const $e=new WeakMap;class $t extends Kt{constructor(t){super(t),this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}}setDecoderPath(t){return this.decoderPath=t,this}setDecoderConfig(t){return this.decoderConfig=t,this}setWorkerLimit(t){return this.workerLimit=t,this}load(t,s,e,n){const i=new Fe(this.manager);i.setPath(this.path),i.setResponseType("arraybuffer"),i.setRequestHeader(this.requestHeader),i.setWithCredentials(this.withCredentials),i.load(t,o=>{this.parse(o,s,n)},e,n)}parse(t,s,e=()=>{}){this.decodeDracoFile(t,s,null,null,ne).catch(e)}decodeDracoFile(t,s,e,n,i=K,o=()=>{}){const r={attributeIDs:e||this.defaultAttributeIDs,attributeTypes:n||this.defaultAttributeTypes,useUniqueIDs:!!e,vertexColorSpace:i};return this.decodeGeometry(t,r).then(s).catch(o)}decodeGeometry(t,s){const e=JSON.stringify(s);if($e.has(t)){const a=$e.get(t);if(a.key===e)return a.promise;if(t.byteLength===0)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}let n;const i=this.workerNextTaskID++,o=t.byteLength,r=this._getWorker(i,o).then(a=>(n=a,new Promise((c,l)=>{n._callbacks[i]={resolve:c,reject:l},n.postMessage({type:"decode",id:i,taskConfig:s,buffer:t},[t])}))).then(a=>this._createGeometry(a.geometry));return r.catch(()=>!0).then(()=>{n&&i&&this._releaseTask(n,i)}),$e.set(t,{key:e,promise:r}),r}_createGeometry(t){const s=new oe;t.index&&s.setIndex(new se(t.index.array,1));for(let e=0;e<t.attributes.length;e++){const n=t.attributes[e],i=n.name,o=n.array,r=n.itemSize,a=new se(o,r);i==="color"&&(this._assignVertexColorSpace(a,n.vertexColorSpace),a.normalized=!(o instanceof Float32Array)),s.setAttribute(i,a)}return s}_assignVertexColorSpace(t,s){if(s!==ne)return;const e=new B;for(let n=0,i=t.count;n<i;n++)e.fromBufferAttribute(t,n).convertSRGBToLinear(),t.setXYZ(n,e.r,e.g,e.b)}_loadLibrary(t,s){const e=new Fe(this.manager);return e.setPath(this.decoderPath),e.setResponseType(s),e.setWithCredentials(this.withCredentials),new Promise((n,i)=>{e.load(t,n,void 0,i)})}preload(){return this._initDecoder(),this}_initDecoder(){if(this.decoderPending)return this.decoderPending;const t=typeof WebAssembly!="object"||this.decoderConfig.type==="js",s=[];return t?s.push(this._loadLibrary("draco_decoder.js","text")):(s.push(this._loadLibrary("draco_wasm_wrapper.js","text")),s.push(this._loadLibrary("draco_decoder.wasm","arraybuffer"))),this.decoderPending=Promise.all(s).then(e=>{const n=e[0];t||(this.decoderConfig.wasmBinary=e[1]);const i=ii.toString(),o=["/* draco decoder */",n,"","/* worker */",i.substring(i.indexOf("{")+1,i.lastIndexOf("}"))].join(`
`);this.workerSourceURL=URL.createObjectURL(new Blob([o]))}),this.decoderPending}_getWorker(t,s){return this._initDecoder().then(()=>{if(this.workerPool.length<this.workerLimit){const n=new Worker(this.workerSourceURL);n._callbacks={},n._taskCosts={},n._taskLoad=0,n.postMessage({type:"init",decoderConfig:this.decoderConfig}),n.onmessage=function(i){const o=i.data;switch(o.type){case"decode":n._callbacks[o.id].resolve(o);break;case"error":n._callbacks[o.id].reject(o);break;default:console.error('THREE.DRACOLoader: Unexpected message, "'+o.type+'"')}},this.workerPool.push(n)}else this.workerPool.sort(function(n,i){return n._taskLoad>i._taskLoad?-1:1});const e=this.workerPool[this.workerPool.length-1];return e._taskCosts[t]=s,e._taskLoad+=s,e})}_releaseTask(t,s){t._taskLoad-=t._taskCosts[s],delete t._callbacks[s],delete t._taskCosts[s]}debug(){console.log("Task load: ",this.workerPool.map(t=>t._taskLoad))}dispose(){for(let t=0;t<this.workerPool.length;++t)this.workerPool[t].terminate();return this.workerPool.length=0,this.workerSourceURL!==""&&URL.revokeObjectURL(this.workerSourceURL),this}}function ii(){let p,t;onmessage=function(o){const r=o.data;switch(r.type){case"init":p=r.decoderConfig,t=new Promise(function(l){p.onModuleLoaded=function(h){l({draco:h})},DracoDecoderModule(p)});break;case"decode":const a=r.buffer,c=r.taskConfig;t.then(l=>{const h=l.draco,u=new h.Decoder;try{const m=s(h,u,new Int8Array(a),c),f=m.attributes.map(g=>g.array.buffer);m.index&&f.push(m.index.array.buffer),self.postMessage({type:"decode",id:r.id,geometry:m},f)}catch(m){console.error(m),self.postMessage({type:"error",id:r.id,error:m.message})}finally{h.destroy(u)}});break}};function s(o,r,a,c){const l=c.attributeIDs,h=c.attributeTypes;let u,m;const f=r.GetEncodedGeometryType(a);if(f===o.TRIANGULAR_MESH)u=new o.Mesh,m=r.DecodeArrayToMesh(a,a.byteLength,u);else if(f===o.POINT_CLOUD)u=new o.PointCloud,m=r.DecodeArrayToPointCloud(a,a.byteLength,u);else throw new Error("THREE.DRACOLoader: Unexpected geometry type.");if(!m.ok()||u.ptr===0)throw new Error("THREE.DRACOLoader: Decoding failed: "+m.error_msg());const g={index:null,attributes:[]};for(const y in l){const b=self[h[y]];let E,_;if(c.useUniqueIDs)_=l[y],E=r.GetAttributeByUniqueId(u,_);else{if(_=r.GetAttributeId(u,o[l[y]]),_===-1)continue;E=r.GetAttribute(u,_)}const T=n(o,r,u,y,b,E);y==="color"&&(T.vertexColorSpace=c.vertexColorSpace),g.attributes.push(T)}return f===o.TRIANGULAR_MESH&&(g.index=e(o,r,u)),o.destroy(u),g}function e(o,r,a){const l=a.num_faces()*3,h=l*4,u=o._malloc(h);r.GetTrianglesUInt32Array(a,h,u);const m=new Uint32Array(o.HEAPF32.buffer,u,l).slice();return o._free(u),{array:m,itemSize:1}}function n(o,r,a,c,l,h){const u=h.num_components(),f=a.num_points()*u,g=f*l.BYTES_PER_ELEMENT,y=i(o,l),b=o._malloc(g);r.GetAttributeDataArrayForAllPoints(a,h,y,g,b);const E=new l(o.HEAPF32.buffer,b,f).slice();return o._free(b),{name:c,array:E,itemSize:u}}function i(o,r){switch(r){case Float32Array:return o.DT_FLOAT32;case Int8Array:return o.DT_INT8;case Int16Array:return o.DT_INT16;case Int32Array:return o.DT_INT32;case Uint8Array:return o.DT_UINT8;case Uint16Array:return o.DT_UINT16;case Uint32Array:return o.DT_UINT32}}}class oi{constructor(){this.experience=new j,this.scene=this.experience.scene,this.resources=this.experience.resources,this.physics=this.experience.physics,this.activeMode="test",this.activeEnvironment=null,this.forestModel=null,this.forestLoading=!1,this.currentZone=null,this.visitedZones=new Set(["HUB"]),this.environment=new An,this.player=new En,this.createTestEnvironment(),this._onToggle=()=>this.toggleEnvironment(),window.addEventListener("toggleEnvironment",this._onToggle)}createTestEnvironment(){this.disposeCurrentEnvironment(),this.activeMode="test",this.activeEnvironment=new Mn,this.player.teleport({x:0,y:2,z:5}),console.log("üß™ Switched to Test Environment"),this.updateToggleUI()}createForestEnvironment(){var n;if(this.forestLoading){console.warn("‚ö†Ô∏è Forest GLB still loading...");return}if(this.forestModel){this._switchToForest();return}this.forestLoading=!0,console.log("üå≥ Loading forest GLB..."),(n=this.experience.uiManager)==null||n.notify("Loading forest environment...","info",5e3);const t=new qt,s=new $t;s.setDecoderPath("/portfolio-3js/draco/"),t.setDRACOLoader(s),t.load("models/environment/free_low_poly_forest.glb",i=>{this.forestModel=i,this.resources.items.forestEnvironment=i,this.forestLoading=!1,console.log("‚úÖ Forest GLB loaded"),this._switchToForest(),s.dispose()},i=>{if(i.lengthComputable){const o=Math.round(i.loaded/i.total*100);console.log(`üå≥ Forest loading: ${o}%`)}},i=>{var o;this.forestLoading=!1,console.error("‚ùå Failed to load forest GLB",i),(o=this.experience.uiManager)==null||o.notify("Failed to load forest","error"),s.dispose()})}_switchToForest(){this.disposeCurrentEnvironment(),this.activeMode="forest",this.activeEnvironment=new Tn,this.player.teleport({x:0,y:2,z:5}),console.log("üå≥ Switched to Forest Environment"),this.updateToggleUI()}toggleEnvironment(){this.activeMode==="test"?this.createForestEnvironment():this.createTestEnvironment()}disposeCurrentEnvironment(){this.activeEnvironment&&(this.activeEnvironment.dispose(),this.activeEnvironment=null),this.currentZone=null}updateToggleUI(){window.dispatchEvent(new CustomEvent("environmentChanged",{detail:{mode:this.activeMode}}))}update(t){if(this.player&&(this.player.update(),this.activeEnvironment&&this.activeEnvironment.getZoneAtPosition)){const s=this.player.mesh.position,e=this.activeEnvironment.getZoneAtPosition(s);e&&e.id!==this.currentZone?this.onZoneEnter(e):!e&&this.currentZone&&this.onZoneExit()}this.activeEnvironment&&this.activeEnvironment.update(t)}onZoneEnter(t){const s=!this.visitedZones.has(t.id);this.currentZone=t.id,this.visitedZones.add(t.id),console.log(`üìç Entered: ${t.name}`),window.dispatchEvent(new CustomEvent("zoneChange",{detail:{zoneId:t.id,zoneName:t.name,firstVisit:s}}))}onZoneExit(){console.log(`üìç Left zone: ${this.currentZone}`),this.currentZone=null,window.dispatchEvent(new CustomEvent("zoneChange",{detail:{zoneId:null}}))}teleportToZone(t){var s;if((s=this.activeEnvironment)!=null&&s.getZoneSpawnPoint&&this.player){const e=this.activeEnvironment.getZoneSpawnPoint(t);this.player.teleport(e)}}destroy(){var t;this.disposeCurrentEnvironment(),(t=this.player)==null||t.dispose(),window.removeEventListener("toggleEnvironment",this._onToggle)}}class ri extends lt{constructor(t){super(),this.sources=t,this.items={},this.toLoad=this.sources.length,this.loaded=0,this.setLoaders(),this.startLoading()}setLoaders(){this.loaders={},this.loaders.textureLoader=new Yt,this.loaders.cubeTextureLoader=new on,this.loaders.gltfLoader=new qt,this.loaders.dracoLoader=new $t,this.loaders.dracoLoader.setDecoderPath("/portfolio-3js/draco/"),this.loaders.gltfLoader.setDRACOLoader(this.loaders.dracoLoader)}startLoading(){if(this.toLoad===0){setTimeout(()=>{this.trigger("ready")},100);return}const t=document.getElementById("loading-bar-fill"),s=document.querySelector(".loading-text"),e=()=>{const o=this.loaded/this.toLoad*100;t&&(t.style.width=`${o}%`)},n=(o,r)=>{console.error(`‚ùå Failed to load ${o.type}: ${o.path}`,r),s&&(s.textContent=`Error loading ${o.name}...`),this.sourceLoaded(o,null),e()},i=(o,r)=>{if(r.lengthComputable&&s){const a=(r.loaded/1048576).toFixed(1);s.textContent=`Loading ${o.name}... ${a}MB`}};for(const o of this.sources)switch(o.type){case"gltfModel":this.loaders.gltfLoader.load(o.path,r=>{this.sourceLoaded(o,r),e()},r=>i(o,r),r=>n(o,r));break;case"texture":this.loaders.textureLoader.load(o.path,r=>{this.sourceLoaded(o,r),e()},void 0,r=>n(o,r));break;case"cubeTexture":this.loaders.cubeTextureLoader.load(o.path,r=>{this.sourceLoaded(o,r),e()},void 0,r=>n(o,r));break}}sourceLoaded(t,s){this.items[t.name]=s,this.loaded++,this.loaded===this.toLoad&&this.trigger("ready")}}class ai{constructor(){this.experience=new j,this.elements={btnTime:document.getElementById("btn-time"),btnAudio:document.getElementById("btn-audio"),btnSettings:document.getElementById("btn-settings"),timeControl:document.getElementById("time-control"),settingsPanel:document.getElementById("settings-panel"),timePresets:document.querySelectorAll(".time-preset"),qualitySlider:document.getElementById("quality-slider"),qualityValue:document.getElementById("quality-value"),volumeSlider:document.getElementById("volume-slider"),volumeValue:document.getElementById("volume-value"),toggleCycle:document.getElementById("toggle-cycle"),toggleFps:document.getElementById("toggle-fps"),portalUI:document.getElementById("portal-ui"),portalTitle:document.getElementById("portal-title"),portalDescription:document.getElementById("portal-description"),portalClose:document.getElementById("portal-close"),portalEnter:document.getElementById("portal-enter"),projectModal:document.getElementById("project-modal"),modalTitle:document.getElementById("modal-title"),modalClose:document.getElementById("modal-close"),projectIframe:document.getElementById("project-iframe"),perfStats:document.getElementById("perf-stats"),fpsCounter:document.getElementById("fps-counter"),notificationContainer:document.getElementById("notification-container")},this.currentPortalData=null,this._listeners=[],this.setupEventListeners(),this.setupPortalEvents(),this.setupEnvironmentToggle()}_listen(t,s,e,n){t&&(t.addEventListener(s,e,n),this._listeners.push({target:t,event:s,handler:e,options:n}))}setupEnvironmentToggle(){const t=document.getElementById("env-toggle"),s=document.getElementById("env-toggle-label");t&&(this._listen(t,"click",()=>{window.dispatchEvent(new CustomEvent("toggleEnvironment"))}),this._listen(window,"environmentChanged",e=>{const n=e.detail.mode;s&&(s.textContent=n==="test"?"üß™ Test":"üå≥ Forest"),t.setAttribute("data-mode",n)}))}setupEventListeners(){var t;this._listen(this.elements.btnTime,"click",()=>{this.togglePanel("timeControl")}),this._listen(this.elements.btnAudio,"click",()=>{this.toggleAudio()}),this._listen(this.elements.btnSettings,"click",()=>{this.togglePanel("settingsPanel")}),(t=this.elements.timePresets)==null||t.forEach(s=>{this._listen(s,"click",()=>{this.setTimePreset(s.dataset.preset),this.elements.timePresets.forEach(e=>e.classList.remove("active")),s.classList.add("active")})}),this._listen(this.elements.qualitySlider,"input",s=>{const e=["Low","Medium","High"],n=parseInt(s.target.value);this.elements.qualityValue.textContent=e[n],this.setQuality(n)}),this._listen(this.elements.volumeSlider,"input",s=>{const e=parseInt(s.target.value);this.elements.volumeValue.textContent=`${e}%`,this.setVolume(e/100)}),this._listen(this.elements.toggleCycle,"click",()=>{this.elements.toggleCycle.classList.toggle("active"),this.toggleDayNightCycle()}),this._listen(this.elements.toggleFps,"click",()=>{this.elements.toggleFps.classList.toggle("active"),this.toggleFpsDisplay()}),this._listen(this.elements.portalClose,"click",()=>{this.hidePortalUI()}),this._listen(this.elements.portalEnter,"click",()=>{this.enterPortal()}),this._listen(this.elements.modalClose,"click",()=>{this.closeProjectModal()}),this._listen(this.elements.projectModal,"click",s=>{s.target===this.elements.projectModal&&this.closeProjectModal()}),this._listen(document,"keydown",s=>{s.key==="Escape"&&(this.closeAllPanels(),this.closeProjectModal())})}setupPortalEvents(){this._listen(window,"portalEnter",t=>{this.showPortalUI(t.detail)}),this._listen(window,"portalExit",()=>{this.hidePortalUI()}),this._listen(window,"portalActivate",t=>{this.openProjectModal(t.detail)})}togglePanel(t){var e,n;const s=this.elements[t];s&&(t!=="timeControl"&&((e=this.elements.timeControl)==null||e.classList.remove("visible")),t!=="settingsPanel"&&((n=this.elements.settingsPanel)==null||n.classList.remove("visible")),s.classList.toggle("visible"))}closeAllPanels(){var t,s;(t=this.elements.timeControl)==null||t.classList.remove("visible"),(s=this.elements.settingsPanel)==null||s.classList.remove("visible"),this.hidePortalUI()}toggleAudio(){const t=this.experience.audioManager;if(t){const s=t.toggleMute();this.elements.btnAudio.textContent=s?"üîá":"üîä",this.elements.btnAudio.classList.toggle("active",!s)}else this.notify("Audio coming soon","info")}setTimePreset(t){var e;const s=(e=this.experience.world)==null?void 0:e.environment;s&&s.setPreset(t)}setQuality(t){const s=this.experience.renderer;if(s)switch(t){case 0:s.instance.setPixelRatio(1),this.experience.postProcessing&&(this.experience.postProcessing.bloomEffect.intensity=0);break;case 1:s.instance.setPixelRatio(Math.min(window.devicePixelRatio,1.5)),this.experience.postProcessing&&(this.experience.postProcessing.bloomEffect.intensity=.3);break;case 2:s.instance.setPixelRatio(Math.min(window.devicePixelRatio,2)),this.experience.postProcessing&&(this.experience.postProcessing.bloomEffect.intensity=.5);break}}setVolume(t){const s=this.experience.audioManager;s&&s.setMasterVolume(t),this.elements.volumeValue&&(this.elements.volumeValue.textContent=`${Math.round(t*100)}%`)}toggleDayNightCycle(){this.notify("Auto cycle coming soon")}toggleFpsDisplay(){var s;return(s=this.elements.perfStats)==null?void 0:s.classList.toggle("visible")}showPortalUI(t){var s;this.currentPortalData=t,this.elements.portalTitle&&(this.elements.portalTitle.textContent=t.title||"Portal"),this.elements.portalDescription&&(this.elements.portalDescription.textContent=t.description||""),(s=this.elements.portalUI)==null||s.classList.add("visible")}hidePortalUI(){var t;(t=this.elements.portalUI)==null||t.classList.remove("visible"),this.currentPortalData=null}enterPortal(){this.currentPortalData&&(window.dispatchEvent(new CustomEvent("portalActivate",{detail:this.currentPortalData.data})),this.openProjectModal(this.currentPortalData.data))}openProjectModal(t){var s;this.elements.modalTitle&&(this.elements.modalTitle.textContent=t.title||"Project"),this.elements.projectIframe&&t.url&&(this.elements.projectIframe.src=t.url),(s=this.elements.projectModal)==null||s.classList.add("active")}closeProjectModal(){var t;(t=this.elements.projectModal)==null||t.classList.remove("active"),this.elements.projectIframe&&(this.elements.projectIframe.src="about:blank")}notify(t,s="info",e=3e3){var i;const n=document.createElement("div");n.className=`notification ${s}`,n.textContent=t,(i=this.elements.notificationContainer)==null||i.appendChild(n),setTimeout(()=>{n.style.opacity="0",n.style.transform="translateY(-20px)",setTimeout(()=>n.remove(),300)},e)}updateFPS(t){this.elements.fpsCounter&&(this.elements.fpsCounter.textContent=Math.round(t))}destroy(){for(const{target:t,event:s,handler:e,options:n}of this._listeners)t.removeEventListener(s,e,n);this._listeners=[]}}class ci{constructor(){this.experience=new j,this.canvas=this.experience.canvas,this.isEnabled=!1,this.isTouchDevice=this.detectTouchDevice(),this.moveJoystick={active:!1,startX:0,startY:0,currentX:0,currentY:0,deltaX:0,deltaY:0,touchId:null},this.cameraJoystick={active:!1,startX:0,startY:0,currentX:0,currentY:0,deltaX:0,deltaY:0,touchId:null},this.jumpRequested=!1,this.settings={joystickRadius:60,deadzone:.1,sensitivity:1,cameraSensitivity:.003},this.uiElements={},this.isTouchDevice&&(this.createUI(),this.setupEventListeners(),this.enable())}detectTouchDevice(){return"ontouchstart"in window||navigator.maxTouchPoints>0||window.matchMedia("(pointer: coarse)").matches}createUI(){const t=document.createElement("div");t.id="touch-controls",t.innerHTML=`
      <style>
        #touch-controls {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          pointer-events: none;
          z-index: 100;
          display: none;
        }
        
        #touch-controls.enabled {
          display: block;
        }
        
        .joystick-zone {
          position: absolute;
          bottom: 20px;
          width: 150px;
          height: 150px;
          pointer-events: auto;
        }
        
        .joystick-zone.left {
          left: 20px;
        }
        
        .joystick-zone.right {
          right: 20px;
        }
        
        .joystick-base {
          position: absolute;
          width: 120px;
          height: 120px;
          background: rgba(255, 255, 255, 0.1);
          border: 2px solid rgba(255, 255, 255, 0.3);
          border-radius: 50%;
          left: 50%;
          top: 50%;
          transform: translate(-50%, -50%);
          backdrop-filter: blur(10px);
        }
        
        .joystick-stick {
          position: absolute;
          width: 50px;
          height: 50px;
          background: rgba(255, 255, 255, 0.4);
          border: 2px solid rgba(255, 255, 255, 0.6);
          border-radius: 50%;
          left: 50%;
          top: 50%;
          transform: translate(-50%, -50%);
          transition: transform 0.05s ease-out;
        }
        
        .jump-button {
          position: absolute;
          bottom: 180px;
          right: 50px;
          width: 70px;
          height: 70px;
          background: rgba(102, 126, 234, 0.3);
          border: 2px solid rgba(102, 126, 234, 0.6);
          border-radius: 50%;
          pointer-events: auto;
          display: flex;
          align-items: center;
          justify-content: center;
          color: rgba(255, 255, 255, 0.8);
          font-size: 24px;
          font-weight: bold;
          backdrop-filter: blur(10px);
          user-select: none;
          -webkit-user-select: none;
        }
        
        .jump-button:active {
          background: rgba(102, 126, 234, 0.6);
          transform: scale(0.95);
        }
        
        .action-button {
          position: absolute;
          bottom: 100px;
          right: 130px;
          width: 60px;
          height: 60px;
          background: rgba(118, 75, 162, 0.3);
          border: 2px solid rgba(118, 75, 162, 0.6);
          border-radius: 50%;
          pointer-events: auto;
          display: flex;
          align-items: center;
          justify-content: center;
          color: rgba(255, 255, 255, 0.8);
          font-size: 20px;
          backdrop-filter: blur(10px);
          user-select: none;
          -webkit-user-select: none;
        }
      </style>
      
      <div class="joystick-zone left" id="move-joystick-zone">
        <div class="joystick-base">
          <div class="joystick-stick" id="move-stick"></div>
        </div>
      </div>
      
      <div class="joystick-zone right" id="camera-joystick-zone">
        <div class="joystick-base">
          <div class="joystick-stick" id="camera-stick"></div>
        </div>
      </div>
      
      <div class="jump-button" id="jump-button">‚¨Ü</div>
      <div class="action-button" id="action-button">‚ú¶</div>
    `,document.body.appendChild(t),this.uiElements={container:t,moveZone:t.querySelector("#move-joystick-zone"),moveStick:t.querySelector("#move-stick"),cameraZone:t.querySelector("#camera-joystick-zone"),cameraStick:t.querySelector("#camera-stick"),jumpButton:t.querySelector("#jump-button"),actionButton:t.querySelector("#action-button")}}setupEventListeners(){this.uiElements.moveZone.addEventListener("touchstart",t=>this.onMoveStart(t),{passive:!1}),this.uiElements.moveZone.addEventListener("touchmove",t=>this.onMoveMove(t),{passive:!1}),this.uiElements.moveZone.addEventListener("touchend",t=>this.onMoveEnd(t)),this.uiElements.moveZone.addEventListener("touchcancel",t=>this.onMoveEnd(t)),this.uiElements.cameraZone.addEventListener("touchstart",t=>this.onCameraStart(t),{passive:!1}),this.uiElements.cameraZone.addEventListener("touchmove",t=>this.onCameraMove(t),{passive:!1}),this.uiElements.cameraZone.addEventListener("touchend",t=>this.onCameraEnd(t)),this.uiElements.cameraZone.addEventListener("touchcancel",t=>this.onCameraEnd(t)),this.uiElements.jumpButton.addEventListener("touchstart",t=>{t.preventDefault(),this.jumpRequested=!0}),this.uiElements.jumpButton.addEventListener("touchend",()=>{this.jumpRequested=!1}),this.uiElements.actionButton.addEventListener("touchstart",t=>{t.preventDefault(),window.dispatchEvent(new CustomEvent("touchAction"))})}onMoveStart(t){t.preventDefault();const s=t.changedTouches[0],e=this.uiElements.moveZone.getBoundingClientRect();this.moveJoystick.active=!0,this.moveJoystick.touchId=s.identifier,this.moveJoystick.startX=e.left+e.width/2,this.moveJoystick.startY=e.top+e.height/2,this.moveJoystick.currentX=s.clientX,this.moveJoystick.currentY=s.clientY,this.updateMoveStick()}onMoveMove(t){if(t.preventDefault(),!!this.moveJoystick.active){for(const s of t.changedTouches)if(s.identifier===this.moveJoystick.touchId){this.moveJoystick.currentX=s.clientX,this.moveJoystick.currentY=s.clientY,this.updateMoveStick();break}}}onMoveEnd(t){for(const s of t.changedTouches)if(s.identifier===this.moveJoystick.touchId){this.moveJoystick.active=!1,this.moveJoystick.deltaX=0,this.moveJoystick.deltaY=0,this.uiElements.moveStick.style.transform="translate(-50%, -50%)";break}}updateMoveStick(){let t=this.moveJoystick.currentX-this.moveJoystick.startX,s=this.moveJoystick.currentY-this.moveJoystick.startY;const e=Math.sqrt(t*t+s*s),n=this.settings.joystickRadius;e>n&&(t=t/e*n,s=s/e*n),this.moveJoystick.deltaX=t/n,this.moveJoystick.deltaY=s/n,Math.abs(this.moveJoystick.deltaX)<this.settings.deadzone&&(this.moveJoystick.deltaX=0),Math.abs(this.moveJoystick.deltaY)<this.settings.deadzone&&(this.moveJoystick.deltaY=0),this.uiElements.moveStick.style.transform=`translate(calc(-50% + ${t}px), calc(-50% + ${s}px))`}onCameraStart(t){t.preventDefault();const s=t.changedTouches[0];this.cameraJoystick.active=!0,this.cameraJoystick.touchId=s.identifier,this.cameraJoystick.startX=s.clientX,this.cameraJoystick.startY=s.clientY}onCameraMove(t){if(t.preventDefault(),!!this.cameraJoystick.active){for(const s of t.changedTouches)if(s.identifier===this.cameraJoystick.touchId){const e=s.clientX-this.cameraJoystick.startX,n=s.clientY-this.cameraJoystick.startY;this.cameraJoystick.deltaX=e*this.settings.cameraSensitivity,this.cameraJoystick.deltaY=n*this.settings.cameraSensitivity;const i=Math.max(-this.settings.joystickRadius,Math.min(this.settings.joystickRadius,e)),o=Math.max(-this.settings.joystickRadius,Math.min(this.settings.joystickRadius,n));this.uiElements.cameraStick.style.transform=`translate(calc(-50% + ${i}px), calc(-50% + ${o}px))`,this.cameraJoystick.startX=s.clientX,this.cameraJoystick.startY=s.clientY;break}}}onCameraEnd(t){for(const s of t.changedTouches)if(s.identifier===this.cameraJoystick.touchId){this.cameraJoystick.active=!1,this.cameraJoystick.deltaX=0,this.cameraJoystick.deltaY=0,this.uiElements.cameraStick.style.transform="translate(-50%, -50%)";break}}getInput(){return{moveX:this.moveJoystick.deltaX*this.settings.sensitivity,moveY:-this.moveJoystick.deltaY*this.settings.sensitivity,cameraX:this.cameraJoystick.deltaX,cameraY:this.cameraJoystick.deltaY,jump:this.jumpRequested}}enable(){this.isEnabled=!0,this.uiElements.container&&this.uiElements.container.classList.add("enabled")}disable(){this.isEnabled=!1,this.uiElements.container&&this.uiElements.container.classList.remove("enabled")}checkOrientation(){window.innerWidth<window.innerHeight&&this.enable()}destroy(){this.uiElements.container&&this.uiElements.container.remove()}}const li=[];let Pe=null;class j{constructor(t={}){if(Pe)return Pe;if(Pe=this,this.canvas=t.canvas,!this.canvas)throw new Error("Canvas element not found!");if(!(this.canvas.getContext("webgl2")||this.canvas.getContext("webgl")))throw new Error("WebGL is not supported on this device/browser!");this.debug=window.location.hash==="#debug",this.fpsFrames=0,this.fpsTime=0,this.currentFPS=60,this._initComplete=!1;try{console.log("üì¶ Initializing core systems..."),this.sizes=new pn,this.time=new mn,this.scene=new rn,this.resources=new ri(li),this.physics=new fn,this.camera=new xn,this.renderer=new bn,console.log("üåç Creating world..."),this.world=new oi,console.log("üé® Setting up UI..."),this.uiManager=new ai,this.touchControls=new ci,this.sizes.on("resize",()=>this.resize()),this.time.on("tick",()=>this.update()),this.resources.on("ready",()=>{this.onReady()}),this._initComplete=!0,console.log("‚úÖ Experience initialization complete ‚Äî scene objects:",this.scene.children.length)}catch(e){throw console.error("‚ùå Experience initialization error:",e),e}finally{this.hideLoadingScreen()}this.autoHideControls()}onReady(){this.hideLoadingScreen()}resize(){this.camera.resize(),this.renderer.resize()}update(){const t=this.time.delta/1e3;if(this.physics.update(),this.world.update(t),this.world.player&&this.camera.thirdPerson&&(this.camera.thirdPerson.follow(this.world.player.mesh,t),this.scene.fog)){const s=this.camera.thirdPerson.settings.distance;s>30&&(this.scene.fog.near=s*.5,this.scene.fog.far=s*3)}this.renderer.update(),this.updateFPS()}updateFPS(){var t;this.fpsFrames++,this.fpsTime+=this.time.delta,this.fpsTime>=1e3&&(this.currentFPS=this.fpsFrames,this.fpsFrames=0,this.fpsTime=0,(t=this.uiManager)==null||t.updateFPS(this.currentFPS))}autoHideControls(){const t=document.getElementById("instructions");t&&(t.classList.add("visible"),setTimeout(()=>{t.classList.add("hiding"),t.classList.remove("visible")},5e3))}hideLoadingScreen(){if(this._loadingHidden)return;this._loadingHidden=!0;const t=document.getElementById("loading-screen");t&&(t.style.opacity="0",t.style.pointerEvents="none",setTimeout(()=>{t.style.display="none"},600))}destroy(){var t,s,e,n,i,o;this.sizes.off("resize"),this.time.off("tick"),this.scene.traverse(r=>{if(r instanceof x){r.geometry.dispose();for(const a in r.material){const c=r.material[a];c&&typeof c.dispose=="function"&&c.dispose()}}}),(t=this.uiManager)==null||t.destroy(),(s=this.world)==null||s.destroy(),(e=this.camera)==null||e.destroy(),(n=this.time)==null||n.destroy(),(i=this.sizes)==null||i.destroy(),(o=this.touchControls)==null||o.destroy(),this.renderer.instance.dispose(),Pe=null}}function ze(p){let t=document.getElementById("_err_overlay");t||(t=document.createElement("pre"),t.id="_err_overlay",t.style.cssText="position:fixed;top:10px;left:10px;z-index:99999;background:rgba(200,0,0,0.9);color:white;padding:12px 16px;font-size:12px;max-width:80vw;max-height:50vh;overflow:auto;word-wrap:break-word;border-radius:8px;font-family:monospace;",document.body.appendChild(t)),t.textContent+=p+`
`}function Ee(){const p=document.getElementById("loading-screen");p&&(p.style.transition="opacity 0.3s",p.style.opacity="0",p.style.pointerEvents="none",setTimeout(()=>{p.style.display="none"},300))}window.addEventListener("error",p=>{const t=`‚ùå ${p.message}
   ${p.filename}:${p.lineno}`;console.error(t),ze(t),Ee()});window.addEventListener("unhandledrejection",p=>{const t=`‚ùå Unhandled rejection: ${p.reason}`;console.error(t),ze(t),Ee()});setTimeout(()=>{const p=document.getElementById("loading-screen");p&&p.style.display!=="none"&&(console.warn("‚ö†Ô∏è Failsafe: forcing loading screen hide after timeout"),Ee())},8e3);document.addEventListener("DOMContentLoaded",()=>{console.log("üöÄ DOMContentLoaded - starting Experience...");try{const p=document.getElementById("webgl");if(!p){ze("‚ùå Canvas element #webgl not found in DOM!"),Ee();return}console.log("üì¶ Creating Experience instance...");const t=new j({canvas:p});console.log("‚úÖ Experience created successfully")}catch(p){console.error("‚ùå Experience init failed:",p),ze("‚ùå Experience init failed: "+p.message+`
`+p.stack),Ee()}});
