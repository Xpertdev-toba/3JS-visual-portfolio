import{E as Es,V as y,M as ce,T as le,S as St,Q as Fe,a as F,R as As,P as Ms,b as dt,c as Kt,W as _s,A as Ps,d as ne,B as ks,D as nt,e as Ls,H as Ss,F as Cs,f as G,g as L,h as Is,i as b,G as X,j as D,C as Xe,k as V,l as K,m as U,n as H,o as se,p as Rs,q as it,r as B,s as we,O as Pe,t as Ct,L as Ie,u as Re,v as oe,I as We,w as be,x as De,y as Oe,z as Ds,J as ot,K as at,N as zs,U as Vt,X as Te,Y as Fs,Z as Os,_ as xe,$ as Xt,a0 as js,a1 as Ns,a2 as rt,a3 as Wt,a4 as $t,a5 as ve,a6 as je,a7 as J,a8 as W,a9 as Bs,aa as Hs,ab as Ne,ac as Us,ad as qt,ae as Gs,af as Zs,ag as Jt,ah as Ys,ai as Ks,aj as Vs,ak as Xs,al as ct,am as Ws,an as $s,ao as $e,ap as qs,aq as Js,ar as Qs,as as en,at as tn,au as sn,av as nn,aw as on,ax as an,ay as Qt,az as rn,aA as It,aB as Rt,aC as Dt,aD as zt,aE as Ft,aF as cn,aG as ln,aH as hn,aI as dn}from"./three-DnIYBcq8.js";import{W as un,S as pn,M as ke,C as Le,P as mn,B as R,H as fn,a as he,V as Z,R as Ot,b as gn,c as ze,d as qe}from"./physics-hjSNwIrE.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))t(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&t(o)}).observe(document,{childList:!0,subtree:!0});function s(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function t(n){if(n.ep)return;n.ep=!0;const i=s(n);fetch(n.href,i)}})();class ut{constructor(){this.callbacks={},this.callbacks.base={}}on(e,s){const t=e.split("."),n=t[0],i=t.length>1?t[1]:"base";return this.callbacks[i]||(this.callbacks[i]={}),this.callbacks[i][n]||(this.callbacks[i][n]=[]),this.callbacks[i][n].push(s),this}off(e){var i;const s=e.split("."),t=s[0],n=s.length>1?s[1]:"";if(t&&n)(i=this.callbacks[n])!=null&&i[t]&&delete this.callbacks[n][t];else if(t)for(const o in this.callbacks)this.callbacks[o][t]&&delete this.callbacks[o][t];else n&&delete this.callbacks[n];return this}trigger(e,s=[]){const t=e.split("."),n=t[0],i=t.length>1?t[1]:"",o=a=>{this.callbacks[a]&&this.callbacks[a][n]&&this.callbacks[a][n].forEach(r=>{r.apply(this,s)})};if(i==="")for(const a in this.callbacks)o(a);else o(i);return this}}class yn extends ut{constructor(){super(),this.width=window.innerWidth,this.height=window.innerHeight,this.pixelRatio=Math.min(window.devicePixelRatio,2),this._onResize=()=>{this.width=window.innerWidth,this.height=window.innerHeight,this.pixelRatio=Math.min(window.devicePixelRatio,2),this.trigger("resize")},window.addEventListener("resize",this._onResize)}destroy(){window.removeEventListener("resize",this._onResize)}}class wn extends ut{constructor(){super(),this.start=Date.now(),this.current=this.start,this.elapsed=0,this.delta=16,this.rafId=null,this.rafId=window.requestAnimationFrame(()=>{this.tick()})}tick(){const e=Date.now();this.delta=e-this.current,this.current=e,this.elapsed=this.current-this.start,this.trigger("tick"),this.rafId=window.requestAnimationFrame(()=>{this.tick()})}destroy(){this.rafId&&(window.cancelAnimationFrame(this.rafId),this.rafId=null)}}class bn{constructor(){this.experience=new C,this.time=this.experience.time,this.zoneBodies=[],this.dynamicBodies=[],this.config={gravity:-20,solverIterations:8,timestep:1/60,maxSubSteps:3},this.setWorld(),this.setMaterials(),this.setGround()}setWorld(){this.world=new un,this.world.gravity.set(0,this.config.gravity,0),this.world.broadphase=new pn(this.world),this.world.allowSleep=!0,this.world.solver.iterations=this.config.solverIterations,this.world.solver.tolerance=.001,this.world.quatNormalizeSkip=0,this.world.quatNormalizeFast=!1}setMaterials(){this.defaultMaterial=new ke("default"),this.playerMaterial=new ke("player"),this.slipperyMaterial=new ke("slippery"),this.bouncyMaterial=new ke("bouncy"),this.defaultContactMaterial=new Le(this.defaultMaterial,this.defaultMaterial,{friction:.4,restitution:.1}),this.playerGroundContact=new Le(this.playerMaterial,this.defaultMaterial,{friction:.3,restitution:0}),this.slipperyContact=new Le(this.playerMaterial,this.slipperyMaterial,{friction:.02,restitution:0}),this.bouncyContact=new Le(this.playerMaterial,this.bouncyMaterial,{friction:.3,restitution:.8}),this.world.addContactMaterial(this.defaultContactMaterial),this.world.addContactMaterial(this.playerGroundContact),this.world.addContactMaterial(this.slipperyContact),this.world.addContactMaterial(this.bouncyContact),this.world.defaultContactMaterial=this.defaultContactMaterial}setGround(){const e=new mn;this.groundBody=new R({mass:0,shape:e,material:this.defaultMaterial}),this.groundBody.quaternion.setFromEuler(-Math.PI/2,0,0),this.groundBody.position.set(0,0,0),this.world.addBody(this.groundBody)}setHeightfield(e,s,t){this.groundBody&&(this.world.removeBody(this.groundBody),this.groundBody=null);const n=t+1,i=t+1,o=s/t,a=[];for(let c=0;c<n;c++){const l=[];for(let h=0;h<i;h++){const m=(i-1-h)*n+c;l.push(e[m]||0)}a.push(l)}const r=new fn(a,{elementSize:o});this.heightfieldBody=new R({mass:0,shape:r,material:this.defaultMaterial}),this.heightfieldBody.quaternion.setFromEuler(-Math.PI/2,0,0),this.heightfieldBody.position.set(-s/2,0,s/2),this.world.addBody(this.heightfieldBody),console.log(`‚õ∞Ô∏è Heightfield collider: ${n}x${i}, elementSize=${o.toFixed(2)}`)}addZoneColliders(e){if(this.removeZoneColliders(),!this.heightfieldBody)for(const[s,t]of Object.entries(e)){if(Math.abs(t.elevation)<.01)continue;const n=t.radius,i=.5,o=new he(new Z(n,i,n)),a=new R({mass:0,shape:o,material:this.defaultMaterial});a.position.set(t.center.x,t.elevation-i,t.center.z),this.world.addBody(a),this.zoneBodies.push(a)}}removeZoneColliders(){for(const e of this.zoneBodies)this.world.removeBody(e);this.zoneBodies=[]}addDynamicBody(e){return this.world.addBody(e),this.dynamicBodies.push(e),e}removeDynamicBody(e){const s=this.dynamicBodies.indexOf(e);s!==-1&&this.dynamicBodies.splice(s,1),this.world.removeBody(e)}raycast(e,s,t=100){const n=new Ot(new Z(e.x,e.y,e.z),new Z(e.x+s.x*t,e.y+s.y*t,e.z+s.z*t));n.mode=Ot.CLOSEST,n.skipBackfaces=!0;const i=new gn;return n.intersectWorld(this.world,{result:i}),i.hasHit?{hit:!0,point:i.hitPointWorld,normal:i.hitNormalWorld,body:i.body,distance:i.distance}:{hit:!1,point:null,normal:null,body:null,distance:t}}groundCheck(e,s=2){return this.raycast({x:e.x,y:e.y+.1,z:e.z},{x:0,y:-1,z:0},s)}update(){const e=this.config.timestep,t=Math.min(this.time.delta/1e3,.1);this.world.step(e,t,this.config.maxSubSteps)}dispose(){for(const e of this.dynamicBodies)this.world.removeBody(e);this.dynamicBodies=[],this.removeZoneColliders(),this.heightfieldBody&&(this.world.removeBody(this.heightfieldBody),this.heightfieldBody=null),this.groundBody&&(this.world.removeBody(this.groundBody),this.groundBody=null),console.log("üßπ Physics disposed")}}const jt={type:"change"},Je={type:"start"},Nt={type:"end"},Se=new As,Bt=new Ms,xn=Math.cos(70*dt.DEG2RAD);class vn extends Es{constructor(e,s){super(),this.object=e,this.domElement=s,this.domElement.style.touchAction="none",this.enabled=!0,this.target=new y,this.cursor=new y,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minTargetRadius=0,this.maxTargetRadius=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.05,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!0,this.keyPanSpeed=7,this.zoomToCursor=!1,this.autoRotate=!1,this.autoRotateSpeed=2,this.keys={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"},this.mouseButtons={LEFT:ce.ROTATE,MIDDLE:ce.DOLLY,RIGHT:ce.PAN},this.touches={ONE:le.ROTATE,TWO:le.DOLLY_PAN},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this._domElementKeyEvents=null,this.getPolarAngle=function(){return a.phi},this.getAzimuthalAngle=function(){return a.theta},this.getDistance=function(){return this.object.position.distanceTo(this.target)},this.listenToKeyEvents=function(d){d.addEventListener("keydown",Ke),this._domElementKeyEvents=d},this.stopListenToKeyEvents=function(){this._domElementKeyEvents.removeEventListener("keydown",Ke),this._domElementKeyEvents=null},this.saveState=function(){t.target0.copy(t.target),t.position0.copy(t.object.position),t.zoom0=t.object.zoom},this.reset=function(){t.target.copy(t.target0),t.object.position.copy(t.position0),t.object.zoom=t.zoom0,t.object.updateProjectionMatrix(),t.dispatchEvent(jt),t.update(),i=n.NONE},this.update=function(){const d=new y,v=new Fe().setFromUnitVectors(e.up,new y(0,1,0)),M=v.clone().invert(),k=new y,I=new Fe,Q=new y,j=2*Math.PI;return function(Ts=null){const Lt=t.object.position;d.copy(Lt).sub(t.target),d.applyQuaternion(v),a.setFromVector3(d),t.autoRotate&&i===n.NONE&&pe(ue(Ts)),t.enableDamping?(a.theta+=r.theta*t.dampingFactor,a.phi+=r.phi*t.dampingFactor):(a.theta+=r.theta,a.phi+=r.phi);let $=t.minAzimuthAngle,q=t.maxAzimuthAngle;isFinite($)&&isFinite(q)&&($<-Math.PI?$+=j:$>Math.PI&&($-=j),q<-Math.PI?q+=j:q>Math.PI&&(q-=j),$<=q?a.theta=Math.max($,Math.min(q,a.theta)):a.theta=a.theta>($+q)/2?Math.max($,a.theta):Math.min(q,a.theta)),a.phi=Math.max(t.minPolarAngle,Math.min(t.maxPolarAngle,a.phi)),a.makeSafe(),t.enableDamping===!0?t.target.addScaledVector(l,t.dampingFactor):t.target.add(l),t.target.sub(t.cursor),t.target.clampLength(t.minTargetRadius,t.maxTargetRadius),t.target.add(t.cursor),t.zoomToCursor&&z||t.object.isOrthographicCamera?a.radius=Ze(a.radius):a.radius=Ze(a.radius*c),d.setFromSpherical(a),d.applyQuaternion(M),Lt.copy(t.target).add(d),t.object.lookAt(t.target),t.enableDamping===!0?(r.theta*=1-t.dampingFactor,r.phi*=1-t.dampingFactor,l.multiplyScalar(1-t.dampingFactor)):(r.set(0,0,0),l.set(0,0,0));let Ve=!1;if(t.zoomToCursor&&z){let fe=null;if(t.object.isPerspectiveCamera){const ge=d.length();fe=Ze(ge*c);const _e=ge-fe;t.object.position.addScaledVector(A,_e),t.object.updateMatrixWorld()}else if(t.object.isOrthographicCamera){const ge=new y(S.x,S.y,0);ge.unproject(t.object),t.object.zoom=Math.max(t.minZoom,Math.min(t.maxZoom,t.object.zoom/c)),t.object.updateProjectionMatrix(),Ve=!0;const _e=new y(S.x,S.y,0);_e.unproject(t.object),t.object.position.sub(_e).add(ge),t.object.updateMatrixWorld(),fe=d.length()}else console.warn("WARNING: OrbitControls.js encountered an unknown camera type - zoom to cursor disabled."),t.zoomToCursor=!1;fe!==null&&(this.screenSpacePanning?t.target.set(0,0,-1).transformDirection(t.object.matrix).multiplyScalar(fe).add(t.object.position):(Se.origin.copy(t.object.position),Se.direction.set(0,0,-1).transformDirection(t.object.matrix),Math.abs(t.object.up.dot(Se.direction))<xn?e.lookAt(t.target):(Bt.setFromNormalAndCoplanarPoint(t.object.up,t.target),Se.intersectPlane(Bt,t.target))))}else t.object.isOrthographicCamera&&(t.object.zoom=Math.max(t.minZoom,Math.min(t.maxZoom,t.object.zoom/c)),t.object.updateProjectionMatrix(),Ve=!0);return c=1,z=!1,Ve||k.distanceToSquared(t.object.position)>o||8*(1-I.dot(t.object.quaternion))>o||Q.distanceToSquared(t.target)>0?(t.dispatchEvent(jt),k.copy(t.object.position),I.copy(t.object.quaternion),Q.copy(t.target),!0):!1}}(),this.dispose=function(){t.domElement.removeEventListener("contextmenu",Pt),t.domElement.removeEventListener("pointerdown",At),t.domElement.removeEventListener("pointercancel",me),t.domElement.removeEventListener("wheel",Mt),t.domElement.removeEventListener("pointermove",Ye),t.domElement.removeEventListener("pointerup",me),t._domElementKeyEvents!==null&&(t._domElementKeyEvents.removeEventListener("keydown",Ke),t._domElementKeyEvents=null)};const t=this,n={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6};let i=n.NONE;const o=1e-6,a=new St,r=new St;let c=1;const l=new y,h=new F,u=new F,m=new F,f=new F,g=new F,w=new F,x=new F,T=new F,_=new F,A=new y,S=new F;let z=!1;const P=[],Y={};let O=!1;function ue(d){return d!==null?2*Math.PI/60*t.autoRotateSpeed*d:2*Math.PI/60/60*t.autoRotateSpeed}function Ae(d){const v=Math.abs(d*.01);return Math.pow(.95,t.zoomSpeed*v)}function pe(d){r.theta-=d}function Me(d){r.phi-=d}const pt=function(){const d=new y;return function(M,k){d.setFromMatrixColumn(k,0),d.multiplyScalar(-M),l.add(d)}}(),mt=function(){const d=new y;return function(M,k){t.screenSpacePanning===!0?d.setFromMatrixColumn(k,1):(d.setFromMatrixColumn(k,0),d.crossVectors(t.object.up,d)),d.multiplyScalar(M),l.add(d)}}(),ae=function(){const d=new y;return function(M,k){const I=t.domElement;if(t.object.isPerspectiveCamera){const Q=t.object.position;d.copy(Q).sub(t.target);let j=d.length();j*=Math.tan(t.object.fov/2*Math.PI/180),pt(2*M*j/I.clientHeight,t.object.matrix),mt(2*k*j/I.clientHeight,t.object.matrix)}else t.object.isOrthographicCamera?(pt(M*(t.object.right-t.object.left)/t.object.zoom/I.clientWidth,t.object.matrix),mt(k*(t.object.top-t.object.bottom)/t.object.zoom/I.clientHeight,t.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),t.enablePan=!1)}}();function Ue(d){t.object.isPerspectiveCamera||t.object.isOrthographicCamera?c/=d:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),t.enableZoom=!1)}function ft(d){t.object.isPerspectiveCamera||t.object.isOrthographicCamera?c*=d:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),t.enableZoom=!1)}function Ge(d,v){if(!t.zoomToCursor)return;z=!0;const M=t.domElement.getBoundingClientRect(),k=d-M.left,I=v-M.top,Q=M.width,j=M.height;S.x=k/Q*2-1,S.y=-(I/j)*2+1,A.set(S.x,S.y,1).unproject(t.object).sub(t.object.position).normalize()}function Ze(d){return Math.max(t.minDistance,Math.min(t.maxDistance,d))}function gt(d){h.set(d.clientX,d.clientY)}function is(d){Ge(d.clientX,d.clientX),x.set(d.clientX,d.clientY)}function yt(d){f.set(d.clientX,d.clientY)}function os(d){u.set(d.clientX,d.clientY),m.subVectors(u,h).multiplyScalar(t.rotateSpeed);const v=t.domElement;pe(2*Math.PI*m.x/v.clientHeight),Me(2*Math.PI*m.y/v.clientHeight),h.copy(u),t.update()}function as(d){T.set(d.clientX,d.clientY),_.subVectors(T,x),_.y>0?Ue(Ae(_.y)):_.y<0&&ft(Ae(_.y)),x.copy(T),t.update()}function rs(d){g.set(d.clientX,d.clientY),w.subVectors(g,f).multiplyScalar(t.panSpeed),ae(w.x,w.y),f.copy(g),t.update()}function cs(d){Ge(d.clientX,d.clientY),d.deltaY<0?ft(Ae(d.deltaY)):d.deltaY>0&&Ue(Ae(d.deltaY)),t.update()}function ls(d){let v=!1;switch(d.code){case t.keys.UP:d.ctrlKey||d.metaKey||d.shiftKey?Me(2*Math.PI*t.rotateSpeed/t.domElement.clientHeight):ae(0,t.keyPanSpeed),v=!0;break;case t.keys.BOTTOM:d.ctrlKey||d.metaKey||d.shiftKey?Me(-2*Math.PI*t.rotateSpeed/t.domElement.clientHeight):ae(0,-t.keyPanSpeed),v=!0;break;case t.keys.LEFT:d.ctrlKey||d.metaKey||d.shiftKey?pe(2*Math.PI*t.rotateSpeed/t.domElement.clientHeight):ae(t.keyPanSpeed,0),v=!0;break;case t.keys.RIGHT:d.ctrlKey||d.metaKey||d.shiftKey?pe(-2*Math.PI*t.rotateSpeed/t.domElement.clientHeight):ae(-t.keyPanSpeed,0),v=!0;break}v&&(d.preventDefault(),t.update())}function wt(d){if(P.length===1)h.set(d.pageX,d.pageY);else{const v=re(d),M=.5*(d.pageX+v.x),k=.5*(d.pageY+v.y);h.set(M,k)}}function bt(d){if(P.length===1)f.set(d.pageX,d.pageY);else{const v=re(d),M=.5*(d.pageX+v.x),k=.5*(d.pageY+v.y);f.set(M,k)}}function xt(d){const v=re(d),M=d.pageX-v.x,k=d.pageY-v.y,I=Math.sqrt(M*M+k*k);x.set(0,I)}function hs(d){t.enableZoom&&xt(d),t.enablePan&&bt(d)}function ds(d){t.enableZoom&&xt(d),t.enableRotate&&wt(d)}function vt(d){if(P.length==1)u.set(d.pageX,d.pageY);else{const M=re(d),k=.5*(d.pageX+M.x),I=.5*(d.pageY+M.y);u.set(k,I)}m.subVectors(u,h).multiplyScalar(t.rotateSpeed);const v=t.domElement;pe(2*Math.PI*m.x/v.clientHeight),Me(2*Math.PI*m.y/v.clientHeight),h.copy(u)}function Tt(d){if(P.length===1)g.set(d.pageX,d.pageY);else{const v=re(d),M=.5*(d.pageX+v.x),k=.5*(d.pageY+v.y);g.set(M,k)}w.subVectors(g,f).multiplyScalar(t.panSpeed),ae(w.x,w.y),f.copy(g)}function Et(d){const v=re(d),M=d.pageX-v.x,k=d.pageY-v.y,I=Math.sqrt(M*M+k*k);T.set(0,I),_.set(0,Math.pow(T.y/x.y,t.zoomSpeed)),Ue(_.y),x.copy(T);const Q=(d.pageX+v.x)*.5,j=(d.pageY+v.y)*.5;Ge(Q,j)}function us(d){t.enableZoom&&Et(d),t.enablePan&&Tt(d)}function ps(d){t.enableZoom&&Et(d),t.enableRotate&&vt(d)}function At(d){t.enabled!==!1&&(P.length===0&&(t.domElement.setPointerCapture(d.pointerId),t.domElement.addEventListener("pointermove",Ye),t.domElement.addEventListener("pointerup",me)),xs(d),d.pointerType==="touch"?ws(d):ms(d))}function Ye(d){t.enabled!==!1&&(d.pointerType==="touch"?bs(d):fs(d))}function me(d){vs(d),P.length===0&&(t.domElement.releasePointerCapture(d.pointerId),t.domElement.removeEventListener("pointermove",Ye),t.domElement.removeEventListener("pointerup",me)),t.dispatchEvent(Nt),i=n.NONE}function ms(d){let v;switch(d.button){case 0:v=t.mouseButtons.LEFT;break;case 1:v=t.mouseButtons.MIDDLE;break;case 2:v=t.mouseButtons.RIGHT;break;default:v=-1}switch(v){case ce.DOLLY:if(t.enableZoom===!1)return;is(d),i=n.DOLLY;break;case ce.ROTATE:if(d.ctrlKey||d.metaKey||d.shiftKey){if(t.enablePan===!1)return;yt(d),i=n.PAN}else{if(t.enableRotate===!1)return;gt(d),i=n.ROTATE}break;case ce.PAN:if(d.ctrlKey||d.metaKey||d.shiftKey){if(t.enableRotate===!1)return;gt(d),i=n.ROTATE}else{if(t.enablePan===!1)return;yt(d),i=n.PAN}break;default:i=n.NONE}i!==n.NONE&&t.dispatchEvent(Je)}function fs(d){switch(i){case n.ROTATE:if(t.enableRotate===!1)return;os(d);break;case n.DOLLY:if(t.enableZoom===!1)return;as(d);break;case n.PAN:if(t.enablePan===!1)return;rs(d);break}}function Mt(d){t.enabled===!1||t.enableZoom===!1||i!==n.NONE||(d.preventDefault(),t.dispatchEvent(Je),cs(gs(d)),t.dispatchEvent(Nt))}function gs(d){const v=d.deltaMode,M={clientX:d.clientX,clientY:d.clientY,deltaY:d.deltaY};switch(v){case 1:M.deltaY*=16;break;case 2:M.deltaY*=100;break}return d.ctrlKey&&!O&&(M.deltaY*=10),M}function ys(d){d.key==="Control"&&(O=!0,document.addEventListener("keyup",_t,{passive:!0,capture:!0}))}function _t(d){d.key==="Control"&&(O=!1,document.removeEventListener("keyup",_t,{passive:!0,capture:!0}))}function Ke(d){t.enabled===!1||t.enablePan===!1||ls(d)}function ws(d){switch(kt(d),P.length){case 1:switch(t.touches.ONE){case le.ROTATE:if(t.enableRotate===!1)return;wt(d),i=n.TOUCH_ROTATE;break;case le.PAN:if(t.enablePan===!1)return;bt(d),i=n.TOUCH_PAN;break;default:i=n.NONE}break;case 2:switch(t.touches.TWO){case le.DOLLY_PAN:if(t.enableZoom===!1&&t.enablePan===!1)return;hs(d),i=n.TOUCH_DOLLY_PAN;break;case le.DOLLY_ROTATE:if(t.enableZoom===!1&&t.enableRotate===!1)return;ds(d),i=n.TOUCH_DOLLY_ROTATE;break;default:i=n.NONE}break;default:i=n.NONE}i!==n.NONE&&t.dispatchEvent(Je)}function bs(d){switch(kt(d),i){case n.TOUCH_ROTATE:if(t.enableRotate===!1)return;vt(d),t.update();break;case n.TOUCH_PAN:if(t.enablePan===!1)return;Tt(d),t.update();break;case n.TOUCH_DOLLY_PAN:if(t.enableZoom===!1&&t.enablePan===!1)return;us(d),t.update();break;case n.TOUCH_DOLLY_ROTATE:if(t.enableZoom===!1&&t.enableRotate===!1)return;ps(d),t.update();break;default:i=n.NONE}}function Pt(d){t.enabled!==!1&&d.preventDefault()}function xs(d){P.push(d.pointerId)}function vs(d){delete Y[d.pointerId];for(let v=0;v<P.length;v++)if(P[v]==d.pointerId){P.splice(v,1);return}}function kt(d){let v=Y[d.pointerId];v===void 0&&(v=new F,Y[d.pointerId]=v),v.set(d.pageX,d.pageY)}function re(d){const v=d.pointerId===P[0]?P[1]:P[0];return Y[v]}t.domElement.addEventListener("contextmenu",Pt),t.domElement.addEventListener("pointerdown",At),t.domElement.addEventListener("pointercancel",me),t.domElement.addEventListener("wheel",Mt,{passive:!1}),document.addEventListener("keydown",ys,{passive:!0,capture:!0}),this.update()}}class Tn{constructor(e,s,t={}){this.experience=new C,this.scene=this.experience.scene,this.sizes=this.experience.sizes,this.canvas=s,this.camera=e,this.settings={distance:t.distance??8,height:t.height??4,smoothness:t.smoothing??.08,rotationSmoothness:t.rotationSmoothness??.1,minDistance:t.minDistance??3,maxDistance:t.maxDistance??200,minPitch:t.minPolarAngle??-.3,maxPitch:t.maxPolarAngle??1.4},this.currentPosition=new y,this.targetPosition=new y,this.lookAtPosition=new y,this.currentLookAt=new y,this.theta=0,this.phi=.5,this.targetDistance=this.settings.distance,this.overviewMode=!1,this.savedDistance=this.settings.distance,this.savedPhi=.5,this.overviewDistance=600,this.overviewPhi=1.3,this.isPointerDown=!1,this.previousPointer={x:0,y:0},this.initialized=!1,this.camera.position.set(0,10,15),this.setControls()}setControls(){this._onPointerDown=e=>this.onPointerDown(e),this._onPointerMove=e=>this.onPointerMove(e),this._onPointerUp=()=>this.onPointerUp(),this._onWheel=e=>this.onWheel(e),this._onTouchStart=e=>this.onTouchStart(e),this._onTouchMove=e=>this.onTouchMove(e),this._onTouchEnd=()=>this.onTouchEnd(),this._onKeyDown=e=>{e.code==="KeyF"&&this.toggleOverview()},this.canvas.addEventListener("pointerdown",this._onPointerDown),window.addEventListener("pointermove",this._onPointerMove),window.addEventListener("pointerup",this._onPointerUp),this.canvas.addEventListener("wheel",this._onWheel,{passive:!0}),this.touches=[],this.canvas.addEventListener("touchstart",this._onTouchStart,{passive:!0}),this.canvas.addEventListener("touchmove",this._onTouchMove,{passive:!0}),this.canvas.addEventListener("touchend",this._onTouchEnd),document.addEventListener("keydown",this._onKeyDown)}toggleOverview(){this.overviewMode=!this.overviewMode,this.overviewMode?(this.savedDistance=this.targetDistance,this.savedPhi=this.phi,this.targetDistance=this.overviewDistance,this.phi=this.overviewPhi,console.log("üî≠ Overview mode ON")):(this.targetDistance=this.savedDistance,this.phi=this.savedPhi,console.log("üî≠ Overview mode OFF"))}onPointerDown(e){this.isPointerDown=!0,this.previousPointer.x=e.clientX,this.previousPointer.y=e.clientY}onPointerMove(e){if(!this.isPointerDown)return;const s=e.clientX-this.previousPointer.x,t=e.clientY-this.previousPointer.y;this.theta-=s*.005,this.phi+=t*.005,this.phi=Math.max(this.settings.minPitch,Math.min(this.settings.maxPitch,this.phi)),this.previousPointer.x=e.clientX,this.previousPointer.y=e.clientY}onPointerUp(){this.isPointerDown=!1}onWheel(e){const s=Math.max(.01,this.targetDistance*.05);this.targetDistance+=e.deltaY>0?s:-s,this.targetDistance=Math.max(this.settings.minDistance,Math.min(this.settings.maxDistance,this.targetDistance)),this.overviewMode&&this.targetDistance<this.overviewDistance*.5&&(this.overviewMode=!1)}onTouchStart(e){this.touches=[...e.touches]}onTouchMove(e){if(e.touches.length===2&&this.touches.length===2){const s=Math.hypot(this.touches[0].clientX-this.touches[1].clientX,this.touches[0].clientY-this.touches[1].clientY),t=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);this.targetDistance-=(t-s)*.05,this.targetDistance=Math.max(this.settings.minDistance,Math.min(this.settings.maxDistance,this.targetDistance))}this.touches=[...e.touches]}onTouchEnd(){this.touches=[]}follow(e,s){if(!e)return;const t=e.position.clone(),n=this.experience.touchControls;if(n!=null&&n.isEnabled&&n.cameraJoystick.active){const l=n.getInput();this.theta-=l.cameraX,this.phi+=l.cameraY,this.phi=Math.max(this.settings.minPitch,Math.min(this.settings.maxPitch,this.phi))}const i=dt.lerp(this.settings.distance,this.targetDistance,this.settings.smoothness*2);this.settings.distance=i;const o=Math.sin(this.theta)*Math.cos(this.phi)*i,a=Math.sin(this.phi)*i+this.settings.height,r=Math.cos(this.theta)*Math.cos(this.phi)*i;this.targetPosition.set(t.x+o,t.y+a,t.z+r),this.initialized||(this.currentPosition.copy(this.targetPosition),this.currentLookAt.copy(t),this.currentLookAt.y+=1,this.initialized=!0);const c=this.overviewMode?this.settings.smoothness*3:this.settings.smoothness;this.currentPosition.lerp(this.targetPosition,c),this.camera.position.copy(this.currentPosition),this.lookAtPosition.copy(t),this.lookAtPosition.y+=1,this.currentLookAt.lerp(this.lookAtPosition,this.settings.rotationSmoothness),this.camera.lookAt(this.currentLookAt)}resize(){this.camera.aspect=this.sizes.width/this.sizes.height,this.camera.updateProjectionMatrix()}update(){}getForwardDirection(){const e=new y(0,0,-1);return e.applyQuaternion(this.camera.quaternion),e.y=0,e.normalize(),e}getRightDirection(){const e=new y(1,0,0);return e.applyQuaternion(this.camera.quaternion),e.y=0,e.normalize(),e}destroy(){this.canvas.removeEventListener("pointerdown",this._onPointerDown),window.removeEventListener("pointermove",this._onPointerMove),window.removeEventListener("pointerup",this._onPointerUp),this.canvas.removeEventListener("wheel",this._onWheel),this.canvas.removeEventListener("touchstart",this._onTouchStart),this.canvas.removeEventListener("touchmove",this._onTouchMove),this.canvas.removeEventListener("touchend",this._onTouchEnd),document.removeEventListener("keydown",this._onKeyDown)}}class En{constructor(){this.experience=new C,this.sizes=this.experience.sizes,this.scene=this.experience.scene,this.canvas=this.experience.canvas,this.setInstance(),this.setThirdPerson()}setInstance(){this.instance=new Kt(45,this.sizes.width/this.sizes.height,.1,5e3),this.instance.position.set(0,30,60),this.instance.lookAt(0,0,0),this.scene.add(this.instance)}setThirdPerson(){this.thirdPerson=new Tn(this.instance,this.canvas,{distance:30,height:15,smoothing:.08,minPolarAngle:-.3,maxPolarAngle:1.4,minDistance:8,maxDistance:800})}setControls(){this.controls=new vn(this.instance,this.canvas),this.controls.enableDamping=!0,this.controls.dampingFactor=.05,this.controls.minDistance=5,this.controls.maxDistance=60,this.controls.maxPolarAngle=Math.PI/2-.05,this.controls.target.set(0,0,0)}resize(){var e;this.instance.aspect=this.sizes.width/this.sizes.height,this.instance.updateProjectionMatrix(),(e=this.thirdPerson)==null||e.resize()}update(){}destroy(){var e,s;(e=this.thirdPerson)==null||e.destroy(),(s=this.controls)==null||s.dispose()}}class An{constructor(){this.experience=new C,this.canvas=this.experience.canvas,this.sizes=this.experience.sizes,this.scene=this.experience.scene,this.camera=this.experience.camera,this.setInstance()}setInstance(){this.instance=new _s({canvas:this.canvas,antialias:!1,alpha:!1,powerPreference:"high-performance"}),this.instance.setSize(this.sizes.width,this.sizes.height),this.instance.setPixelRatio(1),this.instance.toneMapping=Ps,this.instance.toneMappingExposure=1.1,this.instance.outputColorSpace=ne,this.instance.shadowMap.enabled=!0,this.instance.shadowMap.type=ks,this.instance.setClearColor("#87ceeb")}resize(){this.instance.setSize(this.sizes.width,this.sizes.height),this.instance.setPixelRatio(1)}update(){this.instance.render(this.scene,this.camera.instance)}}class Mn{constructor(){this.experience=new C,this.scene=this.experience.scene,this.presets={dawn:{sunColor:16753510,sunIntensity:1,sunPos:[50,30,80],fillColor:6719692,fillIntensity:.2,ambientColor:3351108,ambientIntensity:.4,hemiSky:16746581,hemiGround:2241348,hemiIntensity:.5,skyColor:16742212,fogColor:6702131,fogNear:200,fogFar:800},morning:{sunColor:16773324,sunIntensity:1.4,sunPos:[100,100,80],fillColor:8961006,fillIntensity:.25,ambientColor:5596757,ambientIntensity:.5,hemiSky:8965358,hemiGround:4482628,hemiIntensity:.6,skyColor:8965358,fogColor:6715238,fogNear:300,fogFar:1e3},noon:{sunColor:16774625,sunIntensity:1.8,sunPos:[120,180,80],fillColor:8965375,fillIntensity:.3,ambientColor:4876890,ambientIntensity:.5,hemiSky:8900331,hemiGround:2968125,hemiIntensity:.6,skyColor:8900331,fogColor:5929578,fogNear:300,fogFar:1200},afternoon:{sunColor:16771248,sunIntensity:1.5,sunPos:[150,120,-50],fillColor:7838139,fillIntensity:.25,ambientColor:5596740,ambientIntensity:.45,hemiSky:10075101,hemiGround:4478259,hemiIntensity:.55,skyColor:10075101,fogColor:6715221,fogNear:250,fogFar:1e3},dusk:{sunColor:16737843,sunIntensity:.9,sunPos:[-80,30,-100],fillColor:4469606,fillIntensity:.15,ambientColor:3351091,ambientIntensity:.35,hemiSky:13391155,hemiGround:2232610,hemiIntensity:.4,skyColor:13386786,fogColor:4465203,fogNear:150,fogFar:700},night:{sunColor:4482730,sunIntensity:.3,sunPos:[-50,80,-50],fillColor:2241365,fillIntensity:.1,ambientColor:1118498,ambientIntensity:.25,hemiSky:1122884,hemiGround:657941,hemiIntensity:.3,skyColor:657952,fogColor:657941,fogNear:100,fogFar:500}},this.currentPreset="noon",this.setupLights(),this.setupSkybox(),this.applyPreset("noon",!1)}setupLights(){this.sunLight=new nt(16777215,1.8),this.sunLight.castShadow=!0,this.sunLight.shadow.camera.far=200,this.sunLight.shadow.camera.left=-100,this.sunLight.shadow.camera.top=100,this.sunLight.shadow.camera.right=100,this.sunLight.shadow.camera.bottom=-100,this.sunLight.shadow.mapSize.set(1024,1024),this.sunLight.shadow.normalBias=.02,this.scene.add(this.sunLight),this.fillLight=new nt(8965375,.3),this.scene.add(this.fillLight),this.ambientLight=new Ls(4876890,.5),this.scene.add(this.ambientLight),this.hemisphereLight=new Ss(8900331,2968125,.6),this.scene.add(this.hemisphereLight),this.scene.fog=new Cs(5929578,300,1200)}setupSkybox(){const e=new G(2e3,12,12);this.skyMaterial=new L({color:8900331,side:Is}),this.sky=new b(e,this.skyMaterial),this.scene.add(this.sky)}setPreset(e){this.presets[e]&&this.applyPreset(e,!1)}applyPreset(e,s){const t=this.presets[e];t&&(this.currentPreset=e,this.sunLight.color.setHex(t.sunColor),this.sunLight.intensity=t.sunIntensity,this.sunLight.position.set(t.sunPos[0],t.sunPos[1],t.sunPos[2]),this.fillLight.color.setHex(t.fillColor),this.fillLight.intensity=t.fillIntensity,this.fillLight.position.set(-t.sunPos[0],t.sunPos[1]*.5,-t.sunPos[2]),this.ambientLight.color.setHex(t.ambientColor),this.ambientLight.intensity=t.ambientIntensity,this.hemisphereLight.color.setHex(t.hemiSky),this.hemisphereLight.groundColor.setHex(t.hemiGround),this.hemisphereLight.intensity=t.hemiIntensity,this.skyMaterial.color.setHex(t.skyColor),this.scene.fog.color.setHex(t.fogColor),this.scene.fog.near=t.fogNear,this.scene.fog.far=t.fogFar,console.log(`üå§Ô∏è Time of day: ${e}`))}}class _n{constructor(){this.experience=new C,this.scene=this.experience.scene,this.physics=this.experience.physics,this.jumpForce=8,this.canJump=!1,this.isMoving=!1,this.keys={forward:!1,backward:!1,left:!1,right:!1,jump:!1},this.setMesh(),this.setPhysics(),this.setControls(),this._forward=new y,this._right=new y,this._moveDir=new y,this._up=new y(0,1,0)}setMesh(){this.mesh=new X,this.mesh.name="Player";const e=new D({color:5227511,metalness:.5,roughness:.3,flatShading:!0}),s=new D({color:3622735,metalness:.4,roughness:.5,flatShading:!0}),t=new L({color:58879}),n=new b(new Xe(.3,.5,3,6),e);n.position.y=.55,n.castShadow=!0,this.mesh.add(n);const i=new b(new G(.25,6,6),e);i.position.y=1.1,i.castShadow=!0,this.mesh.add(i);const o=new G(.05,4,4),a=new b(o,t);a.position.set(-.08,1.15,.2),this.mesh.add(a);const r=new b(o,t);r.position.set(.08,1.15,.2),this.mesh.add(r);const c=new b(new V(.02,.02,.2,3),s);c.position.set(0,1.45,0),this.mesh.add(c);const l=new b(new G(.04,4,4),t);l.position.set(0,1.58,0),this.mesh.add(l);const h=new Xe(.06,.25,2,4);this.leftArm=new b(h,e),this.leftArm.position.set(-.4,.55,0),this.leftArm.rotation.z=.2,this.mesh.add(this.leftArm),this.rightArm=new b(h,e),this.rightArm.position.set(.4,.55,0),this.rightArm.rotation.z=-.2,this.mesh.add(this.rightArm);const u=new Xe(.08,.15,2,4);this.leftLeg=new b(u,s),this.leftLeg.position.set(-.12,.12,0),this.mesh.add(this.leftLeg),this.rightLeg=new b(u,s),this.rightLeg.position.set(.12,.12,0),this.mesh.add(this.rightLeg),this.mesh.position.set(0,6,50),this.scene.add(this.mesh)}setPhysics(){const e=new ze(.4);this.body=new R({mass:5,shape:e,position:new Z(0,6,50),linearDamping:.3,angularDamping:.99,fixedRotation:!0,material:this.physics.defaultMaterial}),this.body.allowSleep=!1,this.body.sleepState=0,this.body.addEventListener("collide",s=>{const t=s.contact,n=new Z;t.bi.id===this.body.id?t.ni.negate(n):n.copy(t.ni),n.y>.3&&(this.canJump=!0)}),this.physics.world.addBody(this.body),console.log("ü§ñ Player physics body added, id:",this.body.id,"sleepState:",this.body.sleepState)}setControls(){this._onKeyDown=e=>{(e.code==="KeyW"||e.code==="ArrowUp")&&(this.keys.forward=!0),(e.code==="KeyS"||e.code==="ArrowDown")&&(this.keys.backward=!0),(e.code==="KeyA"||e.code==="ArrowLeft")&&(this.keys.left=!0),(e.code==="KeyD"||e.code==="ArrowRight")&&(this.keys.right=!0),e.code==="Space"&&(this.keys.jump=!0,e.preventDefault())},this._onKeyUp=e=>{(e.code==="KeyW"||e.code==="ArrowUp")&&(this.keys.forward=!1),(e.code==="KeyS"||e.code==="ArrowDown")&&(this.keys.backward=!1),(e.code==="KeyA"||e.code==="ArrowLeft")&&(this.keys.left=!1),(e.code==="KeyD"||e.code==="ArrowRight")&&(this.keys.right=!1),e.code==="Space"&&(this.keys.jump=!1)},window.addEventListener("keydown",this._onKeyDown,!0),window.addEventListener("keyup",this._onKeyUp,!0),console.log("üéÆ Player controls registered")}teleport(e){this.body.position.set(e.x,e.y,e.z),this.body.velocity.set(0,0,0),this.mesh.position.set(e.x,e.y,e.z)}update(){var r;const e=(r=this.experience.camera)==null?void 0:r.instance;e&&e.updateMatrixWorld();const s=this._forward,t=this._right;e?(e.getWorldDirection(s),s.y=0,s.normalize(),t.crossVectors(s,this._up).normalize()):(s.set(0,0,-1),t.set(1,0,0));let n=0,i=0;this.keys.forward&&(i+=1),this.keys.backward&&(i-=1),this.keys.left&&(n-=1),this.keys.right&&(n+=1);const o=this.experience.touchControls;o!=null&&o.isEnabled&&o.moveJoystick.active&&(n+=o.getInput().moveX,i+=o.getInput().moveY),o!=null&&o.isEnabled&&o.jumpRequested&&(this.keys.jump=!0),this.isMoving=Math.abs(n)>0||Math.abs(i)>0,this.body.wakeUp();const a=15;if(this.isMoving){const c=this._moveDir;c.set(0,0,0),c.addScaledVector(s,i),c.addScaledVector(t,n),c.normalize();const l=this.body.velocity.y;this.body.velocity.set(c.x*a,l,c.z*a);const u=(Math.atan2(c.x,c.z)-this.mesh.rotation.y+Math.PI)%(Math.PI*2)-Math.PI;this.mesh.rotation.y+=u*.15}else this.body.velocity.set(this.body.velocity.x*.85,this.body.velocity.y,this.body.velocity.z*.85);if(this.keys.jump&&this.canJump&&(this.body.velocity.y=this.isMoving?this.jumpForce*.5:this.jumpForce,this.canJump=!1),this.mesh.position.copy(this.body.position),this.mesh.position.y-=.4,this.isMoving&&this.canJump){const c=performance.now()*.008,l=Math.sin(c*10)*.25;this.leftLeg.rotation.x=l,this.rightLeg.rotation.x=-l,this.leftArm.rotation.x=-l*.5,this.rightArm.rotation.x=l*.5}else this.leftLeg.rotation.x*=.85,this.rightLeg.rotation.x*=.85,this.leftArm.rotation.x*=.85,this.rightArm.rotation.x*=.85;this.body.position.y<-50&&this.teleport(new y(0,10,50))}dispose(){window.removeEventListener("keydown",this._onKeyDown,!0),window.removeEventListener("keyup",this._onKeyUp,!0),this.scene.remove(this.mesh),this.mesh.traverse(e=>{var s,t;e.isMesh&&((s=e.geometry)==null||s.dispose(),(t=e.material)==null||t.dispose())}),this.body&&this.physics.world.removeBody(this.body)}}class Pn{constructor(){this.experience=new C,this.scene=this.experience.scene,this.physics=this.experience.physics,this.group=new X,this.group.name="TestEnvironment",this.bodies=[],this.dynamicMeshes=[],this.animatedObjects=[],this.particles=[],this.portals=[],this.landmarks=[],this.zoneLabels=[],this.zones={HUB:{name:"The Nexus Clearing",center:new y(0,0,0),radius:24,color:16766720,elevation:0},Z1:{name:"CodeForge Ruins",center:new y(0,0,-180),radius:21,color:4886745,elevation:-1.5},Z2:{name:"Pixel Grove",center:new y(-180,0,0),radius:21,color:10181046,elevation:4.5},Z3:{name:"Neural Cavern",center:new y(180,0,0),radius:21,color:15277667,elevation:-3},Z4:{name:"Lumina Falls",center:new y(-150,0,180),radius:21,color:16750592,elevation:9},Z5:{name:"Beacon Spire",center:new y(150,0,180),radius:21,color:5025616,elevation:6},Z6:{name:"Origin Tree",center:new y(-100,0,300),radius:18,color:16758605,elevation:15},Z7:{name:"Echo Chamber",center:new y(100,0,300),radius:15,color:2541274,elevation:12}},this._matPool={},this._buildTerrain(),this._buildPaths(),this._buildZoneGrounds(),this._buildHubLandmark(),this._buildZ1Landmark(),this._buildZ2Landmark(),this._buildZ3Landmark(),this._buildZ4Landmark(),this._buildZ5Landmark(),this._buildZ6Landmark(),this._buildZ7Landmark(),this._buildPortals(),this._buildTrees(),this._buildRocks(),this._buildBoundaryWalls(),this._buildParticles(),this._buildSpawnMarker(),this._buildZoneLabels(),this.scene.add(this.group),this.physics.addZoneColliders(this.zones),this._terrainHeights&&this.physics.setHeightfield(this._terrainHeights,this._terrainSize,this._terrainSegs),console.log("üèóÔ∏è Production World loaded ‚Äî zones:",Object.keys(this.zones).length,"bodies:",this.bodies.length)}_mat(e,s,t={}){const n=`${e}_${s}`;return this._matPool[n]||(this._matPool[n]=new D({color:s,roughness:t.roughness??.7,metalness:t.metalness??0,flatShading:!0,...t})),this._matPool[n]}_bmat(e,s,t={}){const n=`b_${e}_${s}`;return this._matPool[n]||(this._matPool[n]=new L({color:s,...t})),this._matPool[n]}_addLight(e,s,t,n,i,o,a,r){const c=new b(new G(.3,6,6),new L({color:s,transparent:!0,opacity:Math.min(t*.3,.8)}));return c.position.set(o,a,r),e.add(c),c}_staticBox(e,s,t,n={}){const i=new K(s[0],s[1],s[2]),o=new b(i,this._mat("box",t,n));o.position.set(e[0],e[1],e[2]),n.rotY&&(o.rotation.y=n.rotY),n.rotX&&(o.rotation.x=n.rotX),o.castShadow=!1,o.receiveShadow=!0,this.group.add(o);const a=new he(new Z(s[0]/2,s[1]/2,s[2]/2)),r=new R({mass:0,shape:a,material:this.physics.defaultMaterial});return r.position.set(e[0],e[1],e[2]),n.rotY&&r.quaternion.setFromEuler(0,n.rotY,0),n.rotX&&r.quaternion.setFromEuler(n.rotX,0,0),this.physics.world.addBody(r),this.bodies.push(r),o}_staticCyl(e,s,t,n,i,o={}){const a=o.segments??8,r=new V(s,t,n,a),c=new b(r,this._mat("cyl",i,o));c.position.set(e[0],e[1],e[2]),c.castShadow=!1,c.receiveShadow=!0,this.group.add(c);const l=Math.max(s,t),h=new qe(l,l,n,6),u=new R({mass:0,shape:h,material:this.physics.defaultMaterial});return u.position.set(e[0],e[1],e[2]),this.physics.world.addBody(u),this.bodies.push(u),c}_buildTerrain(){const t=new U(1e3,1e3,64,64);t.rotateX(-Math.PI/2);const n=t.attributes.position,i=new Float32Array(n.count*3),o=new H(2968125),a=new H;for(let l=0;l<n.count;l++){const h=n.getX(l),u=n.getZ(l);let m=Math.sin(h*.008)*Math.cos(u*.006)*6+Math.sin(h*.015+u*.012)*3;a.copy(o);for(const f of Object.values(this.zones)){const g=h-f.center.x,w=u-f.center.z,x=Math.sqrt(g*g+w*w);if(x<f.radius*2){const T=1-Math.min(x/(f.radius*2),1);m+=f.elevation*T*T*(3-2*T)}x<f.radius*1.5&&a.lerp(new H(f.color),(1-x/(f.radius*1.5))*.15)}n.setY(l,m),i[l*3]=a.r,i[l*3+1]=a.g,i[l*3+2]=a.b}t.setAttribute("color",new se(i,3)),t.computeVertexNormals();const r=new b(t,new D({vertexColors:!0,roughness:.85,flatShading:!0}));r.receiveShadow=!1,r.name="Terrain",this.group.add(r),this._terrainSize=1e3,this._terrainSegs=64,this._terrainHeights=new Float32Array(65*65);for(let l=0;l<n.count;l++)this._terrainHeights[l]=n.getY(l);const c=new Rs(1e3,1e3/2,3824202,2767402);c.material.opacity=.08,c.material.transparent=!0,c.position.y=.02,this.group.add(c)}_buildPaths(){const e=this._mat("path",9139029,{roughness:.9});[{from:[0,0,50],to:[0,0,-110],w:8},{from:[0,0,-110],to:[0,0,-160],w:8},{from:[-40,0,0],to:[-110,0,0],w:6},{from:[-110,0,0],to:[-160,0,0],w:6},{from:[40,0,0],to:[110,0,0],w:6},{from:[110,0,0],to:[160,0,0],w:6},{from:[-30,0,30],to:[-120,0,150],w:5},{from:[-120,0,150],to:[-140,0,170],w:5},{from:[30,0,30],to:[120,0,150],w:5},{from:[120,0,150],to:[140,0,170],w:5},{from:[-130,0,220],to:[-100,0,280],w:4},{from:[130,0,220],to:[100,0,280],w:4},{from:[-80,0,300],to:[80,0,300],w:4}].forEach(t=>{const n=new y(t.from[0],.05,t.from[2]),i=new y(t.to[0],.05,t.to[2]),o=i.clone().sub(n),a=o.length();o.normalize();const r=new U(t.w,a);r.rotateX(-Math.PI/2);const c=new b(r,e);c.position.copy(n.clone().add(i).multiplyScalar(.5)),c.rotation.y=-Math.atan2(o.z,o.x)+Math.PI/2,c.receiveShadow=!0,this.group.add(c);const l=Math.floor(a/3);for(let h=0;h<=l;h++){const u=h/Math.max(l,1),m=n.clone().lerp(i,u),f=new y(-o.z,0,o.x);for(const g of[-1,1]){const w=m.clone().add(f.clone().multiplyScalar(g*t.w*.55)),x=new b(new G(.12+Math.random()*.08,4,3),this._mat("stone",7035706));x.position.set(w.x,.08,w.z),x.scale.y=.5,this.group.add(x)}}})}_buildZoneGrounds(){for(const[e,s]of Object.entries(this.zones)){const t=s.elevation,n=new it(s.radius-.4,s.radius,32);n.rotateX(-Math.PI/2);const i=new b(n,new L({color:s.color,transparent:!0,opacity:.2,side:B}));i.position.set(s.center.x,t+.1,s.center.z),this.group.add(i);const o=new we(s.radius*.85,24);o.rotateX(-Math.PI/2);const a=new b(o,new L({color:s.color,transparent:!0,opacity:.06,side:B}));a.position.set(s.center.x,t+.08,s.center.z),this.group.add(a);const r=2.5,c=new b(new V(.06,.08,r,5),this._mat("pole",s.color,{emissive:s.color,emissiveIntensity:.25}));c.position.set(s.center.x,t+r/2,s.center.z),c.castShadow=!1,c.userData={isInteractable:!0,zoneId:e,zoneName:s.name},this.group.add(c);const l=new b(new G(.18,8,8),this._bmat("orb",s.color));l.position.set(s.center.x,t+r+.2,s.center.z),this.group.add(l),this.landmarks.push(c)}}_buildHubLandmark(){const{center:{x:e,z:s},elevation:t}=this.zones.HUB,n=new b(new Pe(1.2,0),new D({color:16766720,emissive:16766720,emissiveIntensity:.3,metalness:.8,roughness:.2,transparent:!0,opacity:.85,flatShading:!0}));n.position.set(e,t+3.5,s),n.castShadow=!1,this.group.add(n),this.animatedObjects.push({mesh:n,type:"rotate_float",speed:.3,amplitude:.3});const i=new b(new G(.4,6,6),new L({color:16766720,transparent:!0,opacity:.4}));i.position.set(e,t+3.5,s),this.group.add(i);for(let a=0;a<6;a++){const r=a/6*Math.PI*2,c=e+Math.cos(r)*5,l=s+Math.sin(r)*5;this._staticCyl([c,t+.8,l],.25,.35,1.6,6052956,{roughness:.9,segments:5});const h=new b(new K(.15,.02,.15),this._bmat("rune",16766720,{transparent:!0,opacity:.6}));h.position.set(c,t+1.65,l),this.group.add(h),this.animatedObjects.push({mesh:h,type:"pulse",speed:.5+a*.15})}["Z1","Z2","Z3","Z4","Z5","Z6","Z7"].forEach(a=>{const r=this.zones[a],c=r.center.clone().sub(this.zones.HUB.center).normalize(),l=e+c.x*3.5,h=s+c.z*3.5,u=new b(new K(.08,1.5,.08),this._mat("post",6636321));u.position.set(l,t+.75,h),u.castShadow=!1,this.group.add(u);const m=new Ct(.15,.4,4);m.rotateZ(-Math.PI/2);const f=new b(m,this._bmat("arrow",r.color));f.position.set(l,t+1.4,h),f.lookAt(new y(r.center.x,t+1.4,r.center.z)),this.group.add(f)}),this._staticBox([e+2,t+.3,s+4],[1.2,.6,.8],8026746,{roughness:.95})}_buildZ1Landmark(){const{center:{x:e,z:s},elevation:t}=this.zones.Z1,n=new b(new K(1,6,.6),new D({color:2899536,emissive:4886745,emissiveIntensity:.15,metalness:.6,roughness:.3,flatShading:!0}));n.position.set(e,t+3,s),n.castShadow=!1,this.group.add(n);const i=new R({mass:0,shape:new he(new Z(.5,3,.3)),material:this.physics.defaultMaterial});i.position.set(e,t+3,s),this.physics.world.addBody(i),this.bodies.push(i),this._addLight(this.group,4886745,1.5,10,2,e,t+5,s);for(let c=0;c<8;c++){const l=new b(new K(.3+Math.random()*.4,.03,.03),this._bmat("code",6992127,{transparent:!0,opacity:.5}));l.position.set(e+(Math.random()-.5)*.6,t+1+c*.6,s+.35),this.group.add(l),this.animatedObjects.push({mesh:l,type:"code_scroll",speed:.5+Math.random()*.5,originY:l.position.y,maxY:t+5.5,minY:t+.5})}const o=[[e-4,s-2],[e+4,s-2],[e-3,s+3],[e+3,s+3],[e-5,s+1],[e+5,s-1]];o.forEach(([c,l])=>{const h=1.5+Math.random()*2.5;if(this._staticCyl([c,t+h/2,l],.2,.3,h,4874368,{segments:5}),Math.random()>.5){const u=new b(new K(.5,.15,.5),this._mat("cap",5596791));u.position.set(c,t+h+.08,l),u.rotation.y=Math.random()*Math.PI,this.group.add(u)}}),[[e-3,s-1],[e+3,s-1],[e,s+4]].forEach(([c,l])=>{const h=new b(new U(1.2,.8),new L({color:4886745,transparent:!0,opacity:.3,side:B}));h.position.set(c,t+1.2,l),h.lookAt(new y(e,t+1.2,s)),this.group.add(h),this.animatedObjects.push({mesh:h,type:"flicker",speed:2}),this._staticBox([c,t+.4,l],[.15,.8,.15],3622735)});const r=new Ie({color:6992127,transparent:!0,opacity:.3});for(let c=0;c<Math.min(3,Math.floor(o.length/2));c++){const l=o[c*2],h=o[c*2+1];if(!l||!h)break;const u=[];for(let m=0;m<=6;m++){const f=m/6;u.push(new y(l[0]+(h[0]-l[0])*f,t+2+Math.sin(f*Math.PI)*.8+(Math.random()-.5)*.3,l[1]+(h[1]-l[1])*f))}this.group.add(new Re(new oe().setFromPoints(u),r))}}_buildZ2Landmark(){const{center:{x:e,z:s},elevation:t}=this.zones.Z2,n=[8069026,10233776,11225020,13538264];this._staticCyl([e,t+2,s],.3,.5,4,6044186,{segments:5});for(let a=0;a<4;a++){const r=2.5-a*.5,c=new b(new Pe(r,0),new D({color:n[a],emissive:n[a],emissiveIntensity:.1,flatShading:!0,transparent:!0,opacity:.85}));c.position.set(e,t+5+a*1.5,s),c.rotation.y=a*.5,c.castShadow=!1,this.group.add(c),this.animatedObjects.push({mesh:c,type:"slow_rotate",speed:.15+a*.05})}const i=new R({mass:0,shape:new he(new Z(2.5,4,2.5)),material:this.physics.defaultMaterial});i.position.set(e,t+7,s),this.physics.world.addBody(i),this.bodies.push(i);for(let a=0;a<12;a++){const r=Math.random()*Math.PI*2,c=1.5+Math.random()*2,l=.2+Math.random()*.3,h=new b(new K(l,l,l),this._bmat("leaf",n[a%4],{transparent:!0,opacity:.6}));h.position.set(e+Math.cos(r)*c,t+5+Math.random()*5,s+Math.sin(r)*c),this.group.add(h),this.animatedObjects.push({mesh:h,type:"spin_cube",speed:.5+Math.random()*1.5})}[[e-4,s+2],[e+4,s-2]].forEach(([a,r])=>{this._staticBox([a,t+.8,r],[.8,1.6,.6],4854924);const c=new b(new U(.6,.4),this._bmat("ascreen",13538264,{transparent:!0,opacity:.5}));c.position.set(a,t+1.2,r+.31),this.group.add(c),this.animatedObjects.push({mesh:c,type:"flicker",speed:3})});for(let a=0;a<5;a++){const r=new b(new V(.12,.12,.04,8),this._bmat("coin",16766720));r.position.set(e+(Math.random()-.5)*10,t+1+Math.random()*2,s+(Math.random()-.5)*10),r.rotation.x=Math.PI/2,this.group.add(r),this.animatedObjects.push({mesh:r,type:"rotate_float",speed:2,amplitude:.15})}this._addLight(this.group,10181046,1,12,2,e,t+6,s)}_buildZ3Landmark(){const{center:{x:e,z:s},elevation:t}=this.zones.Z3,n=new b(new We(1.5,1),new D({color:15277667,emissive:16728193,emissiveIntensity:.35,metalness:.7,roughness:.15,transparent:!0,opacity:.75,flatShading:!0}));n.position.set(e,t+4,s),n.castShadow=!1,this.group.add(n),this.animatedObjects.push({mesh:n,type:"rotate_float",speed:.2,amplitude:.4}),this._addLight(this.group,15277667,2,15,2,e,t+4,s);const i=new R({mass:0,shape:new ze(1.5),material:this.physics.defaultMaterial});i.position.set(e,t+4,s),this.physics.world.addBody(i),this.bodies.push(i);for(let o=0;o<8;o++){const a=o/8*Math.PI*2,r=3+Math.random()*2.5,c=e+Math.cos(a)*r,l=s+Math.sin(a)*r,h=t+1.5+Math.random()*2,u=new b(new G(.2,6,6),this._bmat("synapse",16728193,{transparent:!0,opacity:.5}));u.position.set(c,h,l),this.group.add(u),this.animatedObjects.push({mesh:u,type:"pulse",speed:.8+o*.1}),this.group.add(new Re(new oe().setFromPoints([new y(e,t+4,s),new y(c,h,l)]),new Ie({color:16728193,transparent:!0,opacity:.2})))}for(let o=0;o<6;o++){const a=o/6*Math.PI*2,r=this.zones.Z3.radius*.7,c=e+Math.cos(a)*r,l=s+Math.sin(a)*r,h=.8+Math.random()*1.5,u=new b(new Ct(.15+Math.random()*.15,h,4),this._mat("crystal",15277667,{emissive:15277667,emissiveIntensity:.2,metalness:.5}));u.position.set(c,t+h/2,l),u.castShadow=!1,this.group.add(u)}for(let o=0;o<4;o++){const a=o/4*Math.PI*2+Math.PI/4,r=this.zones.Z3.radius-.5;this._staticBox([e+Math.cos(a)*r,t+1.5,s+Math.sin(a)*r],[2.5,3,.4],3947610,{rotY:a+Math.PI/2,roughness:.95})}}_buildZ4Landmark(){const{center:{x:e,z:s},elevation:t}=this.zones.Z4;this._staticBox([e,t+1.5,s-2],[5,3,1.5],7033408,{roughness:.95});const n=new L({color:5227511,transparent:!0,opacity:.35,side:B});for(let c=0;c<3;c++){const l=new b(new U(.8+c*.3,3),n);l.position.set(e+(c-1)*.7,t+1.5,s-1.24),this.group.add(l),this.animatedObjects.push({mesh:l,type:"waterfall",speed:1.5+c*.3})}const i=new we(2.5,16);i.rotateX(-Math.PI/2);const o=new b(i,new L({color:166097,transparent:!0,opacity:.4}));o.position.set(e,t+.05,s-3),this.group.add(o),[[e-3,s+2],[e+3,s+3]].forEach(([c,l])=>{const h=new b(new be(.8,.12,6,12),this._mat("reel",16750592,{metalness:.4}));h.position.set(c,t+.3,l),h.rotation.x=Math.PI/2,this.group.add(h),this.animatedObjects.push({mesh:h,type:"slow_rotate",speed:.3});const u=new b(new V(.3,.3,.1,8),this._mat("reelc",15094016));u.position.set(c,t+.3,l),this.group.add(u)});const r=new X;r.position.set(e+2,t+4,s+1),r.add(new b(new K(.5,.2,.5),this._mat("drone",3622735,{metalness:.5})));for(let c=0;c<4;c++){const l=c/4*Math.PI*2+Math.PI/4,h=new b(new K(.06,.04,.4),this._mat("arm",4545124));h.position.set(Math.cos(l)*.35,.1,Math.sin(l)*.35),h.lookAt(new y(0,0,0)),r.add(h)}this.group.add(r),this.animatedObjects.push({mesh:r,type:"drone_hover",speed:1,originPos:r.position.clone()}),this._addLight(this.group,16750592,1.5,12,2,e,t+3,s)}_buildZ5Landmark(){const{center:{x:e,z:s},elevation:t}=this.zones.Z5;this._staticBox([e,t+1,s],[2,2,2],3046706,{roughness:.8}),this._staticCyl([e,t+5,s],.3,.5,6,3706428,{segments:6});const n=new b(new Pe(.6,0),new D({color:5025616,emissive:8505220,emissiveIntensity:.5,metalness:.5,roughness:.2,flatShading:!0}));n.position.set(e,t+8.5,s),n.castShadow=!1,this.group.add(n),this.animatedObjects.push({mesh:n,type:"rotate_float",speed:1,amplitude:.1}),this._addLight(this.group,5025616,3,25,2,e,t+9,s);for(let o=0;o<3;o++){const a=new b(new be(1.5+o*1.2,.03,4,16),this._bmat("signal",8505220,{transparent:!0,opacity:.2-o*.05}));a.position.set(e,t+7+o*.5,s),a.rotation.x=Math.PI/2,this.group.add(a),this.animatedObjects.push({mesh:a,type:"expand_ring",speed:.3+o*.1,maxScale:2.5})}[{pos:[e-4,t+2,s+2],r:.3},{pos:[e+4,t+2.5,s-1],r:-.4}].forEach(o=>{const a=new b(new U(1.5,1),this._mat("billboard",3046706,{emissive:5025616,emissiveIntensity:.15}));a.position.set(o.pos[0],o.pos[1],o.pos[2]),a.rotation.y=o.r,this.group.add(a),this._staticBox([o.pos[0],t+1,o.pos[2]],[.1,2,.1],6111287)})}_buildZ6Landmark(){const{center:{x:e,z:s},elevation:t}=this.zones.Z6;this._staticCyl([e,t+3,s],.8,1.2,6,6111287,{segments:7}),[{r:3.5,y:t+8,c:16748288},{r:3,y:t+9.5,c:16754470},{r:2,y:t+11,c:16758605}].forEach(a=>{const r=new b(new We(a.r,1),new D({color:a.c,emissive:a.c,emissiveIntensity:.08,flatShading:!0,transparent:!0,opacity:.7}));r.position.set(e,a.y,s),r.castShadow=!1,this.group.add(r)});const i=new R({mass:0,shape:new ze(3.5),material:this.physics.defaultMaterial});i.position.set(e,t+8,s),this.physics.world.addBody(i),this.bodies.push(i);const o=new b(new G(.4,8,8),this._bmat("heart",16758605,{transparent:!0,opacity:.6}));o.position.set(e,t+2,s),this.group.add(o),this.animatedObjects.push({mesh:o,type:"pulse",speed:.4}),this._addLight(this.group,16758605,1.5,8,2,e,t+2,s);for(let a=0;a<5;a++){const r=a/5*Math.PI*2,c=2+Math.random()*1.5,l=new b(new V(.05,.15,c,4),this._mat("root",6111287));l.position.set(e+Math.cos(r)*1.2,t+.3,s+Math.sin(r)*1.2),l.rotation.z=Math.cos(r)*.5,l.rotation.x=Math.sin(r)*.5,this.group.add(l)}for(let a=0;a<3;a++){const r=a/3*Math.PI*2,c=e+Math.cos(r)*3,l=s+Math.sin(r)*3,h=new b(new K(.8,.6,.05),this._mat("frame",9268835));h.position.set(c,t+1.5,l),h.lookAt(new y(e,t+1.5,s)),this.group.add(h);const u=new b(new U(.6,.4),this._bmat("photo",16758605,{transparent:!0,opacity:.3}));u.position.set(c,t+1.5,l),u.lookAt(new y(e,t+1.5,s)),this.group.add(u)}}_buildZ7Landmark(){const{center:{x:e,z:s},elevation:t}=this.zones.Z7,n=new b(new Pe(1,0),new D({color:2541274,emissive:2541274,emissiveIntensity:.4,metalness:.6,roughness:.15,transparent:!0,opacity:.8,flatShading:!0}));n.position.set(e,t+3,s),n.castShadow=!1,this.group.add(n),this.animatedObjects.push({mesh:n,type:"rotate_float",speed:.5,amplitude:.25});const i=new R({mass:0,shape:new ze(1),material:this.physics.defaultMaterial});i.position.set(e,t+3,s),this.physics.world.addBody(i),this.bodies.push(i),this._addLight(this.group,2541274,2,15,2,e,t+3,s);for(let a=0;a<4;a++){const r=new b(new be(1.5+a*1,.03,4,24),this._bmat("echo",2541274,{transparent:!0,opacity:.15-a*.03}));r.position.set(e,t+3,s),r.rotation.x=Math.PI/2,this.group.add(r),this.animatedObjects.push({mesh:r,type:"expand_ring",speed:.2+a*.08,maxScale:3})}for(let a=0;a<5;a++){const r=a/5*Math.PI+Math.PI*.75,c=this.zones.Z7.radius-.5,l=2+Math.random()*1.5;this._staticBox([e+Math.cos(r)*c,t+l/2,s+Math.sin(r)*c],[1.8,l,.3],1731450,{rotY:r+Math.PI/2,emissive:2541274,emissiveIntensity:.05,metalness:.3})}const o=[1942002,4351922,14757996,30645];for(let a=0;a<4;a++){const r=a/4*Math.PI*2,c=e+Math.cos(r)*2.5,l=s+Math.sin(r)*2.5;this._staticCyl([c,t+1,l],.12,.15,2,o[a],{segments:4}),this.group.add(new Re(new oe().setFromPoints([new y(c,t+2,l),new y(e,t+3,s)]),new Ie({color:2541274,transparent:!0,opacity:.15})))}}_buildPortals(){const e=[{id:"P1",to:"Z1",pos:[0,0,-5],rotY:0},{id:"P2",to:"Z2",pos:[-5,0,0],rotY:Math.PI/2},{id:"P3",to:"Z3",pos:[5,0,0],rotY:-Math.PI/2},{id:"P4",to:"Z4",pos:[-4,0,4],rotY:Math.PI/4},{id:"P5",to:"Z5",pos:[4,0,4],rotY:-Math.PI/4}],s=this._mat("arch",6636321,{roughness:.9});e.forEach(t=>{var u,m;const n=new X;n.position.set(t.pos[0],0,t.pos[2]),n.rotation.y=t.rotY;const i=new b(new be(1.4,.12,4,12,Math.PI),s);i.rotation.x=Math.PI,i.position.y=1.4,n.add(i);const o=new V(.12,.15,2.8,5),a=new b(o,s);a.position.set(-1.4,1.4,0),a.castShadow=!1,n.add(a);const r=new b(o,s);r.position.set(1.4,1.4,0),r.castShadow=!1,n.add(r);const c=((u=this.zones[t.to])==null?void 0:u.color)||4886745,l=new b(new we(1.1,16),new L({color:c,transparent:!0,opacity:.35,side:B}));l.position.y=1.4,n.add(l),this.animatedObjects.push({mesh:l,type:"portal_pulse",speed:1.5}),this._addLight(n,c,.8,6,2,0,1.4,0);const h=new qe(.15,.15,2.8,5);for(const f of[-1.4,1.4]){const g=new y(f,1.4,0).applyAxisAngle(new y(0,1,0),t.rotY),w=new R({mass:0,shape:h,material:this.physics.defaultMaterial});w.position.set(t.pos[0]+g.x,1.4,t.pos[2]+g.z),this.physics.world.addBody(w),this.bodies.push(w)}n.userData={isPortal:!0,portalId:t.id,toZone:t.to,destination:((m=this.zones[t.to])==null?void 0:m.center.clone().setY(2))||new y(0,2,0)},this.group.add(n),this.portals.push(n)})}_buildTrees(){const e=[];for(let h=0;h<600;h++){const u=(Math.random()-.5)*450*2,m=(Math.random()-.5)*450*2;let f=!1;for(const w of Object.values(this.zones)){const x=u-w.center.x,T=m-w.center.z;if(Math.sqrt(x*x+T*T)<35){f=!0;break}}if(f)continue;let g=!1;for(const w of e)if(Math.sqrt((u-w[0])**2+(m-w[1])**2)<8){g=!0;break}g||e.push([u,m])}const o=new V(.3,.6,8,4),a=new De(o,this._mat("trunk",6044186,{roughness:.95}),e.length);a.castShadow=!0,a.receiveShadow=!0;const r=new We(3.6,0),c=new De(r,this._mat("treecanopy",1793568,{roughness:.85}),e.length);c.castShadow=!0;const l=new Oe;e.forEach(([h,u],m)=>{const f=.6+Math.random()*.8,g=8*f;if(l.position.set(h,g/2,u),l.scale.set(f,f,f),l.rotation.y=Math.random()*Math.PI,l.updateMatrix(),a.setMatrixAt(m,l.matrix),l.position.set(h,g+2.4*f,u),l.scale.set(f*1.2,f*(.8+Math.random()*.5),f*1.2),l.updateMatrix(),c.setMatrixAt(m,l.matrix),f>.8){const w=new qe(.45*f,.75*f,g,4),x=new R({mass:0,shape:w,material:this.physics.defaultMaterial});x.position.set(h,g/2,u),this.physics.world.addBody(x),this.bodies.push(x)}}),this.group.add(a),this.group.add(c),console.log(`üå≤ Placed ${e.length} trees (instanced)`)}_buildRocks(){const s=new Ds(3,0),t=new De(s,this._mat("rock",5921370,{roughness:.95}),150);t.castShadow=!1,t.receiveShadow=!0;const n=new Oe;for(let i=0;i<150;i++){const o=(Math.random()-.5)*840,a=(Math.random()-.5)*840,r=.3+Math.random()*.8;n.position.set(o,r*.3,a),n.scale.set(r*(.8+Math.random()*.4),r*.5,r*(.8+Math.random()*.4)),n.rotation.set(Math.random(),Math.random(),Math.random()),n.updateMatrix(),t.setMatrixAt(i,n.matrix)}this.group.add(t)}_buildBoundaryWalls(){const t=[{pos:[0,10,-500],size:[1e3,20,2]},{pos:[0,10,500],size:[1e3,20,2]},{pos:[-500,10,0],size:[2,20,1e3]},{pos:[500,10,0],size:[2,20,1e3]}],n=new L({color:2968125,transparent:!0,opacity:.2,side:B});t.forEach(i=>{const o=new he(new Z(i.size[0]/2,i.size[1]/2,i.size[2]/2)),a=new R({mass:0,shape:o,material:this.physics.defaultMaterial});a.position.set(i.pos[0],i.pos[1],i.pos[2]),this.physics.world.addBody(a),this.bodies.push(a);const r=new U(Math.max(i.size[0],i.size[2]),i.size[1]),c=new b(r,n);c.position.set(i.pos[0],i.pos[1],i.pos[2]),i.size[2]>=1&&(c.rotation.y=Math.PI/2),this.group.add(c)})}_buildParticles(){const s=new oe,t=new Float32Array(100*3),n=[];for(let h=0;h<100;h++)t[h*3]=(Math.random()-.5)*600,t[h*3+1]=1.5+Math.random()*12,t[h*3+2]=(Math.random()-.5)*60,n.push({sx:(Math.random()-.5)*.02,sy:(Math.random()-.5)*.01,sz:(Math.random()-.5)*.02,phase:Math.random()*Math.PI*2});s.setAttribute("position",new se(t,3));const i=new ot(s,new at({color:16769154,size:.15,transparent:!0,opacity:.8,sizeAttenuation:!0,blending:zs,depthWrite:!1}));i.name="Fireflies",this.group.add(i),this.particles.push({points:i,speeds:n,type:"firefly"});const o=60,a=new oe,r=new Float32Array(o*3),c=[];for(let h=0;h<o;h++)r[h*3]=(Math.random()-.5)*500,r[h*3+1]=3+Math.random()*18,r[h*3+2]=(Math.random()-.5)*500,c.push({sx:(Math.random()-.5)*.02,sy:Math.random()*.01,sz:(Math.random()-.5)*.02,phase:Math.random()*Math.PI*2});a.setAttribute("position",new se(r,3));const l=new ot(a,new at({color:16777215,size:.3,transparent:!0,opacity:.5,sizeAttenuation:!0,depthWrite:!1}));l.name="Pollen",this.group.add(l),this.particles.push({points:l,speeds:c,type:"pollen"})}_buildSpawnMarker(){const e=new it(2,2.5,16);e.rotateX(-Math.PI/2);const s=new b(e,this._bmat("spawn",58998,{transparent:!0,opacity:.4}));s.position.set(0,.15,50),this.group.add(s),this.animatedObjects.push({mesh:s,type:"pulse",speed:.6});const t=new we(1,8);t.rotateX(-Math.PI/2);const n=new b(t,this._bmat("spawndot",58998,{transparent:!0,opacity:.25}));n.position.set(0,.16,50),this.group.add(n),this._addLight(this.group,58998,1.5,15,2,0,3,50)}_buildZoneLabels(){for(const[e,s]of Object.entries(this.zones)){const t=this._createTextSprite(s.name,s.color);t.position.set(s.center.x,s.elevation+25,s.center.z),t.userData={baseY:s.elevation+25,phase:Math.random()*Math.PI*2},this.group.add(t),this.zoneLabels.push(t)}}_createTextSprite(e,s){const t=document.createElement("canvas"),n=t.getContext("2d");t.width=512,t.height=128;const i=n.createLinearGradient(0,0,0,t.height);i.addColorStop(0,"rgba(0,0,0,0)"),i.addColorStop(.5,"rgba(0,0,0,0.3)"),i.addColorStop(1,"rgba(0,0,0,0)"),n.fillStyle=i,n.fillRect(0,0,t.width,t.height),n.font="bold 48px Georgia, serif",n.textAlign="center",n.textBaseline="middle",n.shadowColor=`#${s.toString(16).padStart(6,"0")}`,n.shadowBlur=20,n.shadowOffsetX=0,n.shadowOffsetY=0,n.strokeStyle="#1a1a2e",n.lineWidth=6,n.strokeText(e,t.width/2,t.height/2);const o=`#${s.toString(16).padStart(6,"0")}`;n.fillStyle=o,n.fillText(e,t.width/2,t.height/2);const a=new Vt(t);a.minFilter=Te;const r=new Fs({map:a,transparent:!0,opacity:.9,depthTest:!0,depthWrite:!1}),c=new Os(r);return c.scale.set(24,6,1),c.name=`Label_${e}`,c}getZoneAtPosition(e){for(const[s,t]of Object.entries(this.zones)){const n=e.x-t.center.x,i=e.z-t.center.z;if(Math.sqrt(n*n+i*i)<=t.radius)return{id:s,...t}}return null}getPortalsNearPosition(e,s=2.5){return this.portals.filter(t=>t.position.distanceTo(e)<=s)}getZoneSpawnPoint(e){const s=this.zones[e];return s?s.center.clone().setY(s.elevation+2):new y(0,2,5)}update(){var s;const e=performance.now()*.001;for(const t of this.animatedObjects){const n=t.mesh;switch(t.type){case"rotate_float":n.rotation.y+=t.speed*.01,n.position.y+=Math.sin(e*t.speed)*t.amplitude*.005;break;case"slow_rotate":n.rotation.y+=t.speed*.005;break;case"pulse":{const i=1+Math.sin(e*t.speed*2)*.15;n.scale.set(i,i,i),((s=n.material)==null?void 0:s.opacity)!==void 0&&(n.material.opacity=.4+Math.sin(e*t.speed*2)*.2);break}case"flicker":n.material&&(n.material.opacity=.25+Math.sin(e*t.speed*5)*.15+Math.sin(e*t.speed*13)*.05);break;case"code_scroll":n.position.y+=.01*t.speed,n.position.y>t.maxY&&(n.position.y=t.minY);break;case"spin_cube":n.rotation.x+=t.speed*.01,n.rotation.z+=t.speed*.008;break;case"portal_pulse":n.material&&(n.material.opacity=.25+Math.sin(e*t.speed)*.12);break;case"expand_ring":{const i=e*t.speed%(Math.PI*2),o=1+i/(Math.PI*2)*(t.maxScale-1);n.scale.set(o,o,1),n.material&&(n.material.opacity=.15*(1-i/(Math.PI*2)));break}case"waterfall":n.material&&(n.material.opacity=.25+Math.sin(e*t.speed*3)*.1);break;case"drone_hover":n.position.x=t.originPos.x+Math.sin(e*.5)*1.5,n.position.y=t.originPos.y+Math.sin(e*.8)*.3,n.position.z=t.originPos.z+Math.cos(e*.4)*1,n.rotation.y+=.005;break}}for(const t of this.particles){const n=t.points.geometry.attributes.position;for(let i=0;i<n.count;i++){const o=t.speeds[i];t.type==="firefly"?(n.array[i*3]+=Math.sin(e*2+o.phase)*o.sx,n.array[i*3+1]+=Math.sin(e*1.5+o.phase)*o.sy,n.array[i*3+2]+=Math.cos(e*2+o.phase)*o.sz):(n.array[i*3]+=o.sx,n.array[i*3+1]+=Math.sin(e*.5+o.phase)*o.sy,n.array[i*3+2]+=o.sz,n.array[i*3]>250&&(n.array[i*3]=-250),n.array[i*3]<-250&&(n.array[i*3]=250),n.array[i*3+2]>250&&(n.array[i*3+2]=-250),n.array[i*3+2]<-250&&(n.array[i*3+2]=250))}n.needsUpdate=!0}for(const t of this.zoneLabels){const{baseY:n,phase:i}=t.userData;t.position.y=n+Math.sin(e*.5+i)*1.5}for(const{mesh:t,body:n}of this.dynamicMeshes)t.position.copy(n.position),t.quaternion.copy(n.quaternion)}dispose(){this.bodies.forEach(e=>this.physics.world.removeBody(e)),this.bodies=[],this.physics.removeZoneColliders(),this.group.traverse(e=>{var s,t,n,i;(e.isMesh||e.isInstancedMesh||e.isLine||e.isPoints||e.isSprite)&&((s=e.geometry)==null||s.dispose(),Array.isArray(e.material)?e.material.forEach(o=>{var a;(a=o.map)==null||a.dispose(),o.dispose()}):((n=(t=e.material)==null?void 0:t.map)==null||n.dispose(),(i=e.material)==null||i.dispose()))}),this.scene.remove(this.group);for(const e of Object.values(this._matPool))e.dispose();this._matPool={},this.animatedObjects=[],this.particles=[],this.portals=[],this.landmarks=[],this.dynamicMeshes=[],this.zoneLabels=[],console.log("üßπ Production World disposed")}}class kn{constructor(){this.experience=new C,this.scene=this.experience.scene,this.resources=this.experience.resources,this.physics=this.experience.physics,this.group=new X,this.group.name="ForestEnvironment",this.portals=[],this.landmarks=[],this.bodies=[],this.targetWorldSize=80,this.zones={HUB:{name:"Central Hub",center:new y(0,0,0),radius:8,color:16766720},Z1:{name:"IT Services",center:new y(0,0,-18),radius:6,color:4886745},Z2:{name:"Game Dev",center:new y(-18,0,0),radius:6,color:10181046},Z3:{name:"AI Automation",center:new y(18,0,0),radius:6,color:15277667},Z4:{name:"Media",center:new y(-15,0,18),radius:6,color:16750592},Z5:{name:"Marketing",center:new y(15,0,18),radius:6,color:5025616},Z6:{name:"About",center:new y(-10,0,30),radius:5,color:16758605},Z7:{name:"Contact",center:new y(10,0,30),radius:5,color:2541274}},this.loadForest(),this.createZoneMarkers(),this.createPortals(),this.scene.add(this.group),console.log("üå≥ Forest Environment loaded")}loadForest(){const e=this.resources.items.forestEnvironment;if(!e){console.warn("‚ö†Ô∏è Forest GLB not available");return}const s=e.scene.clone(),t=new xe().setFromObject(s),n=new y;t.getSize(n);const i=new y;t.getCenter(i),console.log(`üìê Raw model: ${n.x.toFixed(1)} x ${n.y.toFixed(1)} x ${n.z.toFixed(1)}`),console.log(`üìê Raw center: (${i.x.toFixed(1)}, ${i.y.toFixed(1)}, ${i.z.toFixed(1)})`);const o=Math.max(n.x,n.z),a=this.targetWorldSize/o;s.scale.setScalar(a),console.log(`üìê Applied scale: ${a.toFixed(4)}`);const r=new xe().setFromObject(s),c=new y;r.getCenter(c),s.position.x=-c.x,s.position.z=-c.z,s.position.y=-r.min.y;const l=new xe().setFromObject(s),h=new y;l.getSize(h),console.log(`‚úÖ Final model: ${h.x.toFixed(1)} x ${h.y.toFixed(1)} x ${h.z.toFixed(1)}, ground at y=${l.min.y.toFixed(2)}`);let u=0;s.traverse(m=>{m.isMesh&&(u++,m.castShadow=!1,m.receiveShadow=!0,m.frustumCulled=!0,m.material&&(Array.isArray(m.material)?m.material:[m.material]).forEach(g=>{g.flatShading=!0,g.side=Xt,g.fog=!0,g.map&&(g.map.anisotropy=1),g.normalMap&&(g.normalMap.dispose(),g.normalMap=null),g.roughnessMap&&(g.roughnessMap.dispose(),g.roughnessMap=null),g.metalnessMap&&(g.metalnessMap.dispose(),g.metalnessMap=null),g.aoMap&&(g.aoMap.dispose(),g.aoMap=null),g.envMapIntensity=0,g.needsUpdate=!0}),m.geometry&&(m.geometry.computeBoundingSphere(),m.geometry.attributes.uv2&&m.geometry.deleteAttribute("uv2")))}),console.log(`‚úÖ Optimized ${u} forest meshes`),this.group.add(s),this.forestModel=s,this.createColliders(s)}createColliders(e){let s=0;e.traverse(t=>{if(!t.isMesh)return;const n=new xe().setFromObject(t),i=new y;n.getSize(i);const o=new y;if(n.getCenter(o),i.x<.5&&i.y<.5&&i.z<.5)return;const a=new Z(i.x/2,i.y/2,i.z/2),r=new he(a),c=new R({mass:0,shape:r,position:new Z(o.x,o.y,o.z),material:this.physics.defaultMaterial});c.collisionResponse=!0,this.physics.world.addBody(c),this.bodies.push(c),s++}),console.log(`üß± Created ${s} forest colliders`)}createZoneMarkers(){const e=new L({transparent:!0,opacity:.25,side:B});for(const[s,t]of Object.entries(this.zones)){const n=e.clone();n.color=new H(t.color);const i=new it(t.radius-.3,t.radius,16);i.rotateX(-Math.PI/2);const o=new b(i,n);o.position.copy(t.center),o.position.y=.15,this.group.add(o);const a=new b(new V(.08,.1,2,5),new D({color:t.color,emissive:t.color,emissiveIntensity:.3}));a.position.copy(t.center),a.position.y=1,a.userData={isInteractable:!0,zoneId:s,zoneName:t.name},this.group.add(a),this.landmarks.push(a);const r=new b(new G(.15,6,6),new L({color:t.color}));r.position.copy(t.center),r.position.y=2.2,this.group.add(r)}}createPortals(){const e=[{id:"P1",to:"Z1",pos:[0,0,-5]},{id:"P2",to:"Z2",pos:[-5,0,0]},{id:"P3",to:"Z3",pos:[5,0,0]},{id:"P4",to:"Z4",pos:[-4,0,4]},{id:"P5",to:"Z5",pos:[4,0,4]}],s=new D({color:6636321,flatShading:!0});e.forEach(t=>{var h,u;const n=new X;n.position.set(t.pos[0],0,t.pos[2]);const i=new b(new be(1.2,.07,4,10,Math.PI),s);i.rotation.x=Math.PI,i.position.y=1.2,n.add(i);const o=new V(.07,.09,2.4,4),a=new b(o,s);a.position.set(-1.2,1.2,0),n.add(a);const r=new b(o,s);r.position.set(1.2,1.2,0),n.add(r);const c=((h=this.zones[t.to])==null?void 0:h.color)||4886745,l=new b(new we(.9,10),new L({color:c,transparent:!0,opacity:.45,side:B}));l.position.y=1.2,n.add(l),n.userData={isPortal:!0,portalId:t.id,toZone:t.to,destination:((u=this.zones[t.to])==null?void 0:u.center.clone().setY(1))||new y(0,1,0)},this.group.add(n),this.portals.push(n)})}getZoneAtPosition(e){for(const[s,t]of Object.entries(this.zones))if(Math.hypot(e.x-t.center.x,e.z-t.center.z)<=t.radius)return{id:s,...t};return null}getPortalsNearPosition(e,s=2.5){return this.portals.filter(t=>t.position.distanceTo(e)<=s)}getZoneSpawnPoint(e){const s=this.zones[e];return s?s.center.clone().setY(2):new y(0,2,5)}update(){}dispose(){this.bodies.forEach(e=>this.physics.world.removeBody(e)),this.bodies=[],this.group.traverse(e=>{var s,t;e.isMesh&&((s=e.geometry)==null||s.dispose(),Array.isArray(e.material)?e.material.forEach(n=>n.dispose()):(t=e.material)==null||t.dispose())}),this.scene.remove(this.group),this.portals=[],this.landmarks=[]}}class Ln{constructor(e={}){this.experience=new C,this.scene=this.experience.scene,this.resources=this.experience.resources,this.config={width:e.width??4,height:e.height??3,resolution:e.resolution??512,position:e.position??new y(0,2,0),rotation:e.rotation??0,billboard:e.billboard??!1,fadeDistance:e.fadeDistance??50,maxDistance:e.maxDistance??80,accentColor:e.accentColor??4886745,backgroundColor:e.backgroundColor??"rgba(10, 15, 30, 0.92)",glassEffect:e.glassEffect??!0},this.content={title:e.title??"",subtitle:e.subtitle??"",description:e.description??"",thumbnailUrl:e.thumbnailUrl??null,tags:e.tags??[],type:e.type??"info",projectId:e.projectId??null},this.state={visible:!0,hovered:!1,selected:!1,opacity:1,scale:1},this.onInteract=e.onInteract??null,this.onHover=e.onHover??null,this.group=new X,this.group.name=`Panel_${this.content.projectId||"unnamed"}`,this.mesh=null,this.glowMesh=null,this.interactionMesh=null,this.canvas=null,this.ctx=null,this.texture=null,this._tempVec=new y,this._init()}_init(){this._createCanvas(),this._createMesh(),this._createGlow(),this._createInteractionZone(),this._renderContent(),this.group.position.copy(this.config.position),this.group.rotation.y=this.config.rotation,this.scene.add(this.group)}_createCanvas(){const e=Math.floor(this.config.width*this.config.resolution),s=Math.floor(this.config.height*this.config.resolution);this.canvas=document.createElement("canvas"),this.canvas.width=e,this.canvas.height=s,this.ctx=this.canvas.getContext("2d"),this.texture=new Vt(this.canvas),this.texture.minFilter=Te,this.texture.magFilter=Te,this.texture.anisotropy=1}_createMesh(){const e=new U(this.config.width,this.config.height),s=new L({map:this.texture,transparent:!0,side:B,depthWrite:!1});this.mesh=new b(e,s),this.mesh.renderOrder=10,this.group.add(this.mesh)}_createGlow(){if(!this.config.glassEffect)return;const e=new U(this.config.width+.15,this.config.height+.15),s=new L({color:this.config.accentColor,transparent:!0,opacity:.15,side:B,depthWrite:!1});this.glowMesh=new b(e,s),this.glowMesh.position.z=-.01,this.glowMesh.renderOrder=9,this.group.add(this.glowMesh)}_createInteractionZone(){const e=new U(this.config.width+.5,this.config.height+.5),s=new L({visible:!1,side:B});this.interactionMesh=new b(e,s),this.interactionMesh.position.z=.05,this.interactionMesh.userData={isInteractable:!0,panelRef:this,projectId:this.content.projectId,type:this.content.type},this.group.add(this.interactionMesh)}_renderContent(){const e=this.ctx,s=this.canvas.width,t=this.canvas.height,n=s*.06,i="#"+this.config.accentColor.toString(16).padStart(6,"0");if(e.clearRect(0,0,s,t),this.config.glassEffect){const r=e.createLinearGradient(0,0,0,t);r.addColorStop(0,"rgba(15, 20, 35, 0.95)"),r.addColorStop(1,"rgba(8, 12, 25, 0.98)"),e.fillStyle=r,this._roundRect(e,0,0,s,t,s*.03),e.fill(),e.strokeStyle=i,e.lineWidth=3,e.globalAlpha=.4,this._roundRect(e,2,2,s-4,t-4,s*.03),e.stroke(),e.globalAlpha=1,e.fillStyle=i,e.fillRect(n,n*.5,s-n*2,4)}else e.fillStyle=this.config.backgroundColor,e.fillRect(0,0,s,t);let o=n*1.5;if(this.content.thumbnailUrl&&this._thumbnail){const r=s-n*2,c=t*.35,l=o;e.save(),e.beginPath(),this._roundRect(e,n,l,r,c,s*.02),e.clip();const h=this._thumbnail.width/this._thumbnail.height,u=r/c;let m,f,g,w;h>u?(f=c,m=c*h,g=n-(m-r)/2,w=l):(m=r,f=r/h,g=n,w=l-(f-c)/2),e.drawImage(this._thumbnail,g,w,m,f),e.restore(),e.strokeStyle=i,e.lineWidth=2,e.globalAlpha=.3,this._roundRect(e,n,l,r,c,s*.02),e.stroke(),e.globalAlpha=1,o=l+c+n*.8}if(this.content.type){const r=this._getTypeBadge(this.content.type);e.font=`bold ${s*.035}px "SF Pro Display", -apple-system, sans-serif`;const c=e.measureText(r).width+s*.04;e.fillStyle=i,e.globalAlpha=.2,this._roundRect(e,n,o,c,s*.055,s*.015),e.fill(),e.globalAlpha=1,e.fillStyle=i,e.textAlign="left",e.textBaseline="middle",e.fillText(r,n+s*.02,o+s*.0275),o+=s*.08}if(this.content.title&&(e.font=`bold ${s*.07}px "SF Pro Display", -apple-system, sans-serif`,e.fillStyle="#ffffff",e.textAlign="left",e.textBaseline="top",e.fillText(this.content.title,n,o,s-n*2),o+=s*.09),this.content.subtitle&&(e.font=`${s*.04}px "SF Pro Display", -apple-system, sans-serif`,e.fillStyle=i,e.fillText(this.content.subtitle,n,o,s-n*2),o+=s*.06),this.content.description&&(e.font=`${s*.035}px "SF Pro Display", -apple-system, sans-serif`,e.fillStyle="rgba(255, 255, 255, 0.75)",this._wrapText(e,this.content.description,n,o,s-n*2,s*.045),o+=s*.15),this.content.tags&&this.content.tags.length>0){const r=t-n*1.5;let c=n;e.font=`${s*.03}px "SF Pro Display", -apple-system, sans-serif`;for(const l of this.content.tags.slice(0,4)){const h=e.measureText(l).width+s*.03;if(c+h>s-n)break;e.fillStyle="rgba(255, 255, 255, 0.1)",this._roundRect(e,c,r,h,s*.04,s*.01),e.fill(),e.fillStyle="rgba(255, 255, 255, 0.7)",e.textAlign="left",e.textBaseline="middle",e.fillText(l,c+s*.015,r+s*.02),c+=h+s*.015}}const a=t-n*.5;e.font=`${s*.028}px "SF Pro Display", -apple-system, sans-serif`,e.fillStyle="rgba(255, 255, 255, 0.4)",e.textAlign="center",e.textBaseline="bottom",e.fillText("Press E to interact",s/2,a),this.texture.needsUpdate=!0}_getTypeBadge(e){return{unity_webgl:"üéÆ PLAYABLE",webapp:"üåê WEB APP",video:"üé¨ VIDEO",gallery:"üñºÔ∏è GALLERY",info:"‚ÑπÔ∏è INFO",contact:"üìß CONTACT"}[e]||e.toUpperCase()}_roundRect(e,s,t,n,i,o){e.beginPath(),e.moveTo(s+o,t),e.lineTo(s+n-o,t),e.quadraticCurveTo(s+n,t,s+n,t+o),e.lineTo(s+n,t+i-o),e.quadraticCurveTo(s+n,t+i,s+n-o,t+i),e.lineTo(s+o,t+i),e.quadraticCurveTo(s,t+i,s,t+i-o),e.lineTo(s,t+o),e.quadraticCurveTo(s,t,s+o,t),e.closePath()}_wrapText(e,s,t,n,i,o){const a=s.split(" ");let r="",c=0;const l=4;for(let h=0;h<a.length&&c<l;h++){const u=r+a[h]+" ";e.measureText(u).width>i&&r!==""?(e.fillText(r.trim(),t,n),r=a[h]+" ",n+=o,c++):r=u}c<l&&r.trim()&&e.fillText(r.trim()+(c>=l-1?"...":""),t,n)}loadThumbnail(e){return e?new Promise(s=>{const t=new Image;t.crossOrigin="anonymous",t.onload=()=>{this._thumbnail=t,this._renderContent(),s()},t.onerror=()=>{console.warn(`Failed to load thumbnail: ${e}`),s()},t.src=e}):Promise.resolve()}update(e,s){if(!this.state.visible)return;this._tempVec.copy(this.config.position);const t=e.position.distanceTo(this._tempVec);if(t>this.config.maxDistance){this.group.visible=!1;return}this.group.visible=!0;let n=1;t>this.config.fadeDistance&&(n=1-(t-this.config.fadeDistance)/(this.config.maxDistance-this.config.fadeDistance)),this.state.opacity+=(n-this.state.opacity)*.1,this.mesh.material.opacity=this.state.opacity,this.glowMesh&&(this.glowMesh.material.opacity=this.state.opacity*.15),this.config.billboard&&this.group.lookAt(e.position);const i=this.state.hovered?1.05:1;this.state.scale+=(i-this.state.scale)*.15,this.group.scale.setScalar(this.state.scale),this.glowMesh&&this.state.hovered&&(this.glowMesh.material.opacity=this.state.opacity*.35)}setHovered(e){this.state.hovered!==e&&(this.state.hovered=e,this.onHover&&this.onHover(e,this))}interact(){this.onInteract&&this.onInteract(this.content,this)}setVisible(e){this.state.visible=e,this.group.visible=e}setContent(e){Object.assign(this.content,e),this._renderContent()}getWorldPosition(){return this.group.getWorldPosition(this._tempVec.clone())}dispose(){this.scene.remove(this.group),this.texture&&this.texture.dispose(),this.mesh&&(this.mesh.geometry.dispose(),this.mesh.material.dispose()),this.glowMesh&&(this.glowMesh.geometry.dispose(),this.glowMesh.material.dispose()),this.interactionMesh&&(this.interactionMesh.geometry.dispose(),this.interactionMesh.material.dispose()),this._thumbnail=null,this.canvas=null,this.ctx=null}}class Sn{constructor(){this.experience=new C,this.panels=new Map,this._tempVec=new y}createPanel(e,s){this.panels.has(e)&&(console.warn(`Panel ${e} already exists, disposing old one`),this.removePanel(e));const t=new Ln(s);return this.panels.set(e,t),s.thumbnailUrl&&t.loadThumbnail(s.thumbnailUrl),t}getPanel(e){return this.panels.get(e)}removePanel(e){const s=this.panels.get(e);s&&(s.dispose(),this.panels.delete(e))}getAllPanels(){return Array.from(this.panels.values())}getPanelsNear(e,s){const t=[];for(const n of this.panels.values())this._tempVec.copy(n.config.position),e.distanceTo(this._tempVec)<=s&&t.push(n);return t}update(e,s){for(const t of this.panels.values())t.update(e,s)}dispose(){for(const e of this.panels.values())e.dispose();this.panels.clear()}}class Cn{constructor(){this.experience=new C,this.scene=this.experience.scene,this.camera=this.experience.camera,this.config={interactionRadius:5,raycastDistance:8,interactionCooldown:300,promptFadeDistance:3},this.nearbyInteractables=[],this.currentTarget=null,this.lastInteractionTime=0,this.isInteracting=!1,this.raycaster=new js,this.raycaster.far=this.config.raycastDistance,this._tempVec=new y,this._direction=new y,this.onInteract=null,this.onTargetChange=null,this.onNearbyChange=null,this._setupControls()}_setupControls(){this._onKeyDown=e=>{e.code==="KeyE"&&!e.repeat&&this.tryInteract()},window.addEventListener("keydown",this._onKeyDown)}setInteractables(e){this.interactables=e}update(e,s){var i;if(!this.interactables||this.interactables.length===0)return;const t=[];for(const o of this.interactables){if(!((i=o.userData)!=null&&i.isInteractable)||!o.visible&&o.parent&&!o.parent.visible)continue;o.getWorldPosition(this._tempVec);const a=e.distanceTo(this._tempVec);a<=this.config.interactionRadius&&t.push({object:o,distance:a})}t.sort((o,a)=>o.distance-a.distance),this._hasNearbyChanged(t)&&(this.nearbyInteractables=t,this.onNearbyChange&&this.onNearbyChange(t.map(o=>o.object))),this._updateTarget(e,s)}_updateTarget(e,s){let t=null,n=1/0;for(const{object:i,distance:o}of this.nearbyInteractables){i.getWorldPosition(this._tempVec),this._direction.copy(this._tempVec).sub(e).normalize();const a=s.dot(this._direction),r=Math.acos(Math.max(-1,Math.min(1,a))),c=r>Math.PI/2?1e3:r*2,l=o+c;l<n&&l<this.config.interactionRadius*2&&(n=l,t=i)}t!==this.currentTarget&&(this.currentTarget&&this._setObjectHovered(this.currentTarget,!1),this.currentTarget=t,t&&this._setObjectHovered(t,!0),this.onTargetChange&&this.onTargetChange(t))}_setObjectHovered(e,s){var t;(t=e.userData)!=null&&t.panelRef&&e.userData.panelRef.setHovered(s),s?window.dispatchEvent(new CustomEvent("interactableHover",{detail:{object:e,userData:e.userData}})):window.dispatchEvent(new CustomEvent("interactableUnhover",{detail:{object:e,userData:e.userData}}))}_hasNearbyChanged(e){var s;if(e.length!==this.nearbyInteractables.length)return!0;for(let t=0;t<e.length;t++)if(e[t].object!==((s=this.nearbyInteractables[t])==null?void 0:s.object))return!0;return!1}tryInteract(){const e=performance.now();if(e-this.lastInteractionTime<this.config.interactionCooldown||!this.currentTarget)return!1;this.lastInteractionTime=e,this.isInteracting=!0;const s=this.currentTarget.userData,t={object:this.currentTarget,type:s.type||"generic",projectId:s.projectId,zoneId:s.zoneId,zoneName:s.zoneName,isPortal:s.isPortal,portalId:s.portalId,toZone:s.toZone,destination:s.destination,panelRef:s.panelRef};return s.panelRef&&s.panelRef.interact(),this.onInteract&&this.onInteract(t),window.dispatchEvent(new CustomEvent("interact",{detail:t})),setTimeout(()=>{this.isInteracting=!1},100),!0}getCurrentTarget(){return this.currentTarget?{object:this.currentTarget,userData:this.currentTarget.userData,distance:this._getDistanceToPlayer(this.currentTarget)}:null}_getDistanceToPlayer(e){var t;const s=(t=this.experience.world)==null?void 0:t.player;return s?(e.getWorldPosition(this._tempVec),s.mesh.position.distanceTo(this._tempVec)):1/0}hasNearbyInteractables(){return this.nearbyInteractables.length>0}dispose(){window.removeEventListener("keydown",this._onKeyDown),this.interactables=[],this.nearbyInteractables=[],this.currentTarget=null}}class In{constructor(){this.element=null,this.visible=!1,this._createPrompt()}_createPrompt(){this.element=document.createElement("div"),this.element.id="interaction-prompt",this.element.innerHTML=`
      <div class="prompt-content">
        <span class="prompt-key">E</span>
        <span class="prompt-text">Interact</span>
      </div>
    `,this.element.style.cssText=`
      position: fixed;
      bottom: 20%;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      opacity: 0;
      pointer-events: none;
      z-index: 50;
      transition: opacity 0.2s ease, transform 0.2s ease;
    `;const e=document.createElement("style");e.textContent=`
      #interaction-prompt .prompt-content {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 24px;
        background: rgba(10, 15, 30, 0.9);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        backdrop-filter: blur(10px);
      }
      #interaction-prompt .prompt-key {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        font-family: "SF Pro Display", -apple-system, sans-serif;
        font-size: 16px;
        font-weight: 600;
        color: #fff;
      }
      #interaction-prompt .prompt-text {
        font-family: "SF Pro Display", -apple-system, sans-serif;
        font-size: 14px;
        color: rgba(255, 255, 255, 0.8);
        text-transform: uppercase;
        letter-spacing: 1px;
      }
      #interaction-prompt.visible {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    `,document.head.appendChild(e),document.body.appendChild(this.element)}show(e="Interact"){this.visible||(this.visible=!0,this.element.querySelector(".prompt-text").textContent=e,this.element.classList.add("visible"))}hide(){this.visible&&(this.visible=!1,this.element.classList.remove("visible"))}setText(e){this.element.querySelector(".prompt-text").textContent=e}setKey(e){this.element.querySelector(".prompt-key").textContent=e}dispose(){var e;(e=this.element)==null||e.remove()}}const Be={Z1:{zoneName:"IT Services",description:"Enterprise software, web applications, APIs, and backend systems",accentColor:4886745,projects:[{id:"z1_proj1",title:"Enterprise Dashboard",subtitle:"Real-time Analytics Platform",description:"Full-stack dashboard with real-time data visualization, user management, and reporting. Built with React, Node.js, and PostgreSQL.",type:"webapp",thumbnailUrl:"textures/portfolio/z1_dashboard.jpg",screenshots:["textures/portfolio/z1_dashboard_1.jpg","textures/portfolio/z1_dashboard_2.jpg"],links:{live:"https://example.com/dashboard",github:"https://github.com/example/dashboard"},tags:["React","Node.js","PostgreSQL","WebSocket"],featured:!0,position:{x:-3,y:2,z:-1},rotation:.3},{id:"z1_proj2",title:"REST API Gateway",subtitle:"Microservices Architecture",description:"Highly scalable API gateway handling 10M+ requests/day. Features rate limiting, authentication, and load balancing.",type:"webapp",thumbnailUrl:"textures/portfolio/z1_api.jpg",screenshots:[],links:{documentation:"https://example.com/api-docs"},tags:["Node.js","Redis","Docker","Kubernetes"],featured:!1,position:{x:3,y:2,z:-1},rotation:-.3},{id:"z1_proj3",title:"E-Commerce Platform",subtitle:"Full-Stack Solution",description:"Complete e-commerce solution with payment processing, inventory management, and customer analytics.",type:"webapp",thumbnailUrl:"textures/portfolio/z1_ecommerce.jpg",screenshots:[],links:{live:"https://example.com/store"},tags:["Next.js","Stripe","MongoDB"],featured:!1,position:{x:0,y:2,z:4},rotation:Math.PI}]},Z2:{zoneName:"Game Development",description:"Unity, Unreal Engine, mobile games, and interactive experiences",accentColor:10181046,projects:[{id:"z2_proj1",title:"Adventure Quest",subtitle:"Unity 3D RPG",description:"Open-world RPG with procedural generation, quest system, and multiplayer support. Play directly in your browser!",type:"unity_webgl",thumbnailUrl:"textures/portfolio/z2_adventure.jpg",screenshots:["textures/portfolio/z2_adventure_1.jpg","textures/portfolio/z2_adventure_2.jpg"],webglUrl:"https://example.com/games/adventure-quest",links:{steam:"https://store.steampowered.com/app/xxxxx",itch:"https://example.itch.io/adventure-quest"},tags:["Unity","C#","Multiplayer","RPG"],featured:!0,position:{x:-4,y:2.5,z:2},rotation:.4},{id:"z2_proj2",title:"Puzzle Dimensions",subtitle:"Mobile Puzzle Game",description:"Mind-bending puzzle game with 200+ levels. Features AR mode and daily challenges.",type:"unity_webgl",thumbnailUrl:"textures/portfolio/z2_puzzle.jpg",screenshots:[],webglUrl:"https://example.com/games/puzzle-dimensions",links:{playstore:"https://play.google.com/store/apps/details?id=com.example.puzzle",appstore:"https://apps.apple.com/app/puzzle-dimensions/id123456"},tags:["Unity","Mobile","AR","Puzzle"],featured:!0,position:{x:4,y:2.5,z:-2},rotation:-.4},{id:"z2_proj3",title:"Racing Unleashed",subtitle:"Unreal Engine Racing",description:"High-speed racing game with realistic physics, 30+ tracks, and online multiplayer.",type:"video",thumbnailUrl:"textures/portfolio/z2_racing.jpg",videoUrl:"https://youtube.com/embed/xxxxx",links:{steam:"https://store.steampowered.com/app/xxxxx"},tags:["Unreal Engine","C++","Racing","Multiplayer"],featured:!1,position:{x:0,y:2.5,z:-5},rotation:0}]},Z3:{zoneName:"AI & Automation",description:"Machine learning, chatbots, RPA, and intelligent systems",accentColor:15277667,projects:[{id:"z3_proj1",title:"Smart Assistant",subtitle:"AI Chatbot Platform",description:"Multi-lingual AI assistant with natural language understanding, sentiment analysis, and custom training capabilities.",type:"webapp",thumbnailUrl:"textures/portfolio/z3_chatbot.jpg",screenshots:[],links:{demo:"https://example.com/chatbot-demo"},tags:["Python","TensorFlow","NLP","GPT"],featured:!0,position:{x:-4,y:1.5,z:0},rotation:.5},{id:"z3_proj2",title:"Vision Analytics",subtitle:"Computer Vision Platform",description:"Real-time object detection, facial recognition, and video analytics for security and retail.",type:"webapp",thumbnailUrl:"textures/portfolio/z3_vision.jpg",screenshots:[],links:{documentation:"https://example.com/vision-docs"},tags:["Python","PyTorch","OpenCV","YOLO"],featured:!1,position:{x:4,y:1.5,z:0},rotation:-.5}]},Z4:{zoneName:"Media Production",description:"Video production, motion graphics, VFX, and 3D animation",accentColor:16750592,projects:[{id:"z4_proj1",title:"Brand Film",subtitle:"Corporate Video",description:"Award-winning brand documentary featuring drone cinematography and custom motion graphics.",type:"video",thumbnailUrl:"textures/portfolio/z4_brand.jpg",videoUrl:"https://youtube.com/embed/xxxxx",links:{vimeo:"https://vimeo.com/xxxxx"},tags:["Premiere Pro","After Effects","DaVinci"],featured:!0,position:{x:-3,y:3,z:2},rotation:.3},{id:"z4_proj2",title:"3D Product Showcase",subtitle:"Product Visualization",description:"Photorealistic 3D renders and animations for product marketing.",type:"gallery",thumbnailUrl:"textures/portfolio/z4_3d.jpg",screenshots:["textures/portfolio/z4_3d_1.jpg","textures/portfolio/z4_3d_2.jpg","textures/portfolio/z4_3d_3.jpg"],links:{},tags:["Blender","Cinema 4D","3D"],featured:!1,position:{x:3,y:3,z:-2},rotation:-.3}]},Z5:{zoneName:"Digital Marketing",description:"SEO, social media, paid advertising, and content marketing",accentColor:5025616,projects:[{id:"z5_proj1",title:"SEO Dashboard",subtitle:"Analytics & Optimization",description:"Comprehensive SEO toolkit with keyword tracking, competitor analysis, and automated reporting.",type:"webapp",thumbnailUrl:"textures/portfolio/z5_seo.jpg",screenshots:[],links:{demo:"https://example.com/seo-demo"},tags:["SEO","Analytics","Marketing"],featured:!0,position:{x:0,y:2.5,z:3},rotation:Math.PI}]},Z6:{zoneName:"About Us",description:"Our story, values, and the team behind TobaTech",accentColor:16758605,projects:[{id:"z6_about",title:"Our Story",subtitle:"About TobaTech",description:"Founded in 2020, TobaTech is a creative technology studio specializing in immersive digital experiences.",type:"info",thumbnailUrl:"textures/portfolio/z6_about.jpg",content:{founded:"2020",team:"15+ professionals",clients:"100+ worldwide",mission:"Creating technology that inspires"},links:{linkedin:"https://linkedin.com/company/tobatech"},tags:["About","Team","Mission"],featured:!0,position:{x:0,y:3.5,z:0},rotation:0}]},Z7:{zoneName:"Contact",description:"Get in touch with us",accentColor:2541274,projects:[{id:"z7_contact",title:"Get In Touch",subtitle:"Contact Us",description:"Ready to start your next project? We'd love to hear from you.",type:"contact",thumbnailUrl:"textures/portfolio/z7_contact.jpg",contact:{email:"hello@tobatech.com",phone:"+1 (555) 123-4567",address:"123 Tech Street, Innovation City"},links:{calendly:"https://calendly.com/tobatech",email:"mailto:hello@tobatech.com"},tags:["Contact","Booking"],featured:!0,position:{x:0,y:3,z:0},rotation:0}]},HUB:{zoneName:"Welcome",description:"Featured projects and portfolio highlights",accentColor:16766720,projects:[{id:"hub_welcome",title:"Welcome to TobaTech",subtitle:"Interactive Portfolio",description:"Explore our work across different zones. Each area showcases our expertise in different domains.",type:"info",thumbnailUrl:"textures/portfolio/hub_welcome.jpg",content:{zones:[{name:"CodeForge Ruins",direction:"North",service:"IT Services"},{name:"Pixel Grove",direction:"West",service:"Game Development"},{name:"Neural Cavern",direction:"East",service:"AI & Automation"},{name:"Lumina Falls",direction:"Southwest",service:"Media Production"},{name:"Beacon Spire",direction:"Southeast",service:"Digital Marketing"}]},links:{},tags:["Welcome","Guide"],featured:!0,position:{x:0,y:4,z:3},rotation:Math.PI}]}};function Rn(p){return Be[p]||null}function Dn(p){for(const[e,s]of Object.entries(Be)){const t=s.projects.find(n=>n.id===p);if(t)return{...t,zoneId:e,zoneName:s.zoneName,accentColor:s.accentColor}}return null}class zn{constructor(e){this.experience=new C,this.scene=this.experience.scene,this.zones=e,this.uiManager=new Sn,this.interactionSystem=new Cn,this.interactionPrompt=new In,this.initialized=!1,this.visitedProjects=new Set,this.activeDetailView=null,this._playerPos=new y,this._playerDir=new y,this._tempVec=new y,this._onInteract=this._onInteract.bind(this),this._onTargetChange=this._onTargetChange.bind(this),this._init()}_init(){console.log("üìã Initializing Portfolio Showcase..."),this.interactionSystem.onInteract=this._onInteract,this.interactionSystem.onTargetChange=this._onTargetChange,this._createAllPanels(),this._updateInteractables(),window.addEventListener("zoneChange",e=>this._onZoneChange(e)),window.addEventListener("closeDetailView",()=>this.closeDetailView()),this.initialized=!0,console.log(`‚úÖ Portfolio Showcase: ${this.uiManager.panels.size} panels created`)}_createAllPanels(){var e,s,t;for(const[n,i]of Object.entries(Be)){const o=this.zones[n];if(!o)continue;const a=o.center,r=o.elevation||0;for(const c of i.projects){const l=new y(a.x+(((e=c.position)==null?void 0:e.x)||0),r+(((s=c.position)==null?void 0:s.y)||2),a.z+(((t=c.position)==null?void 0:t.z)||0)),h=c.id,u={position:l,rotation:c.rotation||0,width:c.featured?5:4,height:c.featured?3.75:3,accentColor:i.accentColor,title:c.title,subtitle:c.subtitle,description:c.description,thumbnailUrl:c.thumbnailUrl,tags:c.tags||[],type:c.type,projectId:c.id,billboard:!1,onInteract:m=>this._showProjectDetail(c,n)};this.uiManager.createPanel(h,u)}}}_updateInteractables(){var t,n;const e=[];for(const i of this.uiManager.getAllPanels())i.interactionMesh&&e.push(i.interactionMesh);const s=this.experience.world;if(s!=null&&s.activeEnvironment){const i=s.activeEnvironment;if(i.portals)for(const o of i.portals)(t=o.userData)!=null&&t.isPortal&&e.push(o);if(i.landmarks)for(const o of i.landmarks)(n=o.userData)!=null&&n.isInteractable&&e.push(o)}this.interactionSystem.setInteractables(e)}_onInteract(e){if(console.log("üéØ Interaction:",e),e.isPortal&&e.destination){this._handlePortalTeleport(e);return}if(e.zoneId&&!e.projectId){this._showZoneInfo(e.zoneId,e.zoneName);return}if(e.projectId&&e.panelRef){const s=Dn(e.projectId);s&&this._showProjectDetail(s,s.zoneId)}}_onTargetChange(e){if(e){const s=e.userData;let t="Interact";s.isPortal?t=`Teleport to ${s.toZone}`:s.projectId?t="View Project":s.zoneId&&(t=`About ${s.zoneName}`),this.interactionPrompt.show(t)}else this.interactionPrompt.hide()}_handlePortalTeleport(e){var t;const s=this.experience.world;!(s!=null&&s.player)||!e.destination||((t=this.experience.uiManager)==null||t.notify(`Teleporting to ${e.toZone}...`,"info",1500),setTimeout(()=>{s.player.teleport({x:e.destination.x,y:e.destination.y+1,z:e.destination.z})},300))}_onZoneChange(e){var i;const{zoneId:s,zoneName:t,firstVisit:n}=e.detail;n&&s&&((i=this.experience.uiManager)==null||i.notify(`Discovered: ${t}`,"success",3e3))}_showZoneInfo(e,s){const t=Rn(e);t&&window.dispatchEvent(new CustomEvent("showZoneInfo",{detail:{zoneId:e,zoneName:s,description:t.description,projectCount:t.projects.length,accentColor:t.accentColor}}))}_showProjectDetail(e,s){switch(this.visitedProjects.add(e.id),e.type){case"unity_webgl":this._openWebGLEmbed(e);break;case"video":this._openVideoPlayer(e);break;case"gallery":this._openGallery(e);break;case"contact":this._openContactForm(e);break;default:this._openProjectModal(e)}}_openProjectModal(e){window.dispatchEvent(new CustomEvent("showProjectDetail",{detail:{project:e,type:"modal"}}))}_openWebGLEmbed(e){if(!e.webglUrl){this._openProjectModal(e);return}this.activeDetailView=this._createDetailOverlay(`
      <div class="detail-header">
        <h2>${e.title}</h2>
        <p>${e.subtitle||""}</p>
        <button class="detail-close" onclick="window.dispatchEvent(new CustomEvent('closeDetailView'))">‚úï Close</button>
      </div>
      <div class="webgl-container">
        <iframe
          src="${e.webglUrl}"
          frameborder="0"
          allowfullscreen
          allow="autoplay; fullscreen; gamepad"
        ></iframe>
      </div>
      <div class="detail-footer">
        <p>${e.description||""}</p>
        ${this._renderLinks(e.links)}
      </div>
    `,"webgl")}_openVideoPlayer(e){const s=e.videoUrl||"";this.activeDetailView=this._createDetailOverlay(`
      <div class="detail-header">
        <h2>${e.title}</h2>
        <p>${e.subtitle||""}</p>
        <button class="detail-close" onclick="window.dispatchEvent(new CustomEvent('closeDetailView'))">‚úï Close</button>
      </div>
      <div class="video-container">
        <iframe
          src="${s}"
          frameborder="0"
          allowfullscreen
          allow="autoplay; encrypted-media"
        ></iframe>
      </div>
      <div class="detail-footer">
        <p>${e.description||""}</p>
        ${this._renderLinks(e.links)}
      </div>
    `,"video")}_openGallery(e){const t=(e.screenshots||[]).map((n,i)=>`
      <img src="${n}" alt="Screenshot ${i+1}" class="gallery-image" />
    `).join("");this.activeDetailView=this._createDetailOverlay(`
      <div class="detail-header">
        <h2>${e.title}</h2>
        <p>${e.subtitle||""}</p>
        <button class="detail-close" onclick="window.dispatchEvent(new CustomEvent('closeDetailView'))">‚úï Close</button>
      </div>
      <div class="gallery-container">
        ${t||"<p>No images available</p>"}
      </div>
      <div class="detail-footer">
        <p>${e.description||""}</p>
        ${this._renderLinks(e.links)}
      </div>
    `,"gallery")}_openContactForm(e){const s=e.contact||{};this.activeDetailView=this._createDetailOverlay(`
      <div class="detail-header">
        <h2>${e.title}</h2>
        <p>${e.subtitle||""}</p>
        <button class="detail-close" onclick="window.dispatchEvent(new CustomEvent('closeDetailView'))">‚úï Close</button>
      </div>
      <div class="contact-container">
        <p class="contact-description">${e.description||""}</p>
        <div class="contact-info">
          ${s.email?`<a href="mailto:${s.email}" class="contact-link">üìß ${s.email}</a>`:""}
          ${s.phone?`<a href="tel:${s.phone}" class="contact-link">üì± ${s.phone}</a>`:""}
          ${s.address?`<p class="contact-address">üìç ${s.address}</p>`:""}
        </div>
        ${this._renderLinks(e.links)}
      </div>
    `,"contact")}_renderLinks(e){return!e||Object.keys(e).length===0?"":`<div class="project-links">${Object.entries(e).map(([t,n])=>{const i=this._getLinkIcon(t),o=t.charAt(0).toUpperCase()+t.slice(1);return`<a href="${n}" target="_blank" rel="noopener" class="project-link">${i} ${o}</a>`}).join("")}</div>`}_getLinkIcon(e){return{live:"üåê",github:"üíª",steam:"üéÆ",itch:"üé≤",playstore:"üì±",appstore:"üçé",vimeo:"üé¨",documentation:"üìö",demo:"‚ñ∂Ô∏è",calendly:"üìÖ",email:"üìß",linkedin:"üíº"}[e]||"üîó"}_createDetailOverlay(e,s){this.closeDetailView();const t=document.createElement("div");if(t.id="project-detail-overlay",t.className=`detail-type-${s}`,t.innerHTML=`
      <div class="detail-backdrop" onclick="window.dispatchEvent(new CustomEvent('closeDetailView'))"></div>
      <div class="detail-content">
        ${e}
      </div>
    `,!document.getElementById("detail-overlay-styles")){const n=document.createElement("style");n.id="detail-overlay-styles",n.textContent=`
        #project-detail-overlay {
          position: fixed;
          inset: 0;
          z-index: 1000;
          display: flex;
          align-items: center;
          justify-content: center;
          animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
          from { opacity: 0; }
          to { opacity: 1; }
        }
        .detail-backdrop {
          position: absolute;
          inset: 0;
          background: rgba(0, 0, 0, 0.85);
          backdrop-filter: blur(8px);
        }
        .detail-content {
          position: relative;
          width: 90%;
          max-width: 1200px;
          max-height: 90vh;
          background: rgba(15, 20, 35, 0.98);
          border: 1px solid rgba(255, 255, 255, 0.1);
          border-radius: 16px;
          overflow: hidden;
          display: flex;
          flex-direction: column;
        }
        .detail-header {
          padding: 24px;
          border-bottom: 1px solid rgba(255, 255, 255, 0.1);
          display: flex;
          align-items: center;
          gap: 16px;
        }
        .detail-header h2 {
          flex: 1;
          margin: 0;
          font-size: 24px;
          color: #fff;
        }
        .detail-header p {
          margin: 0;
          color: rgba(255, 255, 255, 0.6);
        }
        .detail-close {
          padding: 8px 16px;
          background: rgba(255, 255, 255, 0.1);
          border: 1px solid rgba(255, 255, 255, 0.2);
          border-radius: 8px;
          color: #fff;
          cursor: pointer;
          transition: background 0.2s;
        }
        .detail-close:hover {
          background: rgba(255, 255, 255, 0.2);
        }
        .webgl-container,
        .video-container {
          flex: 1;
          min-height: 400px;
          background: #000;
        }
        .webgl-container iframe,
        .video-container iframe {
          width: 100%;
          height: 100%;
          min-height: 400px;
        }
        .gallery-container {
          flex: 1;
          overflow-y: auto;
          padding: 24px;
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
          gap: 16px;
        }
        .gallery-image {
          width: 100%;
          border-radius: 8px;
          cursor: pointer;
          transition: transform 0.2s;
        }
        .gallery-image:hover {
          transform: scale(1.02);
        }
        .contact-container {
          padding: 48px;
          text-align: center;
        }
        .contact-description {
          font-size: 18px;
          color: rgba(255, 255, 255, 0.8);
          margin-bottom: 32px;
        }
        .contact-info {
          display: flex;
          flex-direction: column;
          gap: 16px;
          margin-bottom: 32px;
        }
        .contact-link {
          font-size: 18px;
          color: #4A90D9;
          text-decoration: none;
        }
        .contact-link:hover {
          text-decoration: underline;
        }
        .contact-address {
          color: rgba(255, 255, 255, 0.6);
        }
        .detail-footer {
          padding: 24px;
          border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        .detail-footer p {
          margin: 0 0 16px;
          color: rgba(255, 255, 255, 0.7);
        }
        .project-links {
          display: flex;
          gap: 12px;
          flex-wrap: wrap;
        }
        .project-link {
          padding: 8px 16px;
          background: rgba(255, 255, 255, 0.1);
          border-radius: 8px;
          color: #fff;
          text-decoration: none;
          transition: background 0.2s;
        }
        .project-link:hover {
          background: rgba(255, 255, 255, 0.2);
        }
        .detail-type-webgl .detail-content {
          max-width: 95%;
          height: 90vh;
        }
      `,document.head.appendChild(n)}return document.body.appendChild(t),this._escHandler=n=>{n.key==="Escape"&&this.closeDetailView()},window.addEventListener("keydown",this._escHandler),t}closeDetailView(){this.activeDetailView&&(this.activeDetailView.remove(),this.activeDetailView=null),this._escHandler&&(window.removeEventListener("keydown",this._escHandler),this._escHandler=null)}update(e){var n,i;if(!this.initialized)return;const s=(n=this.experience.world)==null?void 0:n.player,t=(i=this.experience.camera)==null?void 0:i.instance;!s||!t||(this._playerPos.copy(s.mesh.position),t.getWorldDirection(this._playerDir),this._playerDir.y=0,this._playerDir.normalize(),this.interactionSystem.update(this._playerPos,this._playerDir),this.uiManager.update(t,e))}getProgress(){let e=0;for(const s of Object.values(Be))e+=s.projects.length;return{visited:this.visitedProjects.size,total:e,percentage:e>0?Math.round(this.visitedProjects.size/e*100):0}}dispose(){this.closeDetailView(),this.uiManager.dispose(),this.interactionSystem.dispose(),this.interactionPrompt.dispose(),window.removeEventListener("zoneChange",this._onZoneChange),window.removeEventListener("closeDetailView",this.closeDetailView),this.initialized=!1,console.log("üßπ Portfolio Showcase disposed")}}function Ht(p,e){if(e===Ns)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),p;if(e===rt||e===Wt){let s=p.getIndex();if(s===null){const o=[],a=p.getAttribute("position");if(a!==void 0){for(let r=0;r<a.count;r++)o.push(r);p.setIndex(o),s=p.getIndex()}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),p}const t=s.count-2,n=[];if(e===rt)for(let o=1;o<=t;o++)n.push(s.getX(0)),n.push(s.getX(o)),n.push(s.getX(o+1));else for(let o=0;o<t;o++)o%2===0?(n.push(s.getX(o)),n.push(s.getX(o+1)),n.push(s.getX(o+2))):(n.push(s.getX(o+2)),n.push(s.getX(o+1)),n.push(s.getX(o)));n.length/3!==t&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const i=p.clone();return i.setIndex(n),i.clearGroups(),i}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",e),p}class es extends $t{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(s){return new Bn(s)}),this.register(function(s){return new Wn(s)}),this.register(function(s){return new $n(s)}),this.register(function(s){return new qn(s)}),this.register(function(s){return new Un(s)}),this.register(function(s){return new Gn(s)}),this.register(function(s){return new Zn(s)}),this.register(function(s){return new Yn(s)}),this.register(function(s){return new Nn(s)}),this.register(function(s){return new Kn(s)}),this.register(function(s){return new Hn(s)}),this.register(function(s){return new Xn(s)}),this.register(function(s){return new Vn(s)}),this.register(function(s){return new On(s)}),this.register(function(s){return new Jn(s)}),this.register(function(s){return new Qn(s)})}load(e,s,t,n){const i=this;let o;if(this.resourcePath!=="")o=this.resourcePath;else if(this.path!==""){const c=ve.extractUrlBase(e);o=ve.resolveURL(c,this.path)}else o=ve.extractUrlBase(e);this.manager.itemStart(e);const a=function(c){n?n(c):console.error(c),i.manager.itemError(e),i.manager.itemEnd(e)},r=new je(this.manager);r.setPath(this.path),r.setResponseType("arraybuffer"),r.setRequestHeader(this.requestHeader),r.setWithCredentials(this.withCredentials),r.load(e,function(c){try{i.parse(c,o,function(l){s(l),i.manager.itemEnd(e)},a)}catch(l){a(l)}},t,a)}setDRACOLoader(e){return this.dracoLoader=e,this}setDDSLoader(){throw new Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return this.pluginCallbacks.indexOf(e)===-1&&this.pluginCallbacks.push(e),this}unregister(e){return this.pluginCallbacks.indexOf(e)!==-1&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,s,t,n){let i;const o={},a={},r=new TextDecoder;if(typeof e=="string")i=JSON.parse(e);else if(e instanceof ArrayBuffer)if(r.decode(new Uint8Array(e,0,4))===ts){try{o[E.KHR_BINARY_GLTF]=new ei(e)}catch(h){n&&n(h);return}i=JSON.parse(o[E.KHR_BINARY_GLTF].content)}else i=JSON.parse(r.decode(e));else i=e;if(i.asset===void 0||i.asset.version[0]<2){n&&n(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));return}const c=new pi(i,{path:s||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});c.fileLoader.setRequestHeader(this.requestHeader);for(let l=0;l<this.pluginCallbacks.length;l++){const h=this.pluginCallbacks[l](c);h.name||console.error("THREE.GLTFLoader: Invalid plugin found: missing name"),a[h.name]=h,o[h.name]=!0}if(i.extensionsUsed)for(let l=0;l<i.extensionsUsed.length;++l){const h=i.extensionsUsed[l],u=i.extensionsRequired||[];switch(h){case E.KHR_MATERIALS_UNLIT:o[h]=new jn;break;case E.KHR_DRACO_MESH_COMPRESSION:o[h]=new ti(i,this.dracoLoader);break;case E.KHR_TEXTURE_TRANSFORM:o[h]=new si;break;case E.KHR_MESH_QUANTIZATION:o[h]=new ni;break;default:u.indexOf(h)>=0&&a[h]===void 0&&console.warn('THREE.GLTFLoader: Unknown extension "'+h+'".')}}c.setExtensions(o),c.setPlugins(a),c.parse(t,n)}parseAsync(e,s){const t=this;return new Promise(function(n,i){t.parse(e,s,n,i)})}}function Fn(){let p={};return{get:function(e){return p[e]},add:function(e,s){p[e]=s},remove:function(e){delete p[e]},removeAll:function(){p={}}}}const E={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class On{constructor(e){this.parser=e,this.name=E.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,s=this.parser.json.nodes||[];for(let t=0,n=s.length;t<n;t++){const i=s[t];i.extensions&&i.extensions[this.name]&&i.extensions[this.name].light!==void 0&&e._addNodeRef(this.cache,i.extensions[this.name].light)}}_loadLight(e){const s=this.parser,t="light:"+e;let n=s.cache.get(t);if(n)return n;const i=s.json,r=((i.extensions&&i.extensions[this.name]||{}).lights||[])[e];let c;const l=new H(16777215);r.color!==void 0&&l.setRGB(r.color[0],r.color[1],r.color[2],W);const h=r.range!==void 0?r.range:0;switch(r.type){case"directional":c=new nt(l),c.target.position.set(0,0,-1),c.add(c.target);break;case"point":c=new Hs(l),c.distance=h;break;case"spot":c=new Bs(l),c.distance=h,r.spot=r.spot||{},r.spot.innerConeAngle=r.spot.innerConeAngle!==void 0?r.spot.innerConeAngle:0,r.spot.outerConeAngle=r.spot.outerConeAngle!==void 0?r.spot.outerConeAngle:Math.PI/4,c.angle=r.spot.outerConeAngle,c.penumbra=1-r.spot.innerConeAngle/r.spot.outerConeAngle,c.target.position.set(0,0,-1),c.add(c.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+r.type)}return c.position.set(0,0,0),c.decay=2,te(c,r),r.intensity!==void 0&&(c.intensity=r.intensity),c.name=s.createUniqueName(r.name||"light_"+e),n=Promise.resolve(c),s.cache.add(t,n),n}getDependency(e,s){if(e==="light")return this._loadLight(s)}createNodeAttachment(e){const s=this,t=this.parser,i=t.json.nodes[e],a=(i.extensions&&i.extensions[this.name]||{}).light;return a===void 0?null:this._loadLight(a).then(function(r){return t._getNodeRef(s.cache,a,r)})}}class jn{constructor(){this.name=E.KHR_MATERIALS_UNLIT}getMaterialType(){return L}extendParams(e,s,t){const n=[];e.color=new H(1,1,1),e.opacity=1;const i=s.pbrMetallicRoughness;if(i){if(Array.isArray(i.baseColorFactor)){const o=i.baseColorFactor;e.color.setRGB(o[0],o[1],o[2],W),e.opacity=o[3]}i.baseColorTexture!==void 0&&n.push(t.assignTexture(e,"map",i.baseColorTexture,ne))}return Promise.all(n)}}class Nn{constructor(e){this.parser=e,this.name=E.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,s){const n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=n.extensions[this.name].emissiveStrength;return i!==void 0&&(s.emissiveIntensity=i),Promise.resolve()}}class Bn{constructor(e){this.parser=e,this.name=E.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const t=this.parser.json.materials[e];return!t.extensions||!t.extensions[this.name]?null:J}extendMaterialParams(e,s){const t=this.parser,n=t.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],o=n.extensions[this.name];if(o.clearcoatFactor!==void 0&&(s.clearcoat=o.clearcoatFactor),o.clearcoatTexture!==void 0&&i.push(t.assignTexture(s,"clearcoatMap",o.clearcoatTexture)),o.clearcoatRoughnessFactor!==void 0&&(s.clearcoatRoughness=o.clearcoatRoughnessFactor),o.clearcoatRoughnessTexture!==void 0&&i.push(t.assignTexture(s,"clearcoatRoughnessMap",o.clearcoatRoughnessTexture)),o.clearcoatNormalTexture!==void 0&&(i.push(t.assignTexture(s,"clearcoatNormalMap",o.clearcoatNormalTexture)),o.clearcoatNormalTexture.scale!==void 0)){const a=o.clearcoatNormalTexture.scale;s.clearcoatNormalScale=new F(a,a)}return Promise.all(i)}}class Hn{constructor(e){this.parser=e,this.name=E.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){const t=this.parser.json.materials[e];return!t.extensions||!t.extensions[this.name]?null:J}extendMaterialParams(e,s){const t=this.parser,n=t.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],o=n.extensions[this.name];return o.iridescenceFactor!==void 0&&(s.iridescence=o.iridescenceFactor),o.iridescenceTexture!==void 0&&i.push(t.assignTexture(s,"iridescenceMap",o.iridescenceTexture)),o.iridescenceIor!==void 0&&(s.iridescenceIOR=o.iridescenceIor),s.iridescenceThicknessRange===void 0&&(s.iridescenceThicknessRange=[100,400]),o.iridescenceThicknessMinimum!==void 0&&(s.iridescenceThicknessRange[0]=o.iridescenceThicknessMinimum),o.iridescenceThicknessMaximum!==void 0&&(s.iridescenceThicknessRange[1]=o.iridescenceThicknessMaximum),o.iridescenceThicknessTexture!==void 0&&i.push(t.assignTexture(s,"iridescenceThicknessMap",o.iridescenceThicknessTexture)),Promise.all(i)}}class Un{constructor(e){this.parser=e,this.name=E.KHR_MATERIALS_SHEEN}getMaterialType(e){const t=this.parser.json.materials[e];return!t.extensions||!t.extensions[this.name]?null:J}extendMaterialParams(e,s){const t=this.parser,n=t.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[];s.sheenColor=new H(0,0,0),s.sheenRoughness=0,s.sheen=1;const o=n.extensions[this.name];if(o.sheenColorFactor!==void 0){const a=o.sheenColorFactor;s.sheenColor.setRGB(a[0],a[1],a[2],W)}return o.sheenRoughnessFactor!==void 0&&(s.sheenRoughness=o.sheenRoughnessFactor),o.sheenColorTexture!==void 0&&i.push(t.assignTexture(s,"sheenColorMap",o.sheenColorTexture,ne)),o.sheenRoughnessTexture!==void 0&&i.push(t.assignTexture(s,"sheenRoughnessMap",o.sheenRoughnessTexture)),Promise.all(i)}}class Gn{constructor(e){this.parser=e,this.name=E.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const t=this.parser.json.materials[e];return!t.extensions||!t.extensions[this.name]?null:J}extendMaterialParams(e,s){const t=this.parser,n=t.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],o=n.extensions[this.name];return o.transmissionFactor!==void 0&&(s.transmission=o.transmissionFactor),o.transmissionTexture!==void 0&&i.push(t.assignTexture(s,"transmissionMap",o.transmissionTexture)),Promise.all(i)}}class Zn{constructor(e){this.parser=e,this.name=E.KHR_MATERIALS_VOLUME}getMaterialType(e){const t=this.parser.json.materials[e];return!t.extensions||!t.extensions[this.name]?null:J}extendMaterialParams(e,s){const t=this.parser,n=t.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],o=n.extensions[this.name];s.thickness=o.thicknessFactor!==void 0?o.thicknessFactor:0,o.thicknessTexture!==void 0&&i.push(t.assignTexture(s,"thicknessMap",o.thicknessTexture)),s.attenuationDistance=o.attenuationDistance||1/0;const a=o.attenuationColor||[1,1,1];return s.attenuationColor=new H().setRGB(a[0],a[1],a[2],W),Promise.all(i)}}class Yn{constructor(e){this.parser=e,this.name=E.KHR_MATERIALS_IOR}getMaterialType(e){const t=this.parser.json.materials[e];return!t.extensions||!t.extensions[this.name]?null:J}extendMaterialParams(e,s){const n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=n.extensions[this.name];return s.ior=i.ior!==void 0?i.ior:1.5,Promise.resolve()}}class Kn{constructor(e){this.parser=e,this.name=E.KHR_MATERIALS_SPECULAR}getMaterialType(e){const t=this.parser.json.materials[e];return!t.extensions||!t.extensions[this.name]?null:J}extendMaterialParams(e,s){const t=this.parser,n=t.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],o=n.extensions[this.name];s.specularIntensity=o.specularFactor!==void 0?o.specularFactor:1,o.specularTexture!==void 0&&i.push(t.assignTexture(s,"specularIntensityMap",o.specularTexture));const a=o.specularColorFactor||[1,1,1];return s.specularColor=new H().setRGB(a[0],a[1],a[2],W),o.specularColorTexture!==void 0&&i.push(t.assignTexture(s,"specularColorMap",o.specularColorTexture,ne)),Promise.all(i)}}class Vn{constructor(e){this.parser=e,this.name=E.EXT_MATERIALS_BUMP}getMaterialType(e){const t=this.parser.json.materials[e];return!t.extensions||!t.extensions[this.name]?null:J}extendMaterialParams(e,s){const t=this.parser,n=t.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],o=n.extensions[this.name];return s.bumpScale=o.bumpFactor!==void 0?o.bumpFactor:1,o.bumpTexture!==void 0&&i.push(t.assignTexture(s,"bumpMap",o.bumpTexture)),Promise.all(i)}}class Xn{constructor(e){this.parser=e,this.name=E.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){const t=this.parser.json.materials[e];return!t.extensions||!t.extensions[this.name]?null:J}extendMaterialParams(e,s){const t=this.parser,n=t.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],o=n.extensions[this.name];return o.anisotropyStrength!==void 0&&(s.anisotropy=o.anisotropyStrength),o.anisotropyRotation!==void 0&&(s.anisotropyRotation=o.anisotropyRotation),o.anisotropyTexture!==void 0&&i.push(t.assignTexture(s,"anisotropyMap",o.anisotropyTexture)),Promise.all(i)}}class Wn{constructor(e){this.parser=e,this.name=E.KHR_TEXTURE_BASISU}loadTexture(e){const s=this.parser,t=s.json,n=t.textures[e];if(!n.extensions||!n.extensions[this.name])return null;const i=n.extensions[this.name],o=s.options.ktx2Loader;if(!o){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return s.loadTextureImage(e,i.source,o)}}class $n{constructor(e){this.parser=e,this.name=E.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(e){const s=this.name,t=this.parser,n=t.json,i=n.textures[e];if(!i.extensions||!i.extensions[s])return null;const o=i.extensions[s],a=n.images[o.source];let r=t.textureLoader;if(a.uri){const c=t.options.manager.getHandler(a.uri);c!==null&&(r=c)}return this.detectSupport().then(function(c){if(c)return t.loadTextureImage(e,o.source,r);if(n.extensionsRequired&&n.extensionsRequired.indexOf(s)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return t.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){const s=new Image;s.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",s.onload=s.onerror=function(){e(s.height===1)}})),this.isSupported}}class qn{constructor(e){this.parser=e,this.name=E.EXT_TEXTURE_AVIF,this.isSupported=null}loadTexture(e){const s=this.name,t=this.parser,n=t.json,i=n.textures[e];if(!i.extensions||!i.extensions[s])return null;const o=i.extensions[s],a=n.images[o.source];let r=t.textureLoader;if(a.uri){const c=t.options.manager.getHandler(a.uri);c!==null&&(r=c)}return this.detectSupport().then(function(c){if(c)return t.loadTextureImage(e,o.source,r);if(n.extensionsRequired&&n.extensionsRequired.indexOf(s)>=0)throw new Error("THREE.GLTFLoader: AVIF required by asset but unsupported.");return t.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){const s=new Image;s.src="data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAABcAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQAMAAAAABNjb2xybmNseAACAAIABoAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAAB9tZGF0EgAKCBgABogQEDQgMgkQAAAAB8dSLfI=",s.onload=s.onerror=function(){e(s.height===1)}})),this.isSupported}}class Jn{constructor(e){this.name=E.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const s=this.parser.json,t=s.bufferViews[e];if(t.extensions&&t.extensions[this.name]){const n=t.extensions[this.name],i=this.parser.getDependency("buffer",n.buffer),o=this.parser.options.meshoptDecoder;if(!o||!o.supported){if(s.extensionsRequired&&s.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return i.then(function(a){const r=n.byteOffset||0,c=n.byteLength||0,l=n.count,h=n.byteStride,u=new Uint8Array(a,r,c);return o.decodeGltfBufferAsync?o.decodeGltfBufferAsync(l,h,u,n.mode,n.filter).then(function(m){return m.buffer}):o.ready.then(function(){const m=new ArrayBuffer(l*h);return o.decodeGltfBuffer(new Uint8Array(m),l,h,u,n.mode,n.filter),m})})}else return null}}class Qn{constructor(e){this.name=E.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){const s=this.parser.json,t=s.nodes[e];if(!t.extensions||!t.extensions[this.name]||t.mesh===void 0)return null;const n=s.meshes[t.mesh];for(const c of n.primitives)if(c.mode!==N.TRIANGLES&&c.mode!==N.TRIANGLE_STRIP&&c.mode!==N.TRIANGLE_FAN&&c.mode!==void 0)return null;const o=t.extensions[this.name].attributes,a=[],r={};for(const c in o)a.push(this.parser.getDependency("accessor",o[c]).then(l=>(r[c]=l,r[c])));return a.length<1?null:(a.push(this.parser.createNodeMesh(e)),Promise.all(a).then(c=>{const l=c.pop(),h=l.isGroup?l.children:[l],u=c[0].count,m=[];for(const f of h){const g=new Ne,w=new y,x=new Fe,T=new y(1,1,1),_=new De(f.geometry,f.material,u);for(let A=0;A<u;A++)r.TRANSLATION&&w.fromBufferAttribute(r.TRANSLATION,A),r.ROTATION&&x.fromBufferAttribute(r.ROTATION,A),r.SCALE&&T.fromBufferAttribute(r.SCALE,A),_.setMatrixAt(A,g.compose(w,x,T));for(const A in r)if(A==="_COLOR_0"){const S=r[A];_.instanceColor=new Us(S.array,S.itemSize,S.normalized)}else A!=="TRANSLATION"&&A!=="ROTATION"&&A!=="SCALE"&&f.geometry.setAttribute(A,r[A]);Oe.prototype.copy.call(_,f),this.parser.assignFinalMaterial(_),m.push(_)}return l.isGroup?(l.clear(),l.add(...m),l):m[0]}))}}const ts="glTF",ye=12,Ut={JSON:1313821514,BIN:5130562};class ei{constructor(e){this.name=E.KHR_BINARY_GLTF,this.content=null,this.body=null;const s=new DataView(e,0,ye),t=new TextDecoder;if(this.header={magic:t.decode(new Uint8Array(e.slice(0,4))),version:s.getUint32(4,!0),length:s.getUint32(8,!0)},this.header.magic!==ts)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const n=this.header.length-ye,i=new DataView(e,ye);let o=0;for(;o<n;){const a=i.getUint32(o,!0);o+=4;const r=i.getUint32(o,!0);if(o+=4,r===Ut.JSON){const c=new Uint8Array(e,ye+o,a);this.content=t.decode(c)}else if(r===Ut.BIN){const c=ye+o;this.body=e.slice(c,c+a)}o+=a}if(this.content===null)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class ti{constructor(e,s){if(!s)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=E.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=s,this.dracoLoader.preload()}decodePrimitive(e,s){const t=this.json,n=this.dracoLoader,i=e.extensions[this.name].bufferView,o=e.extensions[this.name].attributes,a={},r={},c={};for(const l in o){const h=lt[l]||l.toLowerCase();a[h]=o[l]}for(const l in e.attributes){const h=lt[l]||l.toLowerCase();if(o[l]!==void 0){const u=t.accessors[e.attributes[l]],m=de[u.componentType];c[h]=m.name,r[h]=u.normalized===!0}}return s.getDependency("bufferView",i).then(function(l){return new Promise(function(h,u){n.decodeDracoFile(l,function(m){for(const f in m.attributes){const g=m.attributes[f],w=r[f];w!==void 0&&(g.normalized=w)}h(m)},a,c,W,u)})})}}class si{constructor(){this.name=E.KHR_TEXTURE_TRANSFORM}extendTexture(e,s){return(s.texCoord===void 0||s.texCoord===e.channel)&&s.offset===void 0&&s.rotation===void 0&&s.scale===void 0||(e=e.clone(),s.texCoord!==void 0&&(e.channel=s.texCoord),s.offset!==void 0&&e.offset.fromArray(s.offset),s.rotation!==void 0&&(e.rotation=s.rotation),s.scale!==void 0&&e.repeat.fromArray(s.scale),e.needsUpdate=!0),e}}class ni{constructor(){this.name=E.KHR_MESH_QUANTIZATION}}class ss extends cn{constructor(e,s,t,n){super(e,s,t,n)}copySampleValue_(e){const s=this.resultBuffer,t=this.sampleValues,n=this.valueSize,i=e*n*3+n;for(let o=0;o!==n;o++)s[o]=t[i+o];return s}interpolate_(e,s,t,n){const i=this.resultBuffer,o=this.sampleValues,a=this.valueSize,r=a*2,c=a*3,l=n-s,h=(t-s)/l,u=h*h,m=u*h,f=e*c,g=f-c,w=-2*m+3*u,x=m-u,T=1-w,_=x-u+h;for(let A=0;A!==a;A++){const S=o[g+A+a],z=o[g+A+r]*l,P=o[f+A+a],Y=o[f+A]*l;i[A]=T*S+_*z+w*P+x*Y}return i}}const ii=new Fe;class oi extends ss{interpolate_(e,s,t,n){const i=super.interpolate_(e,s,t,n);return ii.fromArray(i).normalize().toArray(i),i}}const N={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},de={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},Gt={9728:Xs,9729:Te,9984:Vs,9985:Ks,9986:Ys,9987:Jt},Zt={33071:$s,33648:Ws,10497:ct},Qe={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},lt={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},ee={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},ai={CUBICSPLINE:void 0,LINEAR:Qt,STEP:an},et={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};function ri(p){return p.DefaultMaterial===void 0&&(p.DefaultMaterial=new D({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:Xt})),p.DefaultMaterial}function ie(p,e,s){for(const t in s.extensions)p[t]===void 0&&(e.userData.gltfExtensions=e.userData.gltfExtensions||{},e.userData.gltfExtensions[t]=s.extensions[t])}function te(p,e){e.extras!==void 0&&(typeof e.extras=="object"?Object.assign(p.userData,e.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+e.extras))}function ci(p,e,s){let t=!1,n=!1,i=!1;for(let c=0,l=e.length;c<l;c++){const h=e[c];if(h.POSITION!==void 0&&(t=!0),h.NORMAL!==void 0&&(n=!0),h.COLOR_0!==void 0&&(i=!0),t&&n&&i)break}if(!t&&!n&&!i)return Promise.resolve(p);const o=[],a=[],r=[];for(let c=0,l=e.length;c<l;c++){const h=e[c];if(t){const u=h.POSITION!==void 0?s.getDependency("accessor",h.POSITION):p.attributes.position;o.push(u)}if(n){const u=h.NORMAL!==void 0?s.getDependency("accessor",h.NORMAL):p.attributes.normal;a.push(u)}if(i){const u=h.COLOR_0!==void 0?s.getDependency("accessor",h.COLOR_0):p.attributes.color;r.push(u)}}return Promise.all([Promise.all(o),Promise.all(a),Promise.all(r)]).then(function(c){const l=c[0],h=c[1],u=c[2];return t&&(p.morphAttributes.position=l),n&&(p.morphAttributes.normal=h),i&&(p.morphAttributes.color=u),p.morphTargetsRelative=!0,p})}function li(p,e){if(p.updateMorphTargets(),e.weights!==void 0)for(let s=0,t=e.weights.length;s<t;s++)p.morphTargetInfluences[s]=e.weights[s];if(e.extras&&Array.isArray(e.extras.targetNames)){const s=e.extras.targetNames;if(p.morphTargetInfluences.length===s.length){p.morphTargetDictionary={};for(let t=0,n=s.length;t<n;t++)p.morphTargetDictionary[s[t]]=t}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function hi(p){let e;const s=p.extensions&&p.extensions[E.KHR_DRACO_MESH_COMPRESSION];if(s?e="draco:"+s.bufferView+":"+s.indices+":"+tt(s.attributes):e=p.indices+":"+tt(p.attributes)+":"+p.mode,p.targets!==void 0)for(let t=0,n=p.targets.length;t<n;t++)e+=":"+tt(p.targets[t]);return e}function tt(p){let e="";const s=Object.keys(p).sort();for(let t=0,n=s.length;t<n;t++)e+=s[t]+":"+p[s[t]]+";";return e}function ht(p){switch(p){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}function di(p){return p.search(/\.jpe?g($|\?)/i)>0||p.search(/^data\:image\/jpeg/)===0?"image/jpeg":p.search(/\.webp($|\?)/i)>0||p.search(/^data\:image\/webp/)===0?"image/webp":"image/png"}const ui=new Ne;class pi{constructor(e={},s={}){this.json=e,this.extensions={},this.plugins={},this.options=s,this.cache=new Fn,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let t=!1,n=!1,i=-1;typeof navigator<"u"&&(t=/^((?!chrome|android).)*safari/i.test(navigator.userAgent)===!0,n=navigator.userAgent.indexOf("Firefox")>-1,i=n?navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1]:-1),typeof createImageBitmap>"u"||t||n&&i<98?this.textureLoader=new qt(this.options.manager):this.textureLoader=new Gs(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new je(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),this.options.crossOrigin==="use-credentials"&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,s){const t=this,n=this.json,i=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll(function(o){return o._markDefs&&o._markDefs()}),Promise.all(this._invokeAll(function(o){return o.beforeRoot&&o.beforeRoot()})).then(function(){return Promise.all([t.getDependencies("scene"),t.getDependencies("animation"),t.getDependencies("camera")])}).then(function(o){const a={scene:o[0][n.scene||0],scenes:o[0],animations:o[1],cameras:o[2],asset:n.asset,parser:t,userData:{}};return ie(i,a,n),te(a,n),Promise.all(t._invokeAll(function(r){return r.afterRoot&&r.afterRoot(a)})).then(function(){e(a)})}).catch(s)}_markDefs(){const e=this.json.nodes||[],s=this.json.skins||[],t=this.json.meshes||[];for(let n=0,i=s.length;n<i;n++){const o=s[n].joints;for(let a=0,r=o.length;a<r;a++)e[o[a]].isBone=!0}for(let n=0,i=e.length;n<i;n++){const o=e[n];o.mesh!==void 0&&(this._addNodeRef(this.meshCache,o.mesh),o.skin!==void 0&&(t[o.mesh].isSkinnedMesh=!0)),o.camera!==void 0&&this._addNodeRef(this.cameraCache,o.camera)}}_addNodeRef(e,s){s!==void 0&&(e.refs[s]===void 0&&(e.refs[s]=e.uses[s]=0),e.refs[s]++)}_getNodeRef(e,s,t){if(e.refs[s]<=1)return t;const n=t.clone(),i=(o,a)=>{const r=this.associations.get(o);r!=null&&this.associations.set(a,r);for(const[c,l]of o.children.entries())i(l,a.children[c])};return i(t,n),n.name+="_instance_"+e.uses[s]++,n}_invokeOne(e){const s=Object.values(this.plugins);s.push(this);for(let t=0;t<s.length;t++){const n=e(s[t]);if(n)return n}return null}_invokeAll(e){const s=Object.values(this.plugins);s.unshift(this);const t=[];for(let n=0;n<s.length;n++){const i=e(s[n]);i&&t.push(i)}return t}getDependency(e,s){const t=e+":"+s;let n=this.cache.get(t);if(!n){switch(e){case"scene":n=this.loadScene(s);break;case"node":n=this._invokeOne(function(i){return i.loadNode&&i.loadNode(s)});break;case"mesh":n=this._invokeOne(function(i){return i.loadMesh&&i.loadMesh(s)});break;case"accessor":n=this.loadAccessor(s);break;case"bufferView":n=this._invokeOne(function(i){return i.loadBufferView&&i.loadBufferView(s)});break;case"buffer":n=this.loadBuffer(s);break;case"material":n=this._invokeOne(function(i){return i.loadMaterial&&i.loadMaterial(s)});break;case"texture":n=this._invokeOne(function(i){return i.loadTexture&&i.loadTexture(s)});break;case"skin":n=this.loadSkin(s);break;case"animation":n=this._invokeOne(function(i){return i.loadAnimation&&i.loadAnimation(s)});break;case"camera":n=this.loadCamera(s);break;default:if(n=this._invokeOne(function(i){return i!=this&&i.getDependency&&i.getDependency(e,s)}),!n)throw new Error("Unknown type: "+e);break}this.cache.add(t,n)}return n}getDependencies(e){let s=this.cache.get(e);if(!s){const t=this,n=this.json[e+(e==="mesh"?"es":"s")]||[];s=Promise.all(n.map(function(i,o){return t.getDependency(e,o)})),this.cache.add(e,s)}return s}loadBuffer(e){const s=this.json.buffers[e],t=this.fileLoader;if(s.type&&s.type!=="arraybuffer")throw new Error("THREE.GLTFLoader: "+s.type+" buffer type is not supported.");if(s.uri===void 0&&e===0)return Promise.resolve(this.extensions[E.KHR_BINARY_GLTF].body);const n=this.options;return new Promise(function(i,o){t.load(ve.resolveURL(s.uri,n.path),i,void 0,function(){o(new Error('THREE.GLTFLoader: Failed to load buffer "'+s.uri+'".'))})})}loadBufferView(e){const s=this.json.bufferViews[e];return this.getDependency("buffer",s.buffer).then(function(t){const n=s.byteLength||0,i=s.byteOffset||0;return t.slice(i,i+n)})}loadAccessor(e){const s=this,t=this.json,n=this.json.accessors[e];if(n.bufferView===void 0&&n.sparse===void 0){const o=Qe[n.type],a=de[n.componentType],r=n.normalized===!0,c=new a(n.count*o);return Promise.resolve(new se(c,o,r))}const i=[];return n.bufferView!==void 0?i.push(this.getDependency("bufferView",n.bufferView)):i.push(null),n.sparse!==void 0&&(i.push(this.getDependency("bufferView",n.sparse.indices.bufferView)),i.push(this.getDependency("bufferView",n.sparse.values.bufferView))),Promise.all(i).then(function(o){const a=o[0],r=Qe[n.type],c=de[n.componentType],l=c.BYTES_PER_ELEMENT,h=l*r,u=n.byteOffset||0,m=n.bufferView!==void 0?t.bufferViews[n.bufferView].byteStride:void 0,f=n.normalized===!0;let g,w;if(m&&m!==h){const x=Math.floor(u/m),T="InterleavedBuffer:"+n.bufferView+":"+n.componentType+":"+x+":"+n.count;let _=s.cache.get(T);_||(g=new c(a,x*m,n.count*m/l),_=new Zs(g,m/l),s.cache.add(T,_)),w=new rn(_,r,u%m/l,f)}else a===null?g=new c(n.count*r):g=new c(a,u,n.count*r),w=new se(g,r,f);if(n.sparse!==void 0){const x=Qe.SCALAR,T=de[n.sparse.indices.componentType],_=n.sparse.indices.byteOffset||0,A=n.sparse.values.byteOffset||0,S=new T(o[1],_,n.sparse.count*x),z=new c(o[2],A,n.sparse.count*r);a!==null&&(w=new se(w.array.slice(),w.itemSize,w.normalized));for(let P=0,Y=S.length;P<Y;P++){const O=S[P];if(w.setX(O,z[P*r]),r>=2&&w.setY(O,z[P*r+1]),r>=3&&w.setZ(O,z[P*r+2]),r>=4&&w.setW(O,z[P*r+3]),r>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return w})}loadTexture(e){const s=this.json,t=this.options,i=s.textures[e].source,o=s.images[i];let a=this.textureLoader;if(o.uri){const r=t.manager.getHandler(o.uri);r!==null&&(a=r)}return this.loadTextureImage(e,i,a)}loadTextureImage(e,s,t){const n=this,i=this.json,o=i.textures[e],a=i.images[s],r=(a.uri||a.bufferView)+":"+o.sampler;if(this.textureCache[r])return this.textureCache[r];const c=this.loadImageSource(s,t).then(function(l){l.flipY=!1,l.name=o.name||a.name||"",l.name===""&&typeof a.uri=="string"&&a.uri.startsWith("data:image/")===!1&&(l.name=a.uri);const u=(i.samplers||{})[o.sampler]||{};return l.magFilter=Gt[u.magFilter]||Te,l.minFilter=Gt[u.minFilter]||Jt,l.wrapS=Zt[u.wrapS]||ct,l.wrapT=Zt[u.wrapT]||ct,n.associations.set(l,{textures:e}),l}).catch(function(){return null});return this.textureCache[r]=c,c}loadImageSource(e,s){const t=this,n=this.json,i=this.options;if(this.sourceCache[e]!==void 0)return this.sourceCache[e].then(h=>h.clone());const o=n.images[e],a=self.URL||self.webkitURL;let r=o.uri||"",c=!1;if(o.bufferView!==void 0)r=t.getDependency("bufferView",o.bufferView).then(function(h){c=!0;const u=new Blob([h],{type:o.mimeType});return r=a.createObjectURL(u),r});else if(o.uri===void 0)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const l=Promise.resolve(r).then(function(h){return new Promise(function(u,m){let f=u;s.isImageBitmapLoader===!0&&(f=function(g){const w=new It(g);w.needsUpdate=!0,u(w)}),s.load(ve.resolveURL(h,i.path),f,void 0,m)})}).then(function(h){return c===!0&&a.revokeObjectURL(r),h.userData.mimeType=o.mimeType||di(o.uri),h}).catch(function(h){throw console.error("THREE.GLTFLoader: Couldn't load texture",r),h});return this.sourceCache[e]=l,l}assignTexture(e,s,t,n){const i=this;return this.getDependency("texture",t.index).then(function(o){if(!o)return null;if(t.texCoord!==void 0&&t.texCoord>0&&(o=o.clone(),o.channel=t.texCoord),i.extensions[E.KHR_TEXTURE_TRANSFORM]){const a=t.extensions!==void 0?t.extensions[E.KHR_TEXTURE_TRANSFORM]:void 0;if(a){const r=i.associations.get(o);o=i.extensions[E.KHR_TEXTURE_TRANSFORM].extendTexture(o,a),i.associations.set(o,r)}}return n!==void 0&&(o.colorSpace=n),e[s]=o,o})}assignFinalMaterial(e){const s=e.geometry;let t=e.material;const n=s.attributes.tangent===void 0,i=s.attributes.color!==void 0,o=s.attributes.normal===void 0;if(e.isPoints){const a="PointsMaterial:"+t.uuid;let r=this.cache.get(a);r||(r=new at,$e.prototype.copy.call(r,t),r.color.copy(t.color),r.map=t.map,r.sizeAttenuation=!1,this.cache.add(a,r)),t=r}else if(e.isLine){const a="LineBasicMaterial:"+t.uuid;let r=this.cache.get(a);r||(r=new Ie,$e.prototype.copy.call(r,t),r.color.copy(t.color),r.map=t.map,this.cache.add(a,r)),t=r}if(n||i||o){let a="ClonedMaterial:"+t.uuid+":";n&&(a+="derivative-tangents:"),i&&(a+="vertex-colors:"),o&&(a+="flat-shading:");let r=this.cache.get(a);r||(r=t.clone(),i&&(r.vertexColors=!0),o&&(r.flatShading=!0),n&&(r.normalScale&&(r.normalScale.y*=-1),r.clearcoatNormalScale&&(r.clearcoatNormalScale.y*=-1)),this.cache.add(a,r),this.associations.set(r,this.associations.get(t))),t=r}e.material=t}getMaterialType(){return D}loadMaterial(e){const s=this,t=this.json,n=this.extensions,i=t.materials[e];let o;const a={},r=i.extensions||{},c=[];if(r[E.KHR_MATERIALS_UNLIT]){const h=n[E.KHR_MATERIALS_UNLIT];o=h.getMaterialType(),c.push(h.extendParams(a,i,s))}else{const h=i.pbrMetallicRoughness||{};if(a.color=new H(1,1,1),a.opacity=1,Array.isArray(h.baseColorFactor)){const u=h.baseColorFactor;a.color.setRGB(u[0],u[1],u[2],W),a.opacity=u[3]}h.baseColorTexture!==void 0&&c.push(s.assignTexture(a,"map",h.baseColorTexture,ne)),a.metalness=h.metallicFactor!==void 0?h.metallicFactor:1,a.roughness=h.roughnessFactor!==void 0?h.roughnessFactor:1,h.metallicRoughnessTexture!==void 0&&(c.push(s.assignTexture(a,"metalnessMap",h.metallicRoughnessTexture)),c.push(s.assignTexture(a,"roughnessMap",h.metallicRoughnessTexture))),o=this._invokeOne(function(u){return u.getMaterialType&&u.getMaterialType(e)}),c.push(Promise.all(this._invokeAll(function(u){return u.extendMaterialParams&&u.extendMaterialParams(e,a)})))}i.doubleSided===!0&&(a.side=B);const l=i.alphaMode||et.OPAQUE;if(l===et.BLEND?(a.transparent=!0,a.depthWrite=!1):(a.transparent=!1,l===et.MASK&&(a.alphaTest=i.alphaCutoff!==void 0?i.alphaCutoff:.5)),i.normalTexture!==void 0&&o!==L&&(c.push(s.assignTexture(a,"normalMap",i.normalTexture)),a.normalScale=new F(1,1),i.normalTexture.scale!==void 0)){const h=i.normalTexture.scale;a.normalScale.set(h,h)}if(i.occlusionTexture!==void 0&&o!==L&&(c.push(s.assignTexture(a,"aoMap",i.occlusionTexture)),i.occlusionTexture.strength!==void 0&&(a.aoMapIntensity=i.occlusionTexture.strength)),i.emissiveFactor!==void 0&&o!==L){const h=i.emissiveFactor;a.emissive=new H().setRGB(h[0],h[1],h[2],W)}return i.emissiveTexture!==void 0&&o!==L&&c.push(s.assignTexture(a,"emissiveMap",i.emissiveTexture,ne)),Promise.all(c).then(function(){const h=new o(a);return i.name&&(h.name=i.name),te(h,i),s.associations.set(h,{materials:e}),i.extensions&&ie(n,h,i),h})}createUniqueName(e){const s=qs.sanitizeNodeName(e||"");return s in this.nodeNamesUsed?s+"_"+ ++this.nodeNamesUsed[s]:(this.nodeNamesUsed[s]=0,s)}loadGeometries(e){const s=this,t=this.extensions,n=this.primitiveCache;function i(a){return t[E.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(a,s).then(function(r){return Yt(r,a,s)})}const o=[];for(let a=0,r=e.length;a<r;a++){const c=e[a],l=hi(c),h=n[l];if(h)o.push(h.promise);else{let u;c.extensions&&c.extensions[E.KHR_DRACO_MESH_COMPRESSION]?u=i(c):u=Yt(new oe,c,s),n[l]={primitive:c,promise:u},o.push(u)}}return Promise.all(o)}loadMesh(e){const s=this,t=this.json,n=this.extensions,i=t.meshes[e],o=i.primitives,a=[];for(let r=0,c=o.length;r<c;r++){const l=o[r].material===void 0?ri(this.cache):this.getDependency("material",o[r].material);a.push(l)}return a.push(s.loadGeometries(o)),Promise.all(a).then(function(r){const c=r.slice(0,r.length-1),l=r[r.length-1],h=[];for(let m=0,f=l.length;m<f;m++){const g=l[m],w=o[m];let x;const T=c[m];if(w.mode===N.TRIANGLES||w.mode===N.TRIANGLE_STRIP||w.mode===N.TRIANGLE_FAN||w.mode===void 0)x=i.isSkinnedMesh===!0?new Js(g,T):new b(g,T),x.isSkinnedMesh===!0&&x.normalizeSkinWeights(),w.mode===N.TRIANGLE_STRIP?x.geometry=Ht(x.geometry,Wt):w.mode===N.TRIANGLE_FAN&&(x.geometry=Ht(x.geometry,rt));else if(w.mode===N.LINES)x=new Qs(g,T);else if(w.mode===N.LINE_STRIP)x=new Re(g,T);else if(w.mode===N.LINE_LOOP)x=new en(g,T);else if(w.mode===N.POINTS)x=new ot(g,T);else throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+w.mode);Object.keys(x.geometry.morphAttributes).length>0&&li(x,i),x.name=s.createUniqueName(i.name||"mesh_"+e),te(x,i),w.extensions&&ie(n,x,w),s.assignFinalMaterial(x),h.push(x)}for(let m=0,f=h.length;m<f;m++)s.associations.set(h[m],{meshes:e,primitives:m});if(h.length===1)return i.extensions&&ie(n,h[0],i),h[0];const u=new X;i.extensions&&ie(n,u,i),s.associations.set(u,{meshes:e});for(let m=0,f=h.length;m<f;m++)u.add(h[m]);return u})}loadCamera(e){let s;const t=this.json.cameras[e],n=t[t.type];if(!n){console.warn("THREE.GLTFLoader: Missing camera parameters.");return}return t.type==="perspective"?s=new Kt(dt.radToDeg(n.yfov),n.aspectRatio||1,n.znear||1,n.zfar||2e6):t.type==="orthographic"&&(s=new tn(-n.xmag,n.xmag,n.ymag,-n.ymag,n.znear,n.zfar)),t.name&&(s.name=this.createUniqueName(t.name)),te(s,t),Promise.resolve(s)}loadSkin(e){const s=this.json.skins[e],t=[];for(let n=0,i=s.joints.length;n<i;n++)t.push(this._loadNodeShallow(s.joints[n]));return s.inverseBindMatrices!==void 0?t.push(this.getDependency("accessor",s.inverseBindMatrices)):t.push(null),Promise.all(t).then(function(n){const i=n.pop(),o=n,a=[],r=[];for(let c=0,l=o.length;c<l;c++){const h=o[c];if(h){a.push(h);const u=new Ne;i!==null&&u.fromArray(i.array,c*16),r.push(u)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',s.joints[c])}return new sn(a,r)})}loadAnimation(e){const s=this.json,t=this,n=s.animations[e],i=n.name?n.name:"animation_"+e,o=[],a=[],r=[],c=[],l=[];for(let h=0,u=n.channels.length;h<u;h++){const m=n.channels[h],f=n.samplers[m.sampler],g=m.target,w=g.node,x=n.parameters!==void 0?n.parameters[f.input]:f.input,T=n.parameters!==void 0?n.parameters[f.output]:f.output;g.node!==void 0&&(o.push(this.getDependency("node",w)),a.push(this.getDependency("accessor",x)),r.push(this.getDependency("accessor",T)),c.push(f),l.push(g))}return Promise.all([Promise.all(o),Promise.all(a),Promise.all(r),Promise.all(c),Promise.all(l)]).then(function(h){const u=h[0],m=h[1],f=h[2],g=h[3],w=h[4],x=[];for(let T=0,_=u.length;T<_;T++){const A=u[T],S=m[T],z=f[T],P=g[T],Y=w[T];if(A===void 0)continue;A.updateMatrix&&A.updateMatrix();const O=t._createAnimationTracks(A,S,z,P,Y);if(O)for(let ue=0;ue<O.length;ue++)x.push(O[ue])}return new nn(i,void 0,x)})}createNodeMesh(e){const s=this.json,t=this,n=s.nodes[e];return n.mesh===void 0?null:t.getDependency("mesh",n.mesh).then(function(i){const o=t._getNodeRef(t.meshCache,n.mesh,i);return n.weights!==void 0&&o.traverse(function(a){if(a.isMesh)for(let r=0,c=n.weights.length;r<c;r++)a.morphTargetInfluences[r]=n.weights[r]}),o})}loadNode(e){const s=this.json,t=this,n=s.nodes[e],i=t._loadNodeShallow(e),o=[],a=n.children||[];for(let c=0,l=a.length;c<l;c++)o.push(t.getDependency("node",a[c]));const r=n.skin===void 0?Promise.resolve(null):t.getDependency("skin",n.skin);return Promise.all([i,Promise.all(o),r]).then(function(c){const l=c[0],h=c[1],u=c[2];u!==null&&l.traverse(function(m){m.isSkinnedMesh&&m.bind(u,ui)});for(let m=0,f=h.length;m<f;m++)l.add(h[m]);return l})}_loadNodeShallow(e){const s=this.json,t=this.extensions,n=this;if(this.nodeCache[e]!==void 0)return this.nodeCache[e];const i=s.nodes[e],o=i.name?n.createUniqueName(i.name):"",a=[],r=n._invokeOne(function(c){return c.createNodeMesh&&c.createNodeMesh(e)});return r&&a.push(r),i.camera!==void 0&&a.push(n.getDependency("camera",i.camera).then(function(c){return n._getNodeRef(n.cameraCache,i.camera,c)})),n._invokeAll(function(c){return c.createNodeAttachment&&c.createNodeAttachment(e)}).forEach(function(c){a.push(c)}),this.nodeCache[e]=Promise.all(a).then(function(c){let l;if(i.isBone===!0?l=new on:c.length>1?l=new X:c.length===1?l=c[0]:l=new Oe,l!==c[0])for(let h=0,u=c.length;h<u;h++)l.add(c[h]);if(i.name&&(l.userData.name=i.name,l.name=o),te(l,i),i.extensions&&ie(t,l,i),i.matrix!==void 0){const h=new Ne;h.fromArray(i.matrix),l.applyMatrix4(h)}else i.translation!==void 0&&l.position.fromArray(i.translation),i.rotation!==void 0&&l.quaternion.fromArray(i.rotation),i.scale!==void 0&&l.scale.fromArray(i.scale);return n.associations.has(l)||n.associations.set(l,{}),n.associations.get(l).nodes=e,l}),this.nodeCache[e]}loadScene(e){const s=this.extensions,t=this.json.scenes[e],n=this,i=new X;t.name&&(i.name=n.createUniqueName(t.name)),te(i,t),t.extensions&&ie(s,i,t);const o=t.nodes||[],a=[];for(let r=0,c=o.length;r<c;r++)a.push(n.getDependency("node",o[r]));return Promise.all(a).then(function(r){for(let l=0,h=r.length;l<h;l++)i.add(r[l]);const c=l=>{const h=new Map;for(const[u,m]of n.associations)(u instanceof $e||u instanceof It)&&h.set(u,m);return l.traverse(u=>{const m=n.associations.get(u);m!=null&&h.set(u,m)}),h};return n.associations=c(i),i})}_createAnimationTracks(e,s,t,n,i){const o=[],a=e.name?e.name:e.uuid,r=[];ee[i.path]===ee.weights?e.traverse(function(u){u.morphTargetInfluences&&r.push(u.name?u.name:u.uuid)}):r.push(a);let c;switch(ee[i.path]){case ee.weights:c=Dt;break;case ee.rotation:c=zt;break;case ee.position:case ee.scale:c=Rt;break;default:switch(t.itemSize){case 1:c=Dt;break;case 2:case 3:default:c=Rt;break}break}const l=n.interpolation!==void 0?ai[n.interpolation]:Qt,h=this._getArrayFromAccessor(t);for(let u=0,m=r.length;u<m;u++){const f=new c(r[u]+"."+ee[i.path],s.array,h,l);n.interpolation==="CUBICSPLINE"&&this._createCubicSplineTrackInterpolant(f),o.push(f)}return o}_getArrayFromAccessor(e){let s=e.array;if(e.normalized){const t=ht(s.constructor),n=new Float32Array(s.length);for(let i=0,o=s.length;i<o;i++)n[i]=s[i]*t;s=n}return s}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(t){const n=this instanceof zt?oi:ss;return new n(this.times,this.values,this.getValueSize()/3,t)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function mi(p,e,s){const t=e.attributes,n=new xe;if(t.POSITION!==void 0){const a=s.json.accessors[t.POSITION],r=a.min,c=a.max;if(r!==void 0&&c!==void 0){if(n.set(new y(r[0],r[1],r[2]),new y(c[0],c[1],c[2])),a.normalized){const l=ht(de[a.componentType]);n.min.multiplyScalar(l),n.max.multiplyScalar(l)}}else{console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");return}}else return;const i=e.targets;if(i!==void 0){const a=new y,r=new y;for(let c=0,l=i.length;c<l;c++){const h=i[c];if(h.POSITION!==void 0){const u=s.json.accessors[h.POSITION],m=u.min,f=u.max;if(m!==void 0&&f!==void 0){if(r.setX(Math.max(Math.abs(m[0]),Math.abs(f[0]))),r.setY(Math.max(Math.abs(m[1]),Math.abs(f[1]))),r.setZ(Math.max(Math.abs(m[2]),Math.abs(f[2]))),u.normalized){const g=ht(de[u.componentType]);r.multiplyScalar(g)}a.max(r)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}n.expandByVector(a)}p.boundingBox=n;const o=new ln;n.getCenter(o.center),o.radius=n.min.distanceTo(n.max)/2,p.boundingSphere=o}function Yt(p,e,s){const t=e.attributes,n=[];function i(o,a){return s.getDependency("accessor",o).then(function(r){p.setAttribute(a,r)})}for(const o in t){const a=lt[o]||o.toLowerCase();a in p.attributes||n.push(i(t[o],a))}if(e.indices!==void 0&&!p.index){const o=s.getDependency("accessor",e.indices).then(function(a){p.setIndex(a)});n.push(o)}return Ft.workingColorSpace!==W&&"COLOR_0"in t&&console.warn(`THREE.GLTFLoader: Converting vertex colors from "srgb-linear" to "${Ft.workingColorSpace}" not supported.`),te(p,e),mi(p,e,s),Promise.all(n).then(function(){return e.targets!==void 0?ci(p,e.targets,s):p})}const st=new WeakMap;class ns extends $t{constructor(e){super(e),this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}}setDecoderPath(e){return this.decoderPath=e,this}setDecoderConfig(e){return this.decoderConfig=e,this}setWorkerLimit(e){return this.workerLimit=e,this}load(e,s,t,n){const i=new je(this.manager);i.setPath(this.path),i.setResponseType("arraybuffer"),i.setRequestHeader(this.requestHeader),i.setWithCredentials(this.withCredentials),i.load(e,o=>{this.parse(o,s,n)},t,n)}parse(e,s,t=()=>{}){this.decodeDracoFile(e,s,null,null,ne).catch(t)}decodeDracoFile(e,s,t,n,i=W,o=()=>{}){const a={attributeIDs:t||this.defaultAttributeIDs,attributeTypes:n||this.defaultAttributeTypes,useUniqueIDs:!!t,vertexColorSpace:i};return this.decodeGeometry(e,a).then(s).catch(o)}decodeGeometry(e,s){const t=JSON.stringify(s);if(st.has(e)){const r=st.get(e);if(r.key===t)return r.promise;if(e.byteLength===0)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}let n;const i=this.workerNextTaskID++,o=e.byteLength,a=this._getWorker(i,o).then(r=>(n=r,new Promise((c,l)=>{n._callbacks[i]={resolve:c,reject:l},n.postMessage({type:"decode",id:i,taskConfig:s,buffer:e},[e])}))).then(r=>this._createGeometry(r.geometry));return a.catch(()=>!0).then(()=>{n&&i&&this._releaseTask(n,i)}),st.set(e,{key:t,promise:a}),a}_createGeometry(e){const s=new oe;e.index&&s.setIndex(new se(e.index.array,1));for(let t=0;t<e.attributes.length;t++){const n=e.attributes[t],i=n.name,o=n.array,a=n.itemSize,r=new se(o,a);i==="color"&&(this._assignVertexColorSpace(r,n.vertexColorSpace),r.normalized=!(o instanceof Float32Array)),s.setAttribute(i,r)}return s}_assignVertexColorSpace(e,s){if(s!==ne)return;const t=new H;for(let n=0,i=e.count;n<i;n++)t.fromBufferAttribute(e,n).convertSRGBToLinear(),e.setXYZ(n,t.r,t.g,t.b)}_loadLibrary(e,s){const t=new je(this.manager);return t.setPath(this.decoderPath),t.setResponseType(s),t.setWithCredentials(this.withCredentials),new Promise((n,i)=>{t.load(e,n,void 0,i)})}preload(){return this._initDecoder(),this}_initDecoder(){if(this.decoderPending)return this.decoderPending;const e=typeof WebAssembly!="object"||this.decoderConfig.type==="js",s=[];return e?s.push(this._loadLibrary("draco_decoder.js","text")):(s.push(this._loadLibrary("draco_wasm_wrapper.js","text")),s.push(this._loadLibrary("draco_decoder.wasm","arraybuffer"))),this.decoderPending=Promise.all(s).then(t=>{const n=t[0];e||(this.decoderConfig.wasmBinary=t[1]);const i=fi.toString(),o=["/* draco decoder */",n,"","/* worker */",i.substring(i.indexOf("{")+1,i.lastIndexOf("}"))].join(`
`);this.workerSourceURL=URL.createObjectURL(new Blob([o]))}),this.decoderPending}_getWorker(e,s){return this._initDecoder().then(()=>{if(this.workerPool.length<this.workerLimit){const n=new Worker(this.workerSourceURL);n._callbacks={},n._taskCosts={},n._taskLoad=0,n.postMessage({type:"init",decoderConfig:this.decoderConfig}),n.onmessage=function(i){const o=i.data;switch(o.type){case"decode":n._callbacks[o.id].resolve(o);break;case"error":n._callbacks[o.id].reject(o);break;default:console.error('THREE.DRACOLoader: Unexpected message, "'+o.type+'"')}},this.workerPool.push(n)}else this.workerPool.sort(function(n,i){return n._taskLoad>i._taskLoad?-1:1});const t=this.workerPool[this.workerPool.length-1];return t._taskCosts[e]=s,t._taskLoad+=s,t})}_releaseTask(e,s){e._taskLoad-=e._taskCosts[s],delete e._callbacks[s],delete e._taskCosts[s]}debug(){console.log("Task load: ",this.workerPool.map(e=>e._taskLoad))}dispose(){for(let e=0;e<this.workerPool.length;++e)this.workerPool[e].terminate();return this.workerPool.length=0,this.workerSourceURL!==""&&URL.revokeObjectURL(this.workerSourceURL),this}}function fi(){let p,e;onmessage=function(o){const a=o.data;switch(a.type){case"init":p=a.decoderConfig,e=new Promise(function(l){p.onModuleLoaded=function(h){l({draco:h})},DracoDecoderModule(p)});break;case"decode":const r=a.buffer,c=a.taskConfig;e.then(l=>{const h=l.draco,u=new h.Decoder;try{const m=s(h,u,new Int8Array(r),c),f=m.attributes.map(g=>g.array.buffer);m.index&&f.push(m.index.array.buffer),self.postMessage({type:"decode",id:a.id,geometry:m},f)}catch(m){console.error(m),self.postMessage({type:"error",id:a.id,error:m.message})}finally{h.destroy(u)}});break}};function s(o,a,r,c){const l=c.attributeIDs,h=c.attributeTypes;let u,m;const f=a.GetEncodedGeometryType(r);if(f===o.TRIANGULAR_MESH)u=new o.Mesh,m=a.DecodeArrayToMesh(r,r.byteLength,u);else if(f===o.POINT_CLOUD)u=new o.PointCloud,m=a.DecodeArrayToPointCloud(r,r.byteLength,u);else throw new Error("THREE.DRACOLoader: Unexpected geometry type.");if(!m.ok()||u.ptr===0)throw new Error("THREE.DRACOLoader: Decoding failed: "+m.error_msg());const g={index:null,attributes:[]};for(const w in l){const x=self[h[w]];let T,_;if(c.useUniqueIDs)_=l[w],T=a.GetAttributeByUniqueId(u,_);else{if(_=a.GetAttributeId(u,o[l[w]]),_===-1)continue;T=a.GetAttribute(u,_)}const A=n(o,a,u,w,x,T);w==="color"&&(A.vertexColorSpace=c.vertexColorSpace),g.attributes.push(A)}return f===o.TRIANGULAR_MESH&&(g.index=t(o,a,u)),o.destroy(u),g}function t(o,a,r){const l=r.num_faces()*3,h=l*4,u=o._malloc(h);a.GetTrianglesUInt32Array(r,h,u);const m=new Uint32Array(o.HEAPF32.buffer,u,l).slice();return o._free(u),{array:m,itemSize:1}}function n(o,a,r,c,l,h){const u=h.num_components(),f=r.num_points()*u,g=f*l.BYTES_PER_ELEMENT,w=i(o,l),x=o._malloc(g);a.GetAttributeDataArrayForAllPoints(r,h,w,g,x);const T=new l(o.HEAPF32.buffer,x,f).slice();return o._free(x),{name:c,array:T,itemSize:u}}function i(o,a){switch(a){case Float32Array:return o.DT_FLOAT32;case Int8Array:return o.DT_INT8;case Int16Array:return o.DT_INT16;case Int32Array:return o.DT_INT32;case Uint8Array:return o.DT_UINT8;case Uint16Array:return o.DT_UINT16;case Uint32Array:return o.DT_UINT32}}}class gi{constructor(){this.experience=new C,this.scene=this.experience.scene,this.resources=this.experience.resources,this.physics=this.experience.physics,this.activeMode="test",this.activeEnvironment=null,this.forestModel=null,this.forestLoading=!1,this.portfolioShowcase=null,this.currentZone=null,this.visitedZones=new Set(["HUB"]),this.environment=new Mn,this.player=new _n,this.createTestEnvironment(),this._onToggle=()=>this.toggleEnvironment(),window.addEventListener("toggleEnvironment",this._onToggle)}createTestEnvironment(){this.disposeCurrentEnvironment(),this.activeMode="test",this.activeEnvironment=new Pn,this.portfolioShowcase=new zn(this.activeEnvironment.zones),this.player.teleport({x:0,y:2,z:5}),console.log("üß™ Switched to Test Environment"),this.updateToggleUI()}createForestEnvironment(){var n;if(this.forestLoading){console.warn("‚ö†Ô∏è Forest GLB still loading...");return}if(this.forestModel){this._switchToForest();return}this.forestLoading=!0,console.log("üå≥ Loading forest GLB..."),(n=this.experience.uiManager)==null||n.notify("Loading forest environment...","info",5e3);const e=new es,s=new ns;s.setDecoderPath("/3JS-visual-portfolio/draco/"),e.setDRACOLoader(s),e.load("models/environment/free_low_poly_forest.glb",i=>{this.forestModel=i,this.resources.items.forestEnvironment=i,this.forestLoading=!1,console.log("‚úÖ Forest GLB loaded"),this._switchToForest(),s.dispose()},i=>{if(i.lengthComputable){const o=Math.round(i.loaded/i.total*100);console.log(`üå≥ Forest loading: ${o}%`)}},i=>{var o;this.forestLoading=!1,console.error("‚ùå Failed to load forest GLB",i),(o=this.experience.uiManager)==null||o.notify("Failed to load forest","error"),s.dispose()})}_switchToForest(){this.disposeCurrentEnvironment(),this.activeMode="forest",this.activeEnvironment=new kn,this.player.teleport({x:0,y:2,z:5}),console.log("üå≥ Switched to Forest Environment"),this.updateToggleUI()}toggleEnvironment(){this.activeMode==="test"?this.createForestEnvironment():this.createTestEnvironment()}disposeCurrentEnvironment(){this.portfolioShowcase&&(this.portfolioShowcase.dispose(),this.portfolioShowcase=null),this.activeEnvironment&&(this.activeEnvironment.dispose(),this.activeEnvironment=null),this.currentZone=null}updateToggleUI(){window.dispatchEvent(new CustomEvent("environmentChanged",{detail:{mode:this.activeMode}}))}update(e){if(this.player&&(this.player.update(),this.activeEnvironment&&this.activeEnvironment.getZoneAtPosition)){const s=this.player.mesh.position,t=this.activeEnvironment.getZoneAtPosition(s);t&&t.id!==this.currentZone?this.onZoneEnter(t):!t&&this.currentZone&&this.onZoneExit()}this.activeEnvironment&&this.activeEnvironment.update(e),this.portfolioShowcase&&this.portfolioShowcase.update(e)}onZoneEnter(e){const s=!this.visitedZones.has(e.id);this.currentZone=e.id,this.visitedZones.add(e.id),console.log(`üìç Entered: ${e.name}`),window.dispatchEvent(new CustomEvent("zoneChange",{detail:{zoneId:e.id,zoneName:e.name,firstVisit:s}}))}onZoneExit(){console.log(`üìç Left zone: ${this.currentZone}`),this.currentZone=null,window.dispatchEvent(new CustomEvent("zoneChange",{detail:{zoneId:null}}))}teleportToZone(e){var s;if((s=this.activeEnvironment)!=null&&s.getZoneSpawnPoint&&this.player){const t=this.activeEnvironment.getZoneSpawnPoint(e);this.player.teleport(t)}}destroy(){var e,s,t;this.disposeCurrentEnvironment(),(e=this.player)==null||e.dispose(),(t=(s=this.environment)==null?void 0:s.dispose)==null||t.call(s),window.removeEventListener("toggleEnvironment",this._onToggle)}}class yi extends ut{constructor(e){super(),this.sources=e,this.items={},this.toLoad=this.sources.length,this.loaded=0,this.setLoaders(),this.startLoading()}setLoaders(){this.loaders={},this.loaders.textureLoader=new qt,this.loaders.cubeTextureLoader=new hn,this.loaders.gltfLoader=new es,this.loaders.dracoLoader=new ns,this.loaders.dracoLoader.setDecoderPath("/3JS-visual-portfolio/draco/"),this.loaders.gltfLoader.setDRACOLoader(this.loaders.dracoLoader)}startLoading(){if(this.toLoad===0){setTimeout(()=>{this.trigger("ready")},100);return}const e=document.getElementById("loading-bar-fill"),s=document.querySelector(".loading-text"),t=()=>{const o=this.loaded/this.toLoad*100;e&&(e.style.width=`${o}%`)},n=(o,a)=>{console.error(`‚ùå Failed to load ${o.type}: ${o.path}`,a),s&&(s.textContent=`Error loading ${o.name}...`),this.sourceLoaded(o,null),t()},i=(o,a)=>{if(a.lengthComputable&&s){const r=(a.loaded/1048576).toFixed(1);s.textContent=`Loading ${o.name}... ${r}MB`}};for(const o of this.sources)switch(o.type){case"gltfModel":this.loaders.gltfLoader.load(o.path,a=>{this.sourceLoaded(o,a),t()},a=>i(o,a),a=>n(o,a));break;case"texture":this.loaders.textureLoader.load(o.path,a=>{this.sourceLoaded(o,a),t()},void 0,a=>n(o,a));break;case"cubeTexture":this.loaders.cubeTextureLoader.load(o.path,a=>{this.sourceLoaded(o,a),t()},void 0,a=>n(o,a));break}}sourceLoaded(e,s){this.items[e.name]=s,this.loaded++,this.loaded===this.toLoad&&this.trigger("ready")}}class wi{constructor(){this.experience=new C,this.elements={btnTime:document.getElementById("btn-time"),btnAudio:document.getElementById("btn-audio"),btnSettings:document.getElementById("btn-settings"),timeControl:document.getElementById("time-control"),settingsPanel:document.getElementById("settings-panel"),timePresets:document.querySelectorAll(".time-preset"),qualitySlider:document.getElementById("quality-slider"),qualityValue:document.getElementById("quality-value"),volumeSlider:document.getElementById("volume-slider"),volumeValue:document.getElementById("volume-value"),toggleCycle:document.getElementById("toggle-cycle"),toggleFps:document.getElementById("toggle-fps"),portalUI:document.getElementById("portal-ui"),portalTitle:document.getElementById("portal-title"),portalDescription:document.getElementById("portal-description"),portalClose:document.getElementById("portal-close"),portalEnter:document.getElementById("portal-enter"),projectModal:document.getElementById("project-modal"),modalTitle:document.getElementById("modal-title"),modalClose:document.getElementById("modal-close"),projectIframe:document.getElementById("project-iframe"),perfStats:document.getElementById("perf-stats"),fpsCounter:document.getElementById("fps-counter"),notificationContainer:document.getElementById("notification-container")},this.currentPortalData=null,this._listeners=[],this.setupEventListeners(),this.setupPortalEvents(),this.setupEnvironmentToggle()}_listen(e,s,t,n){e&&(e.addEventListener(s,t,n),this._listeners.push({target:e,event:s,handler:t,options:n}))}setupEnvironmentToggle(){const e=document.getElementById("env-toggle"),s=document.getElementById("env-toggle-label");e&&(this._listen(e,"click",()=>{window.dispatchEvent(new CustomEvent("toggleEnvironment"))}),this._listen(window,"environmentChanged",t=>{const n=t.detail.mode;s&&(s.textContent=n==="test"?"üß™ Test":"üå≥ Forest"),e.setAttribute("data-mode",n)}))}setupEventListeners(){var e;this._listen(this.elements.btnTime,"click",()=>{this.togglePanel("timeControl")}),this._listen(this.elements.btnAudio,"click",()=>{this.toggleAudio()}),this._listen(this.elements.btnSettings,"click",()=>{this.togglePanel("settingsPanel")}),(e=this.elements.timePresets)==null||e.forEach(s=>{this._listen(s,"click",()=>{this.setTimePreset(s.dataset.preset),this.elements.timePresets.forEach(t=>t.classList.remove("active")),s.classList.add("active")})}),this._listen(this.elements.qualitySlider,"input",s=>{const t=["Low","Medium","High"],n=parseInt(s.target.value);this.elements.qualityValue.textContent=t[n],this.setQuality(n)}),this._listen(this.elements.volumeSlider,"input",s=>{const t=parseInt(s.target.value);this.elements.volumeValue.textContent=`${t}%`,this.setVolume(t/100)}),this._listen(this.elements.toggleCycle,"click",()=>{this.elements.toggleCycle.classList.toggle("active"),this.toggleDayNightCycle()}),this._listen(this.elements.toggleFps,"click",()=>{this.elements.toggleFps.classList.toggle("active"),this.toggleFpsDisplay()}),this._listen(this.elements.portalClose,"click",()=>{this.hidePortalUI()}),this._listen(this.elements.portalEnter,"click",()=>{this.enterPortal()}),this._listen(this.elements.modalClose,"click",()=>{this.closeProjectModal()}),this._listen(this.elements.projectModal,"click",s=>{s.target===this.elements.projectModal&&this.closeProjectModal()}),this._listen(document,"keydown",s=>{s.key==="Escape"&&(this.closeAllPanels(),this.closeProjectModal())})}setupPortalEvents(){this._listen(window,"portalEnter",e=>{this.showPortalUI(e.detail)}),this._listen(window,"portalExit",()=>{this.hidePortalUI()}),this._listen(window,"portalActivate",e=>{this.openProjectModal(e.detail)})}togglePanel(e){var t,n;const s=this.elements[e];s&&(e!=="timeControl"&&((t=this.elements.timeControl)==null||t.classList.remove("visible")),e!=="settingsPanel"&&((n=this.elements.settingsPanel)==null||n.classList.remove("visible")),s.classList.toggle("visible"))}closeAllPanels(){var e,s;(e=this.elements.timeControl)==null||e.classList.remove("visible"),(s=this.elements.settingsPanel)==null||s.classList.remove("visible"),this.hidePortalUI()}toggleAudio(){const e=this.experience.audioManager;if(e){const s=e.toggleMute();this.elements.btnAudio.textContent=s?"üîá":"üîä",this.elements.btnAudio.classList.toggle("active",!s)}else this.notify("Audio coming soon","info")}setTimePreset(e){var t;const s=(t=this.experience.world)==null?void 0:t.environment;s&&s.setPreset(e)}setQuality(e){const s=this.experience.renderer;if(s)switch(e){case 0:s.instance.setPixelRatio(1),this.experience.postProcessing&&(this.experience.postProcessing.bloomEffect.intensity=0);break;case 1:s.instance.setPixelRatio(Math.min(window.devicePixelRatio,1.5)),this.experience.postProcessing&&(this.experience.postProcessing.bloomEffect.intensity=.3);break;case 2:s.instance.setPixelRatio(Math.min(window.devicePixelRatio,2)),this.experience.postProcessing&&(this.experience.postProcessing.bloomEffect.intensity=.5);break}}setVolume(e){const s=this.experience.audioManager;s&&s.setMasterVolume(e),this.elements.volumeValue&&(this.elements.volumeValue.textContent=`${Math.round(e*100)}%`)}toggleDayNightCycle(){this.notify("Auto cycle coming soon")}toggleFpsDisplay(){var s;return(s=this.elements.perfStats)==null?void 0:s.classList.toggle("visible")}showPortalUI(e){var s;this.currentPortalData=e,this.elements.portalTitle&&(this.elements.portalTitle.textContent=e.title||"Portal"),this.elements.portalDescription&&(this.elements.portalDescription.textContent=e.description||""),(s=this.elements.portalUI)==null||s.classList.add("visible")}hidePortalUI(){var e;(e=this.elements.portalUI)==null||e.classList.remove("visible"),this.currentPortalData=null}enterPortal(){this.currentPortalData&&(window.dispatchEvent(new CustomEvent("portalActivate",{detail:this.currentPortalData.data})),this.openProjectModal(this.currentPortalData.data))}openProjectModal(e){var s;this.elements.modalTitle&&(this.elements.modalTitle.textContent=e.title||"Project"),this.elements.projectIframe&&e.url&&(this.elements.projectIframe.src=e.url),(s=this.elements.projectModal)==null||s.classList.add("active")}closeProjectModal(){var e;(e=this.elements.projectModal)==null||e.classList.remove("active"),this.elements.projectIframe&&(this.elements.projectIframe.src="about:blank")}notify(e,s="info",t=3e3){var i;const n=document.createElement("div");n.className=`notification ${s}`,n.textContent=e,(i=this.elements.notificationContainer)==null||i.appendChild(n),setTimeout(()=>{n.style.opacity="0",n.style.transform="translateY(-20px)",setTimeout(()=>n.remove(),300)},t)}updateFPS(e){this.elements.fpsCounter&&(this.elements.fpsCounter.textContent=Math.round(e))}destroy(){for(const{target:e,event:s,handler:t,options:n}of this._listeners)e.removeEventListener(s,t,n);this._listeners=[]}}class bi{constructor(){this.experience=new C,this.canvas=this.experience.canvas,this.isEnabled=!1,this.isTouchDevice=this.detectTouchDevice(),this.moveJoystick={active:!1,startX:0,startY:0,currentX:0,currentY:0,deltaX:0,deltaY:0,touchId:null},this.cameraJoystick={active:!1,startX:0,startY:0,currentX:0,currentY:0,deltaX:0,deltaY:0,touchId:null},this.jumpRequested=!1,this.settings={joystickRadius:60,deadzone:.1,sensitivity:1,cameraSensitivity:.003},this.uiElements={},this.isTouchDevice&&(this.createUI(),this.setupEventListeners(),this.enable())}detectTouchDevice(){return"ontouchstart"in window||navigator.maxTouchPoints>0||window.matchMedia("(pointer: coarse)").matches}createUI(){const e=document.createElement("div");e.id="touch-controls",e.innerHTML=`
      <style>
        #touch-controls {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          pointer-events: none;
          z-index: 100;
          display: none;
        }
        
        #touch-controls.enabled {
          display: block;
        }
        
        .joystick-zone {
          position: absolute;
          bottom: 20px;
          width: 150px;
          height: 150px;
          pointer-events: auto;
        }
        
        .joystick-zone.left {
          left: 20px;
        }
        
        .joystick-zone.right {
          right: 20px;
        }
        
        .joystick-base {
          position: absolute;
          width: 120px;
          height: 120px;
          background: rgba(255, 255, 255, 0.1);
          border: 2px solid rgba(255, 255, 255, 0.3);
          border-radius: 50%;
          left: 50%;
          top: 50%;
          transform: translate(-50%, -50%);
          backdrop-filter: blur(10px);
        }
        
        .joystick-stick {
          position: absolute;
          width: 50px;
          height: 50px;
          background: rgba(255, 255, 255, 0.4);
          border: 2px solid rgba(255, 255, 255, 0.6);
          border-radius: 50%;
          left: 50%;
          top: 50%;
          transform: translate(-50%, -50%);
          transition: transform 0.05s ease-out;
        }
        
        .jump-button {
          position: absolute;
          bottom: 180px;
          right: 50px;
          width: 70px;
          height: 70px;
          background: rgba(102, 126, 234, 0.3);
          border: 2px solid rgba(102, 126, 234, 0.6);
          border-radius: 50%;
          pointer-events: auto;
          display: flex;
          align-items: center;
          justify-content: center;
          color: rgba(255, 255, 255, 0.8);
          font-size: 24px;
          font-weight: bold;
          backdrop-filter: blur(10px);
          user-select: none;
          -webkit-user-select: none;
        }
        
        .jump-button:active {
          background: rgba(102, 126, 234, 0.6);
          transform: scale(0.95);
        }
        
        .action-button {
          position: absolute;
          bottom: 100px;
          right: 130px;
          width: 60px;
          height: 60px;
          background: rgba(118, 75, 162, 0.3);
          border: 2px solid rgba(118, 75, 162, 0.6);
          border-radius: 50%;
          pointer-events: auto;
          display: flex;
          align-items: center;
          justify-content: center;
          color: rgba(255, 255, 255, 0.8);
          font-size: 20px;
          backdrop-filter: blur(10px);
          user-select: none;
          -webkit-user-select: none;
        }
      </style>
      
      <div class="joystick-zone left" id="move-joystick-zone">
        <div class="joystick-base">
          <div class="joystick-stick" id="move-stick"></div>
        </div>
      </div>
      
      <div class="joystick-zone right" id="camera-joystick-zone">
        <div class="joystick-base">
          <div class="joystick-stick" id="camera-stick"></div>
        </div>
      </div>
      
      <div class="jump-button" id="jump-button">‚¨Ü</div>
      <div class="action-button" id="action-button">‚ú¶</div>
    `,document.body.appendChild(e),this.uiElements={container:e,moveZone:e.querySelector("#move-joystick-zone"),moveStick:e.querySelector("#move-stick"),cameraZone:e.querySelector("#camera-joystick-zone"),cameraStick:e.querySelector("#camera-stick"),jumpButton:e.querySelector("#jump-button"),actionButton:e.querySelector("#action-button")}}setupEventListeners(){this.uiElements.moveZone.addEventListener("touchstart",e=>this.onMoveStart(e),{passive:!1}),this.uiElements.moveZone.addEventListener("touchmove",e=>this.onMoveMove(e),{passive:!1}),this.uiElements.moveZone.addEventListener("touchend",e=>this.onMoveEnd(e)),this.uiElements.moveZone.addEventListener("touchcancel",e=>this.onMoveEnd(e)),this.uiElements.cameraZone.addEventListener("touchstart",e=>this.onCameraStart(e),{passive:!1}),this.uiElements.cameraZone.addEventListener("touchmove",e=>this.onCameraMove(e),{passive:!1}),this.uiElements.cameraZone.addEventListener("touchend",e=>this.onCameraEnd(e)),this.uiElements.cameraZone.addEventListener("touchcancel",e=>this.onCameraEnd(e)),this.uiElements.jumpButton.addEventListener("touchstart",e=>{e.preventDefault(),this.jumpRequested=!0}),this.uiElements.jumpButton.addEventListener("touchend",()=>{this.jumpRequested=!1}),this.uiElements.actionButton.addEventListener("touchstart",e=>{e.preventDefault(),window.dispatchEvent(new CustomEvent("touchAction"))})}onMoveStart(e){e.preventDefault();const s=e.changedTouches[0],t=this.uiElements.moveZone.getBoundingClientRect();this.moveJoystick.active=!0,this.moveJoystick.touchId=s.identifier,this.moveJoystick.startX=t.left+t.width/2,this.moveJoystick.startY=t.top+t.height/2,this.moveJoystick.currentX=s.clientX,this.moveJoystick.currentY=s.clientY,this.updateMoveStick()}onMoveMove(e){if(e.preventDefault(),!!this.moveJoystick.active){for(const s of e.changedTouches)if(s.identifier===this.moveJoystick.touchId){this.moveJoystick.currentX=s.clientX,this.moveJoystick.currentY=s.clientY,this.updateMoveStick();break}}}onMoveEnd(e){for(const s of e.changedTouches)if(s.identifier===this.moveJoystick.touchId){this.moveJoystick.active=!1,this.moveJoystick.deltaX=0,this.moveJoystick.deltaY=0,this.uiElements.moveStick.style.transform="translate(-50%, -50%)";break}}updateMoveStick(){let e=this.moveJoystick.currentX-this.moveJoystick.startX,s=this.moveJoystick.currentY-this.moveJoystick.startY;const t=Math.sqrt(e*e+s*s),n=this.settings.joystickRadius;t>n&&(e=e/t*n,s=s/t*n),this.moveJoystick.deltaX=e/n,this.moveJoystick.deltaY=s/n,Math.abs(this.moveJoystick.deltaX)<this.settings.deadzone&&(this.moveJoystick.deltaX=0),Math.abs(this.moveJoystick.deltaY)<this.settings.deadzone&&(this.moveJoystick.deltaY=0),this.uiElements.moveStick.style.transform=`translate(calc(-50% + ${e}px), calc(-50% + ${s}px))`}onCameraStart(e){e.preventDefault();const s=e.changedTouches[0];this.cameraJoystick.active=!0,this.cameraJoystick.touchId=s.identifier,this.cameraJoystick.startX=s.clientX,this.cameraJoystick.startY=s.clientY}onCameraMove(e){if(e.preventDefault(),!!this.cameraJoystick.active){for(const s of e.changedTouches)if(s.identifier===this.cameraJoystick.touchId){const t=s.clientX-this.cameraJoystick.startX,n=s.clientY-this.cameraJoystick.startY;this.cameraJoystick.deltaX=t*this.settings.cameraSensitivity,this.cameraJoystick.deltaY=n*this.settings.cameraSensitivity;const i=Math.max(-this.settings.joystickRadius,Math.min(this.settings.joystickRadius,t)),o=Math.max(-this.settings.joystickRadius,Math.min(this.settings.joystickRadius,n));this.uiElements.cameraStick.style.transform=`translate(calc(-50% + ${i}px), calc(-50% + ${o}px))`,this.cameraJoystick.startX=s.clientX,this.cameraJoystick.startY=s.clientY;break}}}onCameraEnd(e){for(const s of e.changedTouches)if(s.identifier===this.cameraJoystick.touchId){this.cameraJoystick.active=!1,this.cameraJoystick.deltaX=0,this.cameraJoystick.deltaY=0,this.uiElements.cameraStick.style.transform="translate(-50%, -50%)";break}}getInput(){return{moveX:this.moveJoystick.deltaX*this.settings.sensitivity,moveY:-this.moveJoystick.deltaY*this.settings.sensitivity,cameraX:this.cameraJoystick.deltaX,cameraY:this.cameraJoystick.deltaY,jump:this.jumpRequested}}enable(){this.isEnabled=!0,this.uiElements.container&&this.uiElements.container.classList.add("enabled")}disable(){this.isEnabled=!1,this.uiElements.container&&this.uiElements.container.classList.remove("enabled")}checkOrientation(){window.innerWidth<window.innerHeight&&this.enable()}destroy(){this.uiElements.container&&this.uiElements.container.remove()}}const xi=[];let Ce=null;class C{constructor(e={}){if(Ce)return Ce;if(Ce=this,this.canvas=e.canvas,!this.canvas)throw new Error("Canvas element not found!");if(!(this.canvas.getContext("webgl2")||this.canvas.getContext("webgl")))throw new Error("WebGL is not supported on this device/browser!");this.debug=window.location.hash==="#debug",this.fpsFrames=0,this.fpsTime=0,this.currentFPS=60,this._initComplete=!1;try{console.log("üì¶ Initializing core systems..."),this.sizes=new yn,this.time=new wn,this.scene=new dn,this.resources=new yi(xi),this.physics=new bn,this.camera=new En,this.renderer=new An,console.log("üåç Creating world..."),this.world=new gi,console.log("üé® Setting up UI..."),this.uiManager=new wi,this.touchControls=new bi,this.sizes.on("resize",()=>this.resize()),this.time.on("tick",()=>this.update()),this.resources.on("ready",()=>{this.onReady()}),this._initComplete=!0,console.log("‚úÖ Experience initialization complete ‚Äî scene objects:",this.scene.children.length)}catch(t){throw console.error("‚ùå Experience initialization error:",t),t}finally{this.hideLoadingScreen()}this.autoHideControls()}onReady(){this.hideLoadingScreen()}resize(){this.camera.resize(),this.renderer.resize()}update(){const e=this.time.delta/1e3;if(this.physics.update(),this.world.update(e),this.world.player&&this.camera.thirdPerson&&(this.camera.thirdPerson.follow(this.world.player.mesh,e),this.scene.fog)){const s=this.camera.thirdPerson.settings.distance;s>30&&(this.scene.fog.near=s*.5,this.scene.fog.far=s*3)}this.renderer.update(),this.updateFPS()}updateFPS(){var e;this.fpsFrames++,this.fpsTime+=this.time.delta,this.fpsTime>=1e3&&(this.currentFPS=this.fpsFrames,this.fpsFrames=0,this.fpsTime=0,(e=this.uiManager)==null||e.updateFPS(this.currentFPS))}autoHideControls(){const e=document.getElementById("instructions");e&&(e.classList.add("visible"),setTimeout(()=>{e.classList.add("hiding"),e.classList.remove("visible")},5e3))}hideLoadingScreen(){if(this._loadingHidden)return;this._loadingHidden=!0;const e=document.getElementById("loading-screen");e&&(e.style.opacity="0",e.style.pointerEvents="none",setTimeout(()=>{e.style.display="none"},600))}destroy(){var e,s,t,n,i,o;this.sizes.off("resize"),this.time.off("tick"),this.scene.traverse(a=>{if(a instanceof b){a.geometry.dispose();for(const r in a.material){const c=a.material[r];c&&typeof c.dispose=="function"&&c.dispose()}}}),(e=this.uiManager)==null||e.destroy(),(s=this.world)==null||s.destroy(),(t=this.camera)==null||t.destroy(),(n=this.time)==null||n.destroy(),(i=this.sizes)==null||i.destroy(),(o=this.touchControls)==null||o.destroy(),this.renderer.instance.dispose(),Ce=null}}function He(p){let e=document.getElementById("_err_overlay");e||(e=document.createElement("pre"),e.id="_err_overlay",e.style.cssText="position:fixed;top:10px;left:10px;z-index:99999;background:rgba(200,0,0,0.9);color:white;padding:12px 16px;font-size:12px;max-width:80vw;max-height:50vh;overflow:auto;word-wrap:break-word;border-radius:8px;font-family:monospace;",document.body.appendChild(e)),e.textContent+=p+`
`}function Ee(){const p=document.getElementById("loading-screen");p&&(p.style.transition="opacity 0.3s",p.style.opacity="0",p.style.pointerEvents="none",setTimeout(()=>{p.style.display="none"},300))}window.addEventListener("error",p=>{const e=`‚ùå ${p.message}
   ${p.filename}:${p.lineno}`;console.error(e),He(e),Ee()});window.addEventListener("unhandledrejection",p=>{const e=`‚ùå Unhandled rejection: ${p.reason}`;console.error(e),He(e),Ee()});setTimeout(()=>{const p=document.getElementById("loading-screen");p&&p.style.display!=="none"&&(console.warn("‚ö†Ô∏è Failsafe: forcing loading screen hide after timeout"),Ee())},8e3);document.addEventListener("DOMContentLoaded",()=>{console.log("üöÄ DOMContentLoaded - starting Experience...");try{const p=document.getElementById("webgl");if(!p){He("‚ùå Canvas element #webgl not found in DOM!"),Ee();return}console.log("üì¶ Creating Experience instance...");const e=new C({canvas:p});console.log("‚úÖ Experience created successfully")}catch(p){console.error("‚ùå Experience init failed:",p),He("‚ùå Experience init failed: "+p.message+`
`+p.stack),Ee()}});
